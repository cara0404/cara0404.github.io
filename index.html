<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›¾å·å¼‚é—»å½•ï¼š404å·äº‹åŠ¡æ‰€</title>
    
    <!-- å…¨å±€å­—ä½“ï¼šFusion Pixel -->
    <link href="https://fontsapi.zeoseven.com/570/main/result.css" onload="this.rel='stylesheet'" rel="preload" as="style" crossorigin />
    <noscript><link rel="stylesheet" href="https://fontsapi.zeoseven.com/570/main/result.css" /></noscript>

    <!-- å¼€åœºç™½å­—ä½“ï¼šMaoken Glitch Serif -->
    <link href="https://fontsapi.zeoseven.com/831/main/result.css" onload="this.rel='stylesheet'" rel="preload" as="style" crossorigin />
    <noscript><link rel="stylesheet" href="https://fontsapi.zeoseven.com/831/main/result.css" /></noscript>

    <style>
        /* === 1-bit åƒç´ ææ€–é£æ ¼å®šä¹‰ === */
        :root {
            --bg: #050505;
            --fg: #e0e0e0;
            --dim: #666666;
            --accent-red: #ff3333;
            --accent-glitch: #0ff;
            --accent-gold: #ffd700;
            --border: 2px solid var(--fg);
            
            /* å­—ä½“å˜é‡å®šä¹‰ */
            --font-pixel: "Fusion Pixel 12px M latin", monospace;
            --font-intro: "Maoken Glitch Serif", serif;
            --font-read: "Fusion Pixel 12px M latin", serif; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--fg);
            /* ä¿®æ”¹ï¼šå…¨å±€åº”ç”¨ Fusion Pixel */
            font-family: "Fusion Pixel 12px M latin";
            font-weight: normal;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-size: 18px;
        }


        /* æ‰«æçº¿ä¸å™ªç‚¹ */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px; pointer-events: none; z-index: 9998; opacity: 0.3;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 9999; opacity: 0.4;
        }

        /* === é€šç”¨ç»„ä»¶ === */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
            padding: 20px; z-index: 10;
            background: var(--bg);
            opacity: 0; transition: opacity 0.5s ease;
        }
        .screen.active { display: flex; opacity: 1; }

        h1, h2 { text-transform: uppercase; letter-spacing: 2px; text-align: center; margin: 0 0 20px 0; font-weight: normal; }
        
        .pixel-btn {
            background: transparent; color: var(--fg);
            border: var(--border);
            padding: 10px 15px; margin: 5px 0;
            font-family: var(--font-pixel);
            font-size: 1.2rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 0 5px rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
        }
        .pixel-btn:active { transform: scale(0.98); }
        .pixel-btn:disabled { border-color: var(--dim); color: var(--dim); cursor: not-allowed; }
        .pixel-btn:hover:not(:disabled) { background: var(--fg); color: var(--bg); box-shadow: 0 0 15px var(--fg); }

        .pixel-input {
            width: 100%; background: rgba(255,255,255,0.05); color: var(--fg);
            border: 1px solid var(--dim); padding: 12px;
            font-family: var(--font-read); font-size: 1rem; margin-bottom: 15px;
            border-radius: 0; outline: none;
        }
        .pixel-input:focus { border-color: var(--accent-glitch); box-shadow: 0 0 8px rgba(0,255,255,0.2); }

        /* === 0. å¼€åœºåŠ¨ç”»å±‚ === */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 2rem; cursor: pointer;
        }
        .intro-text {
            /* ä¿®æ”¹ï¼šå¼€åœºç™½åº”ç”¨ Maoken Glitch Serif */
            font-family: "Maoken Glitch Serif"; 
            font-size: 1.8rem; line-height: 1.6;
            max-width: 800px; text-align: left; opacity: 0;
            transform: translateY(20px); transition: all 0.8s ease-out;
            white-space: pre-wrap; text-shadow: 0 0 5px rgba(255,255,255,0.3);
        }
        .intro-text.show { opacity: 1; transform: translateY(0); }
        .highlight-scary { color: var(--accent-red); font-weight: bold; display: inline-block; animation: shake 3s infinite; }
        .highlight-neon { color: #fff; text-shadow: 0 0 10px var(--accent-glitch), 0 0 20px var(--accent-glitch); }
        .intro-hint { position: absolute; bottom: 30px; font-size: 1rem; color: var(--dim); animation: blink 1.5s infinite; }

        /* === 1. æ ‡é¢˜ç”»é¢ === */
        #title-screen { justify-content: center; align-items: center; }
        .logo-box {
            border: 4px double var(--fg); padding: 30px; margin-bottom: 50px;
            text-align: center; position: relative;
            background: rgba(0,0,0,0.8);
        }
        .logo-text { font-size: 3.5rem; letter-spacing: 5px; text-shadow: 2px 2px 0 #333; position: relative; }
        .logo-text::after {
            content: "é›¾å·å¼‚é—»å½•"; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.5; color: var(--accent-glitch); z-index: -1; animation: glitch-anim 2.5s infinite;
        }

        /* === 2. è®¾ç½®å¼¹çª— === */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 30000;
            display: none; flex-direction: column; padding: 20px; justify-content: center;
        }
        .status-msg { font-size: 0.9rem; margin-top: 10px; min-height: 1.2em; font-family: var(--font-pixel); }
        .success { color: #0f0; } .error { color: #f00; }

        /* === 3. è§’è‰²åˆ›å»º & æ¡£æ¡ˆç”Ÿæˆ === */
        #char-screen { justify-content: center; }
        .form-container { max-width: 500px; margin: 0 auto; width: 100%; }
        label { display: block; margin-bottom: 5px; color: var(--dim); font-size: 0.9rem; }
        
        /* æ¡£æ¡ˆå¡ç‰‡æ ·å¼ */
        #persona-screen { 
            justify-content: center; 
            align-items: center; 
            overflow-y: auto; /* å¢åŠ æ»šåŠ¨ï¼Œé˜²æ­¢å¡ç‰‡å¤ªé•¿è¶…å‡ºå±å¹• */
            padding: 40px 20px; 
        }
        .dossier-card {
            border: 2px solid var(--fg); 
            padding: 35px; /* å†…è¾¹è·åŠ å¤§ï¼Œå‘¼å¸æ„Ÿæ›´å¼º */
            width: 100%; 
            max-width: 700px; /* å®½åº¦åŠ å¤§ï¼Œè®©é˜…è¯»æ›´èˆ’é€‚ */
            background: rgba(10,10,10,0.98); /* èƒŒæ™¯æ›´æ·±ä¸€ç‚¹ */
            position: relative;
            box-shadow: 0 0 40px rgba(255,255,255,0.1); /* é˜´å½±åŠ é‡ */
            display: none;
            margin: auto;
        }
        .dossier-header { 
            border-bottom: 3px solid var(--fg); /* çº¿æ¡åŠ ç²— */
            padding-bottom: 15px; 
            margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .dossier-title { 
            font-size: 2.2rem; /* æ ‡é¢˜æ˜¾è‘—åŠ å¤§ */
            font-weight: bold; 
            background: var(--fg); 
            color: var(--bg); 
            padding: 5px 15px; 
            letter-spacing: 2px;
        }
        .dossier-body { 
            font-family: var(--font-pixel); /* ç»Ÿä¸€ç”¨åƒç´ å­—ä½“ï¼Œæ¸…æ™°åº¦æ›´é«˜ */
            line-height: 1.9; /* è¡Œé«˜åŠ å¤§ï¼Œé˜²æ­¢æ–‡å­—æŒ¤åœ¨ä¸€èµ· */
            font-size: 1.4rem; /* æ­£æ–‡æ˜¾è‘—åŠ å¤§ï¼ */
            margin-bottom: 35px; 
            text-align: justify; /* ä¸¤ç«¯å¯¹é½ */
            color: #eee;
        }
        
        /* å±æ€§ç½‘æ ¼ */
        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; /* é—´è·åŠ å¤§ */
            border-top: 2px dashed var(--dim); padding-top: 25px;
        }
        .stat-item { 
            display: flex; justify-content: space-between; align-items: center; 
            font-family: var(--font-pixel); 
            font-size: 1.5rem; /* å±æ€§æ–‡å­—åŠ å¤§ */
        }
        .stat-label { color: var(--dim); }
        .stat-value { color: var(--accent-glitch); font-weight: bold; font-size: 1.6rem; }
        .stat-mys { color: #a0f; text-shadow: 0 0 8px #a0f; }

        .loading-text { font-size: 1.5rem; animation: blink 0.5s infinite; text-align: center; }

        /* === 4. æ¸¸æˆä¸»ç•Œé¢ (AVG) === */
        #game-screen { padding: 0; }
        .top-bar {
            height: 70px; border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; font-size: 1.1rem; background: #000;
            z-index: 30; /* é¡¶æ å±‚çº§æœ€é«˜ */
            position: relative;
        }
        .bar-left { display: flex; flex-direction: column; justify-content: center; }
        .time-box { font-size: 1.2rem; color: var(--accent-gold); display: flex; align-items: center; gap: 5px; }
        .hp-san-box { display: flex; gap: 10px; font-family: var(--font-pixel); font-size: 0.9rem; color: var(--dim); }
        .val-label { color: var(--fg); font-weight: bold; }
        .money-label { color: var(--accent-glitch); margin-left: 10px; }
        
        .menu-btn {
            background: none; border: 1px solid var(--dim); color: var(--fg);
            cursor: pointer; font-family: var(--font-pixel); padding: 5px 8px;
            font-size: 1rem; text-transform: uppercase;
        }
        .menu-btn:hover { border-color: var(--fg); color: var(--accent-glitch); }

        .visual-area {
            flex: 1; 
            /* ä¿®æ”¹ï¼šä¸å†å¼ºåˆ¶å±…ä¸­ï¼Œæ”¹ä¸ºç›¸å¯¹å®šä½å¸ƒå±€ */
            display: block; 
            border-bottom: var(--border); 
            background: #111; 
            position: relative; 
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }
        /* å›¾ç‰‡é®ç½© */
        .visual-area::before {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); /* è°ƒä½ä¸€ç‚¹é€æ˜åº¦ï¼Œè®©å›¾æ›´äº®ä¸€ç‚¹ */
            z-index: 1;
        }
        
        /* ä¿®æ”¹ï¼šåœ°ç‚¹æ ‡é¢˜æ”¹ä¸ºå·¦ä¸Šè§’æ‚¬æµ®æ ‡ç­¾ */
        .scene-title { 
            z-index: 5; 
            position: absolute; 
            top: 15px; 
            left: 15px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid var(--dim);
            padding: 5px 15px;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--accent-glitch);
            box-shadow: 2px 2px 0 #000;
        }

        /* äº‹åŠ¡æ‰€ä¸“ç”¨UI */
        .office-hud {
            position: absolute; bottom: 15px; right: 15px;
            display: none; gap: 10px;
            z-index: 5; /* ä¿è¯åœ¨é®ç½©ä¹‹ä¸Š */
        }
        .office-hud.active { display: flex; }

        .dialogue-box {
            height: 40%; min-height: 250px; 
            padding: 40px; /* å†…è¾¹è·åŠ å¤§ï¼Œæ–‡å­—ä¸è´´è¾¹ */
            display: flex; flex-direction: column; position: relative; cursor: pointer;
            background: #000;
            z-index: 20; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
        }
        .speaker-name {
            position: absolute; 
            top: -24px; /* é…åˆå¤§å­—å·ï¼Œä½ç½®ä¸Šç§» */
            left: 30px;
            background: var(--bg); border: var(--border);
            padding: 5px 20px; /* åå­—æ¡†åŠ å®½ */
            font-weight: bold; 
            font-size: 1.4rem; /* åå­—åŠ å¤§ */
            z-index: 25; 
            letter-spacing: 2px; /* åå­—å­—é—´è·æ‹‰å¼€ï¼Œæ›´æœ‰æ°”åŠ¿ */
        }
        .text-content { 
            font-family: var(--font-read); 
            font-size: 1.6rem; /* === æ ¸å¿ƒä¿®æ”¹ï¼šæ­£æ–‡æ˜¾è‘—åŠ å¤§ï¼ === */
            line-height: 1.6; /* è¡Œé«˜é€‚é…å¤§å­—å· */
            flex: 1; 
            letter-spacing: 1px; /* å¢åŠ å­—é—´è·ï¼Œé˜²æ­¢åƒç´ å­—ç²˜è¿ */
            color: #eee; /* å­—ä½“é¢œè‰²æäº® */
            text-shadow: 2px 2px 0 #000; /* åŠ ä¸€ç‚¹é˜´å½±ï¼Œè®©å­—æ›´ç«‹ä½“ */
        }
        .click-indicator { text-align: right; animation: blink 1s infinite; font-size: 1.5rem; margin-top: 10px; visibility: hidden; color: var(--accent-glitch); }
        .click-indicator.show { visibility: visible; }

        .choices-overlay {
            position: absolute; 
            top: 45%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 90%; 
            max-width: 500px; 
            bottom: auto !important; 
            background: rgba(0,0,0,0.98); 
            padding: 25px;
            border: var(--border); 
            display: none; 
            flex-direction: column; 
            gap: 12px;
            z-index: 100; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8); 
        }

        .choices-overlay.active { display: flex; }

        /* === 5. è¦†ç›–å±‚ (çŠ¶æ€/ç‰©å“/åœ°å›¾) === */
        .overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; padding: 20px;
        }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--fg); padding-bottom: 10px; }
        .overlay-content { flex: 1; overflow-y: auto; padding-right: 5px; }
        
        /* ç‰©å“æ æ ·å¼ */
        .inventory-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .item-card { 
            border: 1px solid var(--dim); padding: 10px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.05);
        }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.1rem; color: var(--accent-glitch); }
        .item-desc { font-size: 0.9rem; color: #aaa; font-family: var(--font-read); margin-top: 5px; }
        .item-count { font-size: 0.9rem; color: var(--dim); margin-left: 5px; }
        .item-actions { margin-left: 10px; }
        
        .insane-item .item-name { color: var(--accent-red); animation: shake 2s infinite; }
        .insane-item .item-desc { color: #844; font-style: italic; letter-spacing: 1px; }
        .key-item { border-color: #a0f; }
        .key-item .item-name { color: #a0f; }

        /* åœ°å›¾æ ·å¼ */
        .map-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .map-node {
            border: 2px solid var(--dim); padding: 15px; text-align: center; cursor: pointer;
            transition: all 0.3s; opacity: 0.7; position: relative;
        }
        .map-node:hover { border-color: var(--fg); opacity: 1; background: rgba(255,255,255,0.1); }
        .map-node.current { border-color: var(--accent-glitch); box-shadow: 0 0 10px var(--accent-glitch); opacity: 1; }
        .map-node.locked { border-style: dashed; opacity: 0.3; cursor: not-allowed; }
        .map-tag { 
            position: absolute; top: -10px; right: -5px; background: #000; border: 1px solid var(--fg); 
            font-size: 0.8rem; padding: 2px 5px; color: var(--accent-gold);
        }

        /* æ‰‹æœºç•Œé¢æ ·å¼ (ç¾åŒ–ç‰ˆ) */
        .app-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
            padding: 20px 10px;
            transition: opacity 0.3s;
        }
        .app-grid.hidden { display: none; opacity: 0; }

        .app-icon {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .app-icon:hover { transform: scale(1.1); }
        .app-symbol {
            width: 55px; height: 55px; border: 2px solid var(--fg); border-radius: 14px;
            display: flex; justify-content: center; align-items: center; font-size: 1.8rem;
            margin-bottom: 8px; background: rgba(255,255,255,0.05);
            box-shadow: 0 4px 0 var(--dim); /* åƒç´ ç«‹ä½“æ„Ÿ */
        }
        .app-icon:active .app-symbol { transform: translateY(4px); box-shadow: none; }
        .app-icon:hover .app-symbol { border-color: var(--accent-glitch); color: var(--accent-glitch); }
        .app-name { font-size: 0.8rem; color: var(--dim); font-family: var(--font-pixel); letter-spacing: 1px; }

        /* æ‰‹æœºåº”ç”¨å†…å®¹å®¹å™¨ */
        #phone-display-area {
            display: none; flex-direction: column; height: 100%;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .app-header {
            display: flex; align-items: center; border-bottom: 1px solid var(--dim);
            padding-bottom: 10px; margin-bottom: 15px;
        }
        .back-btn {
            background: none; border: none; color: var(--accent-glitch); font-family: var(--font-pixel);
            font-size: 1.2rem; cursor: pointer; margin-right: 15px; padding: 0 5px;
        }
        .back-btn:hover { text-decoration: underline; }
        .app-title { font-size: 1.2rem; font-weight: bold; letter-spacing: 2px; }

        /* === APP ç‰¹å®šæ ·å¼æ¨¡æ¿ (å¤§å­—å·èˆ’é€‚ç‰ˆ) === */
        
        /* 1. çŸ­ä¿¡é£æ ¼ */
        .sms-container { display: flex; flex-direction: column; gap: 20px; } /* é—´è·åŠ å¤§ */
        .sms-card {
            border: 1px solid var(--dim); background: rgba(0,0,0,0.6);
            padding: 20px; /* å†…è¾¹è·åŠ å¤§ */
            position: relative;
            border-left: 4px solid var(--fg);
        }
        .sms-card.urgent { border-color: var(--accent-red); border-left-width: 6px; background: rgba(50,0,0,0.15); }
        .sms-sender { font-size: 1.1rem; /* å­—ä½“åŠ å¤§ */ color: var(--accent-glitch); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .sms-time { color: var(--dim); font-size: 0.9rem; }
        .sms-body { font-family: var(--font-read); font-size: 1.25rem; /* æ­£æ–‡åŠ å¤§ */ line-height: 1.6; color: #ddd; }

        /* 2. æ–°é—»é£æ ¼ */
        .news-card {
            border: 2px double var(--fg); padding: 25px; /* å†…è¾¹è·åŠ å¤§ */ background: #111;
            text-align: justify;
        }
        .news-headline { 
            font-size: 1.6rem; /* æ ‡é¢˜åŠ å¤§ */ font-weight: bold; border-bottom: 1px solid var(--fg); 
            padding-bottom: 12px; margin-bottom: 15px; color: var(--accent-gold);
        }
        .news-body { font-family: var(--font-read); font-size: 1.2rem; /* æ­£æ–‡åŠ å¤§ */ line-height: 1.8; color: #ccc; }

        /* 3. å¤–å–å°ç¥¨é£æ ¼ (ä¿æŒå¤§å°ºå¯¸) */
        .receipt-card {
            background: #fff; color: #000; 
            padding: 35px; 
            font-family: 'Courier New', monospace; width: 100%; 
            max-width: 450px; 
            margin: 20px auto;
            box-shadow: 0 0 25px rgba(255,255,255,0.15); 
            transform: rotate(-1deg);
            font-size: 1.15rem; 
            line-height: 1.5;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1.1rem; } /* æ¡ç›®åŠ å¤§ */
        .receipt-total { border-top: 2px solid #000; margin-top: 15px; padding-top: 10px; text-align: right; font-weight: bold; font-size: 1.4rem; } /* æ€»ä»·åŠ å¤§ */
        .receipt-footer { text-align: center; margin-top: 20px; font-size: 0.9rem; color: #555; }

        /* 4. æ ‘æ´é£æ ¼ */
        .sns-post {
            border-bottom: 1px solid #333; padding: 20px 0; /* é—´è·åŠ å¤§ */
        }
        .sns-user { font-weight: bold; color: #aaa; font-size: 1.1rem; /* ç”¨æˆ·ååŠ å¤§ */ margin-bottom: 8px; }
        .sns-content { font-family: var(--font-read); font-size: 1.25rem; /* å†…å®¹åŠ å¤§ */ color: var(--fg); line-height: 1.6; }
        .sns-actions { margin-top: 12px; font-size: 0.95rem; color: var(--dim); display: flex; gap: 20px; }


        /* çŠ¶æ€é¢æ¿ç‰¹æœ‰æ ·å¼ */
        .status-full-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .attr-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; }
        .attr-name { color: var(--fg); }
        .attr-desc { font-size: 0.8rem; color: var(--dim); margin-left: 10px; }
        .attr-val { color: var(--accent-glitch); font-size: 1.4rem; font-family: var(--font-pixel); }
        
        .status-bio {
            margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed var(--dim);
        }
        .bio-text { font-size: 1rem; color: #aaa; margin-top: 10px; font-style: italic; }

        /* === åŠ¨ç”» === */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes shake { 0% { transform: translate(0, 0); } 2% { transform: translate(-1px, 1px); } 4% { transform: translate(1px, -1px); } 6% { transform: translate(0, 0); } 100% { transform: translate(0, 0); } }
        @keyframes glitch-anim { 0% { clip-path: inset(10% 0 80% 0); transform: translate(-2px, 1px); } 5% { clip-path: inset(80% 0 10% 0); transform: translate(2px, -1px); } 10% { clip-path: inset(40% 0 50% 0); transform: translate(-1px, 2px); } 15% { clip-path: inset(90% 0 5% 0); transform: translate(1px, -2px); } 20% { clip-path: inset(100% 0 0 0); transform: translate(0, 0); } 100% { clip-path: inset(100% 0 0 0); transform: translate(0, 0); } }
        .glitch-text { animation: glitch 0.3s infinite; }
        @keyframes glitch { 0% { transform: translate(0) } 20% { transform: translate(-2px, 2px) } 40% { transform: translate(-2px, -2px) } 60% { transform: translate(2px, 2px) } 80% { transform: translate(2px, -2px) } 100% { transform: translate(0) } }

    </style>
</head>
<body>

    <div class="scanlines"></div>

    <!-- 0. å¼€åœºåŠ¨ç”»å±‚ -->
    <div id="intro-layer" onclick="nextSlide()">
        <div id="intro-content" class="intro-text"></div>
        <div class="intro-hint">[ ç‚¹å‡»å±å¹• ç»§ç»­ ]</div>
    </div>

    <!-- 1. æ ‡é¢˜ç”»é¢ -->
    <div id="title-screen" class="screen">
        <div class="logo-box">
            <div class="logo-text">é›¾å·å¼‚é—»å½•</div>
            <div style="font-size: 1.2rem; margin-top: 10px; letter-spacing: 3px; color: var(--dim);">AGENCY 404</div>
        </div>
        
        <div style="width: 100%; max-width: 350px;">
            <!-- æ–°å¢ï¼šè¯»å–å­˜æ¡£æŒ‰é’® -->
            <button class="pixel-btn" id="btn-continue" onclick="loadGame()" style="width: 100%; display: none; border-color: var(--accent-gold); color: var(--accent-gold); margin-bottom: 15px;">ğŸ“‚ è¯»å–å­˜æ¡£ (CONTINUE)</button>
            
            <button class="pixel-btn" onclick="openSettings()" style="width: 100%">ç³»ç»Ÿè®¾ç½® / API</button>
            <button class="pixel-btn" id="btn-enter-town" onclick="goToCharCreation()" disabled style="width: 100%">è¿›å…¥å…¬å¯“ (NEW GAME)</button>
            <div id="api-status-indicator" style="text-align: center; font-size: 0.9rem; color: var(--dim); margin-top: 10px;">[ âš ï¸ ç¥ç»è¿æ¥æœªå°±ç»ª ]</div>
        </div>
    </div>


    <!-- 2. è®¾ç½®/API ç•Œé¢ -->
    <div id="settings-modal">
        <h2>/// ç¥ç»è¿æ¥è®¾ç½® ///</h2>
        <div style="max-width: 500px; width: 100%; margin: 0 auto;">
            <!-- æ–°å¢ï¼šå­˜æ¡£ç®¡ç†åŒºåŸŸ -->
            <div style="border: 1px dashed var(--dim); padding: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.05);">
                <div style="color: var(--accent-gold); margin-bottom: 10px;">[ è®°å¿†æ•°æ®ç®¡ç† ]</div>
                <div style="display: flex; gap: 10px;">
                    <button class="pixel-btn" onclick="saveGame()" style="flex: 1;">ğŸ’¾ ä¿å­˜å½“å‰è¿›åº¦</button>
                    <button class="pixel-btn" onclick="deleteSave()" style="flex: 1; border-color: var(--accent-red); color: var(--accent-red);">ğŸ—‘ï¸ åˆ é™¤å­˜æ¡£</button>
                </div>
            </div>

            <label>API Base URL</label>
            <input type="text" class="pixel-input" id="api-url" value="https://api.openai.com/v1">
            <label>API Key</label>
            <input type="password" class="pixel-input" id="api-key" placeholder="sk-...">
            <label>Model</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" class="pixel-input" id="api-model" value="gpt-3.5-turbo" placeholder="æ¨¡å‹åç§°">
                <button class="pixel-btn" onclick="fetchModels()" style="width: 100px; margin: 0 0 15px 0; font-size: 1rem;">åˆ—è¡¨</button>
            </div>
            <button class="pixel-btn" onclick="testConnection()" style="width: 100%">âš¡ æµ‹è¯•è¿æ¥ä¿¡å·</button>
            <div id="test-msg" class="status-msg"></div>
            <div style="margin-top: 30px; display: flex; gap: 20px;">
                <button class="pixel-btn" onclick="closeSettings()" style="flex: 1">è¿”å›</button>
                <button class="pixel-btn" onclick="saveSettings()" style="flex: 1; border-color: var(--accent-glitch); color: var(--accent-glitch);">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- 3. è§’è‰²åˆ›å»º -->
    <div id="char-screen" class="screen">
        <h2>/// ç™»è®°å…¥ä½ ///</h2>
        <div class="form-container">
            <div style="text-align: right; margin-bottom: 10px;">
                <button class="pixel-btn" onclick="randomizeInputs()" style="font-size: 0.9rem; padding: 5px 10px; border-color: var(--accent-gold); color: var(--accent-gold);">ğŸ² éšæœºç”Ÿæˆæ¡£æ¡ˆ</button>
            </div>
            <label>å§“å / ä»£å·</label>
            <input type="text" class="pixel-input" id="char-name" placeholder="ä½ çš„åå­—">
            <label>å‰èŒ (å½±å“åˆå§‹å±æ€§)</label>
            <input type="text" class="pixel-input" id="char-job" placeholder="ä¾‹: ç§å®¶ä¾¦æ¢, åŒ»ç”Ÿ, ç¨‹åºå‘˜...">
            <label>é¢å¤–ç‰¹è´¨ / ç§˜å¯† (å¯é€‰)</label>
            <input type="text" class="pixel-input" id="char-extra" placeholder="ä¾‹: æ€•é»‘, é˜´é˜³çœ¼, æ¬ äº†å·¨æ¬¾...">
            <button class="pixel-btn" onclick="generatePersona()" style="margin-top: 30px; width: 100%">æäº¤æ¡£æ¡ˆ & ç”Ÿæˆäººè®¾</button>
        </div>
    </div>

    <!-- 3.5 æ¡£æ¡ˆç”Ÿæˆå±•ç¤ºé¡µ -->
    <div id="persona-screen" class="screen">
        <div id="persona-loading" class="loading-text">
            æ­£åœ¨æ£€ç´¢æ¡£æ¡ˆåº“...<br>
            <span style="font-size: 1rem; color: var(--dim)">ANALYZING SOUL DATA...</span>
        </div>

        <div id="persona-result" class="dossier-card">
            <div class="dossier-header">
                <div class="dossier-title">INVESTIGATOR</div>
                <div style="text-align: right;">
                    <div id="dossier-name">NAME: ???</div>
                    <div id="dossier-job" style="color: var(--dim)">JOB: ???</div>
                </div>
            </div>
            
            <div class="dossier-body" id="dossier-desc"></div>

            <div class="stat-grid">
                <div class="stat-item"><span class="stat-label">PHY ä½“é­„</span> <span id="p-phy" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">DEX çµå·§</span> <span id="p-dex" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">INT å­¦è¯†</span> <span id="p-int" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">CHA é­…åŠ›</span> <span id="p-cha" class="stat-value">0</span></div>
                <div class="stat-item" style="grid-column: span 2; border-top: 1px solid #333; margin-top: 5px; padding-top: 5px;">
                    <span class="stat-label" style="color: #a0f;">MYS çµè§† (æ ¸å¿ƒ)</span> 
                    <span id="p-mys" class="stat-value stat-mys">0</span>
                </div>
                <div class="stat-item"><span class="stat-label">HP ç”Ÿå‘½</span> <span id="p-hp" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">SAN ç†æ™º</span> <span id="p-san" class="stat-value">0</span></div>
            </div>

            <button class="pixel-btn" onclick="realStartGame()" style="width: 100%; margin-top: 20px; border-color: var(--accent-red);">ç¡®è®¤æ¡£æ¡ˆ & å…¥ä½</button>
        </div>
    </div>

    <!-- 4. æ¸¸æˆä¸»ç•Œé¢ (AVG) -->
    <div id="game-screen" class="screen">
        <div class="top-bar">
            <div class="bar-left">
                <div class="time-box">
                    <span id="day-num">DAY 1</span>
                    <span id="time-icon">â˜€ï¸</span>
                    <span id="time-text" style="font-size: 0.9rem; color: var(--dim)">ä¸Šåˆ</span>
                </div>
                <div class="hp-san-box">
                    <span>HP <span id="val-hp" class="val-label">100</span></span>
                    <span>SAN <span id="val-san" class="val-label">60</span></span>
                    <span class="money-label">Â¥ <span id="val-money">2000</span></span>
                </div>
            </div>
            <div style="display: flex; gap: 5px;">
                <button class="menu-btn" onclick="showNote()">ğŸ““ NOTE</button>
                <button class="menu-btn" onclick="showPhone()">ğŸ“± PHONE</button>
                <button class="menu-btn" onclick="showMap()">MAP</button>
                <button class="menu-btn" onclick="showInventory()">BAG</button>
                <button class="menu-btn" onclick="showStatus()">STAT</button>
                <button class="menu-btn" onclick="showLog()">LOG</button>
                <button class="menu-btn" onclick="openSettings()" style="border-color: var(--dim);">âš™ï¸</button>
            </div>
        </div>

        <div class="visual-area" id="visual-area">
            <div class="scene-title" id="scene-title">404å·äº‹åŠ¡æ‰€</div>
            <!-- äº‹åŠ¡æ‰€ä¸“ç”¨æŒ‰é’® -->
            <div id="office-hud" class="office-hud">
                <button class="pixel-btn" onclick="handleOfficeAction('computer')">ğŸ’» ç”µè„‘ç»ˆç«¯</button>
                <button class="pixel-btn" onclick="handleOfficeAction('sleep')">ğŸ›ï¸ ç¡è§‰ (ç»“ç®—)</button>
            </div>
        </div>

        <div class="dialogue-box" onclick="nextText()">
            <div class="speaker-name" id="speaker-name">???</div>
            <div class="text-content" id="main-text"></div>
            <div class="click-indicator" id="click-arrow">â–¼</div>
        </div>

        <!-- è‡ªç”±è¡ŒåŠ¨è¾“å…¥æ  -->
        <div id="free-action-bar" style="
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: #000; border-top: var(--border); padding: 10px;
            display: flex; gap: 10px; z-index: 60;
        ">
            <input type="text" id="free-input" class="pixel-input" placeholder="è¾“å…¥ä½ æƒ³åšçš„äº‹... (ä¾‹: ä»”ç»†è§‚å¯Ÿå¢™å£)" style="margin: 0; font-size: 0.9rem;">
            <button class="pixel-btn" onclick="submitFreeAction()" style="margin: 0; width: 80px;">æ‰§è¡Œ</button>
        </div>

        <!-- é€‰é¡¹å±‚ï¼šæ³¨æ„ bottom: 60px æ˜¯ä¸ºäº†é¿å¼€ä¸Šé¢çš„è¾“å…¥æ¡† -->
        <div class="choices-overlay" id="choices-layer" style="bottom: 60px;"></div>
    </div>

    <!-- 4.5 ä¾¦æ¢æ‰‹è®° (Notebook) -->
    <div id="note-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// è°ƒæŸ¥æ‰‹è®° ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('note-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div style="margin-bottom: 20px;">
                <div style="color: var(--accent-gold); border-bottom: 1px dashed var(--dim); padding-bottom: 5px; margin-bottom: 10px;">
                    [ å½“å‰ç›®æ ‡ / CURRENT OBJECTIVE ]
                </div>
                <div id="quest-list" style="font-family: var(--font-read); line-height: 1.6; color: var(--fg);">
                    <!-- ä»»åŠ¡åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div>
                <div style="color: var(--accent-glitch); border-bottom: 1px dashed var(--dim); padding-bottom: 5px; margin-bottom: 10px;">
                    [ çº¿ç´¢è®°å½• / CLUES ]
                </div>
                <div id="clue-list" style="font-family: var(--font-read); font-size: 0.95rem; color: #aaa;">
                    <!-- çº¿ç´¢åŠ¨æ€ç”Ÿæˆ -->
                    <div style="font-style: italic; color: var(--dim)">æš‚æ— å…³é”®çº¿ç´¢...</div>
                </div>
            </div>
        </div>
    </div>


    <!-- 5. çŠ¶æ€é¢æ¿ -->
    <div id="status-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// è°ƒæŸ¥å‘˜çŠ¶æ€ ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('status-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div class="status-bio">
                <div style="color: var(--accent-glitch); font-weight: bold;">[ æ¡£æ¡ˆè®°å½• ]</div>
                <div id="s-bio-text" class="bio-text">æš‚æ— æ•°æ®...</div>
            </div>

            <div class="status-full-grid">
                <!-- æ–°å¢ï¼šå£°æœ›æ˜¾ç¤º -->
                <div class="attr-row" style="border-bottom: 2px solid var(--accent-gold);">
                    <div><span class="attr-name" style="color: var(--accent-gold);">REP å£°æœ›</span><span class="attr-desc">çŸ¥ååº¦ / å§”æ‰˜ç­‰çº§</span></div>
                    <div class="attr-val" id="s-rep" style="color: var(--accent-gold);">0</div>
                </div>

                <div class="attr-row">
                    <div><span class="attr-name">PHY ä½“é­„</span><span class="attr-desc">ç”Ÿå‘½ / æˆ˜æ–— / æŠµæŠ—</span></div>
                    <div class="attr-val" id="s-phy">0</div>
                </div>
                <div class="attr-row">
                    <div><span class="attr-name">DEX çµå·§</span><span class="attr-desc">é—ªé¿ / æ½œè¡Œ / å¼€é”</span></div>
                    <div class="attr-val" id="s-dex">0</div>
                </div>
                <div class="attr-row">
                    <div><span class="attr-name">INT å­¦è¯†</span><span class="attr-desc">è°ƒæŸ¥ / ç¥ç§˜å­¦ / é»‘å®¢</span></div>
                    <div class="attr-val" id="s-int">0</div>
                </div>
                <div class="attr-row">
                    <div><span class="attr-name">CHA é­…åŠ›</span><span class="attr-desc">äº¤æ¶‰ / æ¬ºè¯ˆ / æƒ…æŠ¥</span></div>
                    <div class="attr-val" id="s-cha">0</div>
                </div>
                <div class="attr-row" style="border-color: #a0f;">
                    <div><span class="attr-name" style="color: #a0f;">MYS çµè§†</span><span class="attr-desc">çœ‹è§ä¸å¯è§ä¹‹ç‰© / SANä¸Šé™</span></div>
                    <div class="attr-val" id="s-mys" style="color: #a0f;">0</div>
                </div>
                <div style="margin-top: 20px; border-top: 2px solid var(--fg); padding-top: 10px;">
                    <div class="attr-row">
                        <span class="attr-name">HP å½“å‰ç”Ÿå‘½</span>
                        <span class="attr-val" id="s-hp">0</span>
                    </div>
                    <div class="attr-row">
                        <span class="attr-name">SAN å½“å‰ç†æ™º</span>
                        <span class="attr-val" id="s-san">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. ç‰©å“æ  (Inventory) -->
    <div id="inventory-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// ç‰©å“æ¸…å• ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('inventory-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div id="inventory-list" class="inventory-grid">
                <!-- ç‰©å“å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="empty-bag-msg" style="text-align: center; color: var(--dim); margin-top: 50px; display: none;">
                [ ç©ºæ— ä¸€ç‰© ]
            </div>
        </div>
    </div>

    <!-- 7. åœ°å›¾ (Map) -->
    <div id="map-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// åŸå¸‚å¯¼èˆª ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('map-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div style="margin-bottom: 15px; color: var(--dim); font-size: 0.9rem;">
                å½“å‰ä½ç½®: <span id="current-location-name" style="color: var(--accent-glitch)">404å·äº‹åŠ¡æ‰€</span>
                <br>
                <span style="color: var(--accent-gold)">æç¤ºï¼šç™½å¤©å¯è‡ªç”±ç§»åŠ¨ï¼Œå¤œæ™šç§»åŠ¨å¯èƒ½é­é‡å±é™©ã€‚</span>
            </div>
            <div id="map-grid" class="map-grid">
                <!-- åœ°ç‚¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- 7.5 æ‰‹æœºç»ˆç«¯ (ç¾åŒ–ç‰ˆ) -->
    <div id="phone-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// æ™ºèƒ½ç»ˆç«¯ ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('phone-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content" style="position: relative; overflow: hidden;">
            <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
            <div style="display: flex; justify-content: space-between; padding: 0 10px 10px 10px; border-bottom: 1px solid #333; color: var(--dim); font-size: 0.8rem;">
                <span id="phone-carrier">NO SIGNAL</span>
                <span><span id="phone-time">12:00</span> | ğŸ”‹ 84%</span>
            </div>
            
            <!-- APP å›¾æ ‡ç½‘æ ¼ -->
            <div id="phone-home" class="app-grid">
                <div class="app-icon" onclick="handlePhoneAction('sns')">
                    <div class="app-symbol" style="border-color: #ff79c6; color: #ff79c6;">ğŸ’¬</div>
                    <div class="app-name">æ ‘æ´</div>
                </div>
                <div class="app-icon" onclick="handlePhoneAction('news')">
                    <div class="app-symbol" style="border-color: #8be9fd; color: #8be9fd;">ğŸ“°</div>
                    <div class="app-name">æ—©æŠ¥</div>
                </div>
                <div class="app-icon" onclick="handlePhoneAction('takeout')">
                    <div class="app-symbol" style="border-color: #f1fa8c; color: #f1fa8c;">ğŸ”</div>
                    <div class="app-name">é¥±äº†ä¹ˆ</div>
                </div>
                <div class="app-icon" onclick="handlePhoneAction('msg')">
                    <div class="app-symbol" style="border-color: #ff5555; color: #ff5555;">ğŸ“©</div>
                    <div class="app-name">çŸ­ä¿¡</div>
                </div>
            </div>

            <!-- APP å†…å®¹æ˜¾ç¤ºåŒº -->
            <div id="phone-display-area">
                <div class="app-header">
                    <button class="back-btn" onclick="closePhoneApp()">â†</button>
                    <span class="app-title" id="current-app-title">åº”ç”¨åç§°</span>
                </div>
                <div id="phone-content" style="flex: 1; overflow-y: auto; padding-bottom: 20px;">
                    <!-- åŠ¨æ€å†…å®¹å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>
    </div>

    <!-- 9. å‘½è¿éª°å­åŠ¨ç”»å±‚ (æ–°å¢) -->
    <div id="dice-layer" class="overlay-layer" style="justify-content: center; align-items: center; background: rgba(0,0,0,0.98); z-index: 50000;">
        <div style="text-align: center; width: 100%;">
            <div id="dice-title" style="color: var(--dim); margin-bottom: 30px; letter-spacing: 4px; font-family: var(--font-pixel);">ATTRIBUTE CHECK...</div>
            
            <!-- éª°å­æœ¬ä½“ -->
            <div id="dice-box" style="
                font-size: 6rem; font-weight: bold; color: var(--fg); 
                border: 6px solid var(--fg); width: 140px; height: 140px; 
                line-height: 120px; margin: 0 auto; position: relative;
                background: #000; box-shadow: 0 0 20px rgba(255,255,255,0.1);
                transition: all 0.2s;
            ">
                <span id="dice-val">20</span>
            </div>

            <!-- ç»“æœåé¦ˆ -->
            <div id="dice-result" style="font-size: 3rem; margin-top: 30px; height: 50px; font-weight: bold; letter-spacing: 5px; text-shadow: 0 0 10px currentColor;"></div>
            
            <div id="dice-target" style="color: var(--dim); margin-top: 20px; font-size: 1.2rem;">
                CHECK: <span id="check-attr" style="color: var(--accent-gold)">INT</span> | 
                TARGET: <span id="target-val" style="color: #fff">10</span>
            </div>
        </div>
    </div>


    <!-- 8. å†å²è®°å½•å±‚ -->
    <div id="log-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// è°ƒæŸ¥è®°å½• ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('log-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div id="log-content" class="overlay-content"></div>
    </div>

<script>
/**
 * å…¨å±€çŠ¶æ€ä¸é…ç½®
 */
let config = {
    baseUrl: localStorage.getItem('mc_base_url') || 'https://api.openai.com/v1',
    apiKey: localStorage.getItem('mc_api_key') || '',
    model: localStorage.getItem('mc_model') || 'gpt-3.5-turbo'
};

// æ—¶é—´é˜¶æ®µå¸¸é‡
const TIME_PHASES = ["ä¸Šåˆ", "ä¸‹åˆ", "é»„æ˜", "æ·±å¤œ"];
const TIME_ICONS = ["â˜€ï¸", "â˜€ï¸", "ğŸŒ‡", "ğŸŒ™"];

let gameState = {
    day: 1,
    timePhase: 0, // 0-3
    money: 2000,
    reputation: 0, // å£°æœ›å€¼
    currentLocation: "404å·äº‹åŠ¡æ‰€",
    player: { name: "", job: "", extra: "", desc: "" },
    stats: { 
        hp: 100, maxHp: 100, 
        san: 60, maxSan: 60,
        phy: 10, dex: 10, int: 10, cha: 10, mys: 10 
    },
    // === æ–°å¢ï¼šæ ¸å¿ƒè°œå›¢ç³»ç»Ÿ ===
    mystery: {
        active: false,      // æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„è°œå›¢
        title: "",          // è°œé¢ (ç©å®¶å¯è§ï¼Œå¦‚"åˆå¤œæ•²é—¨å£°")
        truth: "",          // è°œåº• (ç©å®¶ä¸å¯è§ï¼ŒAIå¯è§ï¼Œç”¨äºå¼•å¯¼å‰§æƒ…)
        deadlineDay: 0,     // æˆªæ­¢æ—¥æœŸ (Day X æ™šä¸Šç»“ç®—)
        status: "pending"   // pending, solved, failed
    },
    inventory: [],
    quests: [
        { id: "main", text: "å…¥ä½404å·äº‹åŠ¡æ‰€ï¼Œç†Ÿæ‚‰ç¯å¢ƒã€‚", active: true } 
    ],
    clues: [], 
    unlockedLocations: [
        { name: "404å·äº‹åŠ¡æ‰€", id: "home", locked: false, type: "safe" },
        { name: "ä¾¿åˆ©åº—", id: "shop", locked: false, type: "shop" },
        { name: "å¿ƒç†è¯Šæ‰€", id: "clinic", locked: false, type: "heal" }
    ],
    history: [], 
    log: [],
    flags: {
        introDone: false,
        hasCheckedMail: false
    }
};

// === æ–°å¢ï¼šåœºæ™¯èƒŒæ™¯å›¾é…ç½® ===
const SCENE_IMAGES = {
    // æ ¼å¼ï¼š "å…³é”®è¯": "å›¾ç‰‡é“¾æ¥"
    "äº‹åŠ¡æ‰€": "https://i.postimg.cc/fRb8s2PP/shi-wu-suo1.png",
    "åŒ»é™¢": "https://media.istockphoto.com/id/1352178903/vector/hospital-building-pixel-art-vector-illustration.jpg?s=612x612&w=0&k=20&c=gK4sF4w0XyM-J9vW_D2yv9xK_E8hZ_u_X_y_Z_z_0=", // ç¤ºä¾‹å ä½å›¾ï¼Œä½ å¯ä»¥æ¢æˆä½ çš„
    "ä¾¿åˆ©åº—": "", // æš‚æ—¶ç•™ç©ºï¼Œæ˜¾ç¤ºé»˜è®¤é»‘è‰²
    "è¡—é“": "" 
};

// åˆ‡æ¢èƒŒæ™¯å›¾çš„å‡½æ•°
function updateSceneBackground(locationName) {
    const visualArea = document.getElementById('visual-area');
    let bgUrl = ""; // é»˜è®¤ä¸ºç©ºï¼ˆé»‘è‰²èƒŒæ™¯ï¼‰

    // éå†é…ç½®ï¼Œåªè¦åœ°ç‚¹åå­—åŒ…å«å…³é”®è¯ï¼ˆæ¯”å¦‚"ç¬¬ä¸€äººæ°‘åŒ»é™¢"åŒ…å«"åŒ»é™¢"ï¼‰ï¼Œå°±åº”ç”¨å›¾ç‰‡
    for (const [key, url] of Object.entries(SCENE_IMAGES)) {
        if (locationName.includes(key) && url) {
            bgUrl = url;
            break; // æ‰¾åˆ°åŒ¹é…çš„å°±åœæ­¢
        }
    }

    if (bgUrl) {
        visualArea.style.backgroundImage = `url('${bgUrl}')`;
    } else {
        visualArea.style.backgroundImage = 'none'; // æ²¡æœ‰åŒ¹é…å›¾æ—¶æ¢å¤é»˜è®¤
    }
}

let avgState = {
    textQueue: [],
    currentFullText: "",
    isTyping: false,
    typingTimer: null,
    charIndex: 0,
    pendingChoices: [],
    isWaitingForAI: false,
    isReadyToPlay: false,
    tempData: null
};

// --- 0. å¼€åœºåŠ¨ç”»é€»è¾‘ ---
const slides = [
    { text: "æ¬¢è¿æ¥åˆ° <span class='highlight-neon' style='font-size: 2.2rem'>é›¾å·å¸‚</span>ã€‚", style: "text-align: center;" },
    { text: "è¿™é‡Œçš„æˆ¿ç§Ÿå¾ˆä¾¿å®œï¼Œé›¨æ°´å¾ˆå……æ²›ï¼Œéœ“è™¹ç¯å¾ˆäº®ã€‚\näº®åˆ°è¶³ä»¥æ©ç›–å··å­é‡Œé‚£äº›â€¦â€¦\n<br><span class='highlight-scary' style='font-size: 2rem'>è •åŠ¨çš„é˜´å½±</span>ã€‚", style: "text-align: left;" },
    { text: "ä½ æ¥æ‰‹äº† <span style='border-bottom: 2px solid white'>404å·äº‹åŠ¡æ‰€</span>ã€‚\nè¿™æ—¢æ˜¯ä½ çš„æ–°å®¶ï¼Œä¹Ÿæ˜¯ä½ çª¥æ¢â€œé‡Œä¸–ç•Œâ€çš„çª—å£ã€‚", style: "text-align: left;" },
    { text: "è¯·è®°ä½ä¸‰æ¡ç”Ÿå­˜æ³•åˆ™ï¼š\n\n1. ç™½å¤©æ˜¯å®‰å…¨çš„ï¼Œå°½æƒ…äº«å—é˜³å…‰ã€‚\n2. å¤œæ™šå±äºâ€œå®ƒä»¬â€ï¼Œä¸è¦è½»æ˜“å‡ºé—¨ã€‚\n3. ä¿æŒç†æ™ºï¼Œæˆ–è€…â€¦â€¦<span style='font-style:italic'>äº«å—ç–¯ç‹‚</span>ã€‚", style: "text-align: left;" },
    { text: "å‡†å¤‡å¥½å¼€å§‹ä½ çš„â€œæ­£å¸¸â€ç”Ÿæ´»äº†å—ï¼Ÿ", style: "text-align: center; font-size: 1.5rem;" }
];

let currentSlide = 0;
const introLayer = document.getElementById('intro-layer');
const introContent = document.getElementById('intro-content');

showSlide(0);

function showSlide(index) {
    introContent.classList.remove('show');
    setTimeout(() => {
        if (index >= slides.length) { endIntro(); return; }
        introContent.innerHTML = slides[index].text;
        introContent.style.cssText = slides[index].style;
        introContent.classList.add('show');
    }, 300);
}

function nextSlide() {
    currentSlide++;
    if (currentSlide < slides.length) showSlide(currentSlide);
    else endIntro();
}

function endIntro() {
    introLayer.style.opacity = '0';
    introLayer.style.pointerEvents = 'none';
    setTimeout(() => {
        introLayer.style.display = 'none';
        document.getElementById('title-screen').classList.add('active');
    }, 1000);
}

// --- 1. åˆå§‹åŒ–ä¸è®¾ç½® ---
document.getElementById('api-url').value = config.baseUrl;
document.getElementById('api-key').value = config.apiKey;
document.getElementById('api-model').value = config.model;
checkApiStatus();

function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

function saveSettings() {
    config.baseUrl = document.getElementById('api-url').value.replace(/\/$/, "");
    config.apiKey = document.getElementById('api-key').value;
    config.model = document.getElementById('api-model').value;
    localStorage.setItem('mc_base_url', config.baseUrl);
    localStorage.setItem('mc_api_key', config.apiKey);
    localStorage.setItem('mc_model', config.model);
    checkApiStatus();
    closeSettings();
}

function checkApiStatus() {
    const btn = document.getElementById('btn-enter-town');
    const indicator = document.getElementById('api-status-indicator');
    if (config.apiKey && config.apiKey.length > 5) {
        btn.disabled = false;
        indicator.innerText = "[ âˆš ç¥ç»è¿æ¥å°±ç»ª ]";
        indicator.style.color = "var(--accent-glitch)";
    } else {
        btn.disabled = true;
        indicator.innerText = "[ âš ï¸ ç¥ç»è¿æ¥æœªå°±ç»ª ]";
        indicator.style.color = "var(--dim)";
    }
}

// === æ–°å¢ï¼šå­˜æ¡£ç³»ç»Ÿ ===
function checkSaveFile() {
    const save = localStorage.getItem('mc_save_data');
    const btn = document.getElementById('btn-continue');
    if (save) {
        btn.style.display = 'block';
        btn.innerText = `ğŸ“‚ è¯»å–å­˜æ¡£ (DAY ${JSON.parse(save).day})`;
    } else {
        btn.style.display = 'none';
    }
}

function saveGame() {
    try {
        localStorage.setItem('mc_save_data', JSON.stringify(gameState));
        alert("âœ… è¿›åº¦å·²ä¿å­˜è‡³æœ¬åœ°ç¥ç»å›è·¯ã€‚");
        checkSaveFile(); // åˆ·æ–°æ ‡é¢˜ç”»é¢æŒ‰é’®çŠ¶æ€
    } catch (e) {
        alert("âŒ ä¿å­˜å¤±è´¥: " + e.message);
    }
}

function loadGame() {
    const save = localStorage.getItem('mc_save_data');
    if (!save) return alert("æœªæ‰¾åˆ°å­˜æ¡£è®°å½•ã€‚");
    
    if (confirm("ç¡®å®šè¦è¯»å–å­˜æ¡£å—ï¼Ÿå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚")) {
        try {
            const loadedState = JSON.parse(save);
            // è¦†ç›–å½“å‰çŠ¶æ€
            gameState = loadedState;
            
            // æ¢å¤ç•Œé¢
            document.getElementById('title-screen').classList.remove('active');
            document.getElementById('intro-layer').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            
            // åˆ·æ–°æ‰€æœ‰UI
            updateStatsUI();
            addToLog("[ç³»ç»Ÿ] å­˜æ¡£è¯»å–æˆåŠŸã€‚");
            
            // å°è¯•æ¢å¤ä¸Šä¸€æ¡æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
            if (gameState.history.length > 0) {
                const lastMsg = gameState.history[gameState.history.length - 1];
                if (lastMsg.role === 'assistant') {
                    // ç®€å•çš„æ¢å¤æ˜¾ç¤ºï¼Œä¸è§¦å‘æ‰“å­—æœº
                    document.getElementById('main-text').innerText = "ï¼ˆ...è®°å¿†é‡è½½å®Œæˆ...ï¼‰";
                    setTimeout(() => {
                         // è¿™é‡Œæˆ‘ä»¬ä¸é‡æ–°è§£æJSONï¼Œåªæ˜¯ç»™ä¸ªæç¤ºï¼Œè®©ç©å®¶ç»§ç»­æ“ä½œ
                         handleScene('continue', 'è¯»å–å­˜æ¡£åç»§ç»­');
                    }, 1000);
                }
            } else {
                handleScene('intro_day1'); // å¦‚æœæ˜¯åæ¡£ï¼Œé‡ç½®åˆ°ç¬¬ä¸€å¤©
            }
            
        } catch (e) {
            alert("âŒ å­˜æ¡£æŸå: " + e.message);
        }
    }
}

function deleteSave() {
    if (confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤å­˜æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) {
        localStorage.removeItem('mc_save_data');
        checkSaveFile();
        alert("å­˜æ¡£å·²ç²‰ç¢ã€‚");
    }
}

// åˆå§‹åŒ–æ—¶æ£€æŸ¥å­˜æ¡£
window.addEventListener('load', checkSaveFile);


async function testConnection() {
    const msgEl = document.getElementById('test-msg');
    msgEl.innerText = "æ­£åœ¨å‘¼å«çµç•Œä¿¡å·..."; 
    msgEl.className = "status-msg";
    
    try {
        const response = await fetch(`${config.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${config.apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                model: config.model, 
                messages: [{ role: "user", content: "Say OK" }], 
                max_tokens: 5 
            })
        });
        
        if (response.ok) {
            msgEl.innerText = "è¿æ¥æˆåŠŸï¼çµç•Œä¿¡å·ç¨³å®šã€‚"; 
            msgEl.className = "status-msg success";
        } else { 
            // å°è¯•è¯»å–é”™è¯¯ä¿¡æ¯
            const errData = await response.json().catch(() => ({}));
            const errMsg = errData.error?.message || response.statusText;
            throw new Error(`HTTP ${response.status}: ${errMsg}`); 
        }
    } catch (e) {
        console.error("API Error:", e);
        let showMsg = "è¿æ¥å¤±è´¥: " + e.message;
        if (e.message.includes("Failed to fetch")) {
            showMsg = "è¿æ¥è¢«é˜»æ–­ (CORSæˆ–ç½‘ç»œé—®é¢˜)ã€‚è¯·æ£€æŸ¥ä»£ç†æˆ–APIåœ°å€ã€‚";
        }
        msgEl.innerText = showMsg; 
        msgEl.className = "status-msg error";
    }
}

// å®šä¹‰å…¨å±€æ§åˆ¶å™¨ï¼ˆå¦‚æœåˆšæ‰æ²¡åŠ ï¼Œè¿™é‡ŒåŠ ä¸Šï¼›å¦‚æœåŠ äº†ï¼Œè¦†ç›–ä¹Ÿæ²¡äº‹ï¼‰
let modelAbortController = null; 

async function fetchModels() {
    // === ä¿®å¤æ ¸å¿ƒï¼šå®æ—¶è·å–è¾“å…¥æ¡†é‡Œçš„ URL å’Œ Keyï¼Œè€Œä¸æ˜¯è¯»å–æ—§é…ç½® ===
    const currentUrl = document.getElementById('api-url').value.replace(/\/$/, "");
    const currentKey = document.getElementById('api-key').value;

    if(!currentKey) return alert("è¯·è¾“å…¥Key");

    const btn = document.activeElement; 
    const isBtn = btn && btn.tagName === 'BUTTON';
    const inputEl = document.getElementById('api-model'); // è·å–å½“å‰çš„è¾“å…¥æ¡†

    // 1. å–æ¶ˆé€»è¾‘
    if (modelAbortController) {
        modelAbortController.abort();
        modelAbortController = null;
        if(isBtn) {
            btn.innerText = "åˆ—è¡¨";
            btn.disabled = false;
        }
        return;
    }

    // 2. å¼€å§‹æ‹‰å–
    modelAbortController = new AbortController();
    const signal = modelAbortController.signal;

    if(isBtn) btn.innerText = "å–æ¶ˆ (15s)";
    
    // è¶…æ—¶è®¡æ—¶å™¨
    const timeoutId = setTimeout(() => {
        if (modelAbortController) {
            modelAbortController.abort();
            alert("âš ï¸ è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
        }
    }, 15000);

    try {
        // === ä¿®å¤ï¼šä½¿ç”¨ currentUrl å‘é€è¯·æ±‚ ===
        const res = await fetch(`${currentUrl}/models`, {
            method: 'GET', 
            headers: { 'Authorization': `Bearer ${currentKey}` },
            signal: signal
        });
        
        clearTimeout(timeoutId);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        // è·å–æ¨¡å‹æ•°ç»„
        const modelList = (data.data || data).map(m => m.id || m);

        if(modelList.length === 0) throw new Error("æœªæ‰¾åˆ°æ¨¡å‹");

        // === âœ¨ æ ¸å¿ƒé­”æ³•ï¼šåŸåœ°å˜èº«ä¸‹æ‹‰èœå• ===
        
        // 1. åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹æ‹‰æ¡†
        const select = document.createElement('select');
        select.id = 'api-model'; // ä¿æŒIDä¸å˜ï¼Œè¿™æ ·ä¿å­˜åŠŸèƒ½ä¾ç„¶æœ‰æ•ˆ
        select.className = 'pixel-input'; // ä¿æŒæ ·å¼ä¸å˜
        
        // 2. å¡«å……é€‰é¡¹
        modelList.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.innerText = m;
            // å¦‚æœå’Œå½“å‰å¡«çš„ä¸€æ ·ï¼Œè‡ªåŠ¨é€‰ä¸­
            if(m === config.model) opt.selected = true;
            select.appendChild(opt);
        });

        // 3. æ›¿æ¢æ‰åŸæ¥çš„è¾“å…¥æ¡†
        inputEl.parentNode.replaceChild(select, inputEl);

        // 4. æç¤ºæˆåŠŸ
        if(isBtn) btn.innerText = "âˆš å°±ç»ª";
        setTimeout(() => { if(isBtn) btn.innerText = "åˆ—è¡¨"; }, 2000);

    } catch(e) { 
        if (e.name !== 'AbortError') {
            console.error(e);
            alert("âš ï¸ æ‹‰å–å¤±è´¥: " + e.message); 
        }
    } finally {
        modelAbortController = null;
        clearTimeout(timeoutId);
        if(isBtn && btn.innerText.includes("å–æ¶ˆ")) {
            btn.innerText = "åˆ—è¡¨";
            btn.disabled = false;
        }
    }
}

// === æ–°å¢ï¼šéšæœºäººè®¾åº“ ===
const R_NAMES = ["æ—æ©", "K", "è«é‡Œæ–¯", "é™ˆ", "è‰¾è¾¾", "é˜¿é»‘", "é¸¦", "ç™½", "42å·", "ç‘æ©"];
const R_JOBS = ["ç§å®¶ä¾¦æ¢", "é»‘å®¢", "åŒ»ç”Ÿ", "å¤è‘£å•†", "è½é­„è®°è€…", "é™¤çµå¸ˆ", "è°ƒé…’å¸ˆ", "èµé‡‘çŒäºº"];
const R_EXTRAS = ["æ€»æ˜¯å¬åˆ°å¹»å¬", "æ¬ äº†é«˜åˆ©è´·", "æ‹¥æœ‰é˜´é˜³çœ¼", "å¤±å¿†äº†", "å³è‡‚æ®‹ç¼º", "é‡åº¦å¤±çœ ", "èƒ½çœ‹è§æ­»äº¡å€’è®¡æ—¶"];

function randomizeInputs() {
    document.getElementById('char-name').value = R_NAMES[Math.floor(Math.random() * R_NAMES.length)];
    document.getElementById('char-job').value = R_JOBS[Math.floor(Math.random() * R_JOBS.length)];
    document.getElementById('char-extra').value = R_EXTRAS[Math.floor(Math.random() * R_EXTRAS.length)];
}

// === æ–°å¢ï¼šè‡ªç”±è¡ŒåŠ¨å¤„ç† ===
function submitFreeAction() {
    const inputEl = document.getElementById('free-input');
    const actionText = inputEl.value.trim();
    
    if (!actionText) return;
    if (avgState.isWaitingForAI) return alert("æ­£åœ¨è¿æ¥çµç•Œï¼Œè¯·ç¨å€™...");
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    inputEl.value = "";
    
    // éšè—é€‰é¡¹å±‚ï¼Œé˜²æ­¢å†²çª
    document.getElementById('choices-layer').classList.remove('active');
    
    // ä¿®æ”¹é€»è¾‘ï¼šä¸å†ç›´æ¥ç”Ÿæˆå‰§æƒ…ï¼Œè€Œæ˜¯å…ˆè¯·æ±‚AIè¿›è¡Œâ€œè£åˆ¤åˆ¤å®šâ€
    handleScene('judge_action', actionText);
}


// --- 2. è§’è‰²åˆ›å»ºä¸æ¡£æ¡ˆç”Ÿæˆ ---

function goToCharCreation() {
    document.getElementById('title-screen').classList.remove('active');
    document.getElementById('char-screen').classList.add('active');
}

async function generatePersona() {
    const name = document.getElementById('char-name').value.trim();
    const job = document.getElementById('char-job').value.trim();
    const extra = document.getElementById('char-extra').value.trim();

    if (!name || !job) return alert("è¯·è‡³å°‘å¡«å†™å§“åå’Œå‰èŒã€‚");

    gameState.player = { name, job, extra, desc: "" };

    document.getElementById('char-screen').classList.remove('active');
    document.getElementById('persona-screen').classList.add('active');
    document.getElementById('persona-loading').style.display = 'block';
    document.getElementById('persona-result').style.display = 'none';

    const prompt = `
    ç©å®¶æ­£åœ¨åˆ›å»ºè§’è‰²ã€‚
    å§“åï¼š${name}
    èŒä¸šï¼š${job}
    é¢å¤–ç‰¹è´¨/ç§˜å¯†ï¼š${extra || "æ— "}
    
    è¯·ç”Ÿæˆä¸€ä¸ªè¯¦ç»†ã€æœ‰æ·±åº¦çš„è½»åº¦ææ€–æ—¥å¸¸é£æ ¼äººç‰©ä¾§å†™ã€‚
    å¹¶æ ¹æ®èŒä¸šå’Œç‰¹è´¨ï¼Œç”Ÿæˆä»¥ä¸‹å±æ€§æ•°å€¼ï¼ˆèŒƒå›´1-20ï¼Œæ™®é€šäººå¹³å‡10ï¼‰ï¼š
    - PHY (ä½“é­„): ç”Ÿå‘½ã€æˆ˜æ–—
    - DEX (çµå·§): æ•æ·ã€æ½œè¡Œ
    - INT (å­¦è¯†): çŸ¥è¯†ã€æŠ€æœ¯
    - CHA (é­…åŠ›): ç¤¾äº¤ã€æ¬ºè¯ˆ
    - MYS (çµè§†): æ ¸å¿ƒå±æ€§ï¼Œæ„ŸçŸ¥è¶…è‡ªç„¶çš„èƒ½åŠ›
    
    è¯·ä¸¥æ ¼è¿”å›JSONæ ¼å¼ï¼š
    {
        "description": "ä¸€æ®µç¬¬äºŒäººç§°çš„æè¿°ï¼ˆçº¦120-150å­—ï¼‰ï¼Œè¯¦ç»†è¯´æ˜ä½ çš„è¿‡å»ã€ç°åœ¨çš„çŠ¶æ€ä»¥åŠä¸ºä½•æ¥åˆ°è¿™é‡Œï¼Œæ°›å›´è¦å‹æŠ‘ä¸”å……æ»¡ç»†èŠ‚ã€‚",
        "phy": 10,
        "dex": 10,
        "int": 10,
        "cha": 10,
        "mys": 10
    }
    `;

    const result = await callAI(prompt, true);

    if (result) {
        document.getElementById('persona-loading').style.display = 'none';
        document.getElementById('persona-result').style.display = 'block';
        
        document.getElementById('dossier-name').innerText = `NAME: ${name}`;
        document.getElementById('dossier-job').innerText = `JOB: ${job}`;
        document.getElementById('dossier-desc').innerText = result.description;
        
        gameState.player.desc = result.description;

        document.getElementById('p-phy').innerText = result.phy;
        document.getElementById('p-dex').innerText = result.dex;
        document.getElementById('p-int').innerText = result.int;
        document.getElementById('p-cha').innerText = result.cha;
        document.getElementById('p-mys').innerText = result.mys;

        const hp = 50 + (result.phy * 5);
        const san = 20 + (result.mys * 5);

        document.getElementById('p-hp').innerText = hp;
        document.getElementById('p-san').innerText = san;

        gameState.stats = {
            hp: hp, maxHp: hp,
            san: san, maxSan: san,
            phy: result.phy, dex: result.dex, int: result.int, cha: result.cha, mys: result.mys
        };
        
        gameState.inventory.push({
            id: "dice", name: "å‘½è¿éª°å­", type: "key", count: 1,
            desc: "ä¸€é¢—ç£¨æŸçš„å…­é¢éª°å­ï¼Œä¼¼ä¹æ€»èƒ½æŠ•å‡ºä½ æƒ³è¦çš„ç‚¹æ•°ã€‚",
            desc_insane: "å®ƒåœ¨çœ‹ç€ä½ ã€‚ä¸Šé¢çš„ç‚¹æ•°å˜æˆäº†çœ¼ç›ã€‚",
            effect: "none"
        });

    } else {
        alert("æ¡£æ¡ˆç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚");
        document.getElementById('persona-screen').classList.remove('active');
        document.getElementById('char-screen').classList.add('active');
    }
}

function realStartGame() {
    document.getElementById('persona-screen').classList.remove('active');
    document.getElementById('game-screen').classList.add('active');
    updateStatsUI();
    // å¼ºåˆ¶è¿›å…¥ Day 1 æ•™å­¦æµç¨‹
    handleScene("intro_day1");
}

// --- 3. æ¸¸æˆä¸»å¾ªç¯ (æ ¸å¿ƒäº¤äº’é€»è¾‘) ---

function updateStatsUI() {
    document.getElementById('val-hp').innerText = gameState.stats.hp;
    document.getElementById('val-san').innerText = gameState.stats.san;
    document.getElementById('val-money').innerText = gameState.money;
    
    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    document.getElementById('day-num').innerText = `DAY ${gameState.day}`;
    document.getElementById('time-icon').innerText = TIME_ICONS[gameState.timePhase];
    document.getElementById('time-text').innerText = TIME_PHASES[gameState.timePhase];
    
    // äº‹åŠ¡æ‰€HUDæ§åˆ¶
    const officeHud = document.getElementById('office-hud');
    if (gameState.currentLocation === "404å·äº‹åŠ¡æ‰€") {
        officeHud.classList.add('active');
    } else {
        officeHud.classList.remove('active');
    }

    // æ›´æ–°çŠ¶æ€é¢æ¿
    document.getElementById('s-bio-text').innerText = gameState.player.desc || "æš‚æ— æ•°æ®...";
    // æ–°å¢ï¼šæ›´æ–°å£°æœ›
    document.getElementById('s-rep').innerText = gameState.reputation;
    
    document.getElementById('s-phy').innerText = gameState.stats.phy;
    document.getElementById('s-dex').innerText = gameState.stats.dex;
    document.getElementById('s-int').innerText = gameState.stats.int;
    document.getElementById('s-cha').innerText = gameState.stats.cha;
    document.getElementById('s-mys').innerText = gameState.stats.mys;
    document.getElementById('s-hp').innerText = `${gameState.stats.hp} / ${gameState.stats.maxHp}`;
    document.getElementById('s-san').innerText = `${gameState.stats.san} / ${gameState.stats.maxSan}`;

    if (gameState.stats.san < 30) document.body.classList.add('glitch-text');
    else document.body.classList.remove('glitch-text');
}

// å¤„ç† AI è¿”å›çš„æ•°æ®
function processSceneData(data) {
    // === ä¼˜å…ˆå¤„ç†åœ°ç‚¹å˜æ›´ ===
    if (data.move_to) {
        gameState.currentLocation = data.move_to;
    }

    // === æ–°å¢ï¼šå¤„ç†æ ¸å¿ƒè°œå›¢ç”Ÿæˆ ===
    // é€»è¾‘ä¼˜åŒ–ï¼šåªæœ‰å½“å½“å‰æ²¡æœ‰è°œå›¢ï¼Œæˆ–è€…æ–°è°œå›¢ä¸å½“å‰ä¸åŒæ—¶æ‰è§¦å‘ï¼Œé˜²æ­¢é‡å¤æ˜¾ç¤º
    if (data.mystery_setup && (!gameState.mystery.active || gameState.mystery.title !== data.mystery_setup.title)) {
        gameState.mystery.active = true;
        gameState.mystery.title = data.mystery_setup.title;
        gameState.mystery.truth = data.mystery_setup.truth;
        // æˆªæ­¢æ—¥æœŸ = å½“å‰å¤©æ•° + åç§»é‡
        gameState.mystery.deadlineDay = gameState.day + (data.mystery_setup.days_limit || 3);
        gameState.mystery.status = "pending";
        
        // å¼ºåˆ¶åœ¨æè¿°ä¸­è¿½åŠ é†’ç›®çš„ UI æç¤º (ä½¿ç”¨ div å—çº§å…ƒç´ é˜²æ­¢æ··æ’)
        data.description += `\n\n<div style="border:1px solid var(--accent-red); background:rgba(50,0,0,0.3); padding:15px; margin:15px 0; text-align:center; animation: blink 2s infinite;">
            <div style="color:var(--accent-red); font-weight:bold; font-size:1.2rem; letter-spacing:2px;">âš ï¸ è§¦å‘æ ¸å¿ƒè°œå›¢</div>
            <div style="color:#fff; font-size:1.1rem; margin:5px 0;">ã€ ${gameState.mystery.title} ã€</div>
            <div style="color:#aaa; font-size:0.9rem;">å¿…é¡»åœ¨ Day ${gameState.mystery.deadlineDay} ç»“æŸå‰æŸ¥æ¸…çœŸç›¸</div>
        </div>`;
        
        // è‡ªåŠ¨æ·»åŠ ä»»åŠ¡
        gameState.quests.push({ 
            id: 'mystery_'+Date.now(), 
            text: `[æ ¸å¿ƒ] è§£å†³è°œå›¢ï¼š${gameState.mystery.title} (æˆªæ­¢: Day ${gameState.mystery.deadlineDay})`, 
            active: true 
        });
    }

    // === æ–°å¢ï¼šå¤„ç†è°œå›¢ç»“ç®—ç»“æœ ===
    if (data.mystery_result) {
        gameState.mystery.active = false; // å…³é—­å½“å‰è°œå›¢
        gameState.mystery.truth = "";     // æ¸…ç©ºçœŸç›¸ï¼Œé˜²æ­¢å¹²æ‰°åç»­
        
        if (data.mystery_result.success) {
            // æˆåŠŸå¥–åŠ±
            gameState.reputation += 20;
            gameState.money += 1000;
            gameState.stats.san = Math.min(gameState.stats.maxSan, gameState.stats.san + 20);
            data.description += `\n<span style="color:#0f0; font-size:1.2rem;">[ âœ… è°œé¢˜ç ´è§£æˆåŠŸï¼ ]</span>\nè·å¾—ï¼šå£°æœ›+20, èµ„é‡‘+1000, SAN+20`;
        } else {
            // å¤±è´¥æƒ©ç½š
            gameState.reputation -= 10;
            gameState.stats.san -= 20;
            gameState.stats.maxHp -= 10; // æ°¸ä¹…æ‰£è¡€ä¸Šé™
            data.description += `\n<span style="color:#f00; font-size:1.2rem;">[ âŒ è°œé¢˜ç ´è§£å¤±è´¥... ]</span>\næƒ©ç½šï¼šå£°æœ›-10, SAN-20, ç”Ÿå‘½ä¸Šé™æ°¸ä¹…-10`;
        }
    }

    // === ä¿®å¤ï¼šæ¯æ¬¡å‰§æƒ…æ›´æ–°æ—¶ï¼Œå¼ºåˆ¶åˆ·æ–°UIçŠ¶æ€ ===
    updateStatsUI(); 

    document.getElementById('scene-title').innerText = gameState.currentLocation;
    
    // === æ ¹æ®åœ°ç‚¹åå­—è‡ªåŠ¨åˆ‡æ¢èƒŒæ™¯å›¾ ===
    updateSceneBackground(gameState.currentLocation);

    // 1. å¤„ç† SAN Check
    if (data.event === 'san_check') {
        const roll = Math.floor(Math.random() * 100) + 1;
        const success = roll <= gameState.stats.san;
        const dmg = success ? 0 : Math.floor(Math.random() * 10) + 1;
        gameState.stats.san -= dmg;
        updateStatsUI(); // æ•°å€¼å˜äº†å†åˆ·ä¸€æ¬¡
        const checkText = `[SANæ£€å®š: ${roll}/${gameState.stats.san + dmg}] ${success ? 'ä½ ç¨³ä½äº†å¿ƒç¥ã€‚' : 'ä½ çš„ç†æ™ºå—åˆ°äº†å†²å‡»ï¼(SAN -'+dmg+')'}`;
        data.description = checkText + "\n" + data.description;
    }

    // 2. å¤„ç†æ‰è½ç‰©å“ (Loot)
    if (data.loot && Array.isArray(data.loot) && data.loot.length > 0) {
        let lootText = "";
        data.loot.forEach(item => {
            // å®¹é”™å¤„ç†1ï¼šå¦‚æœAIå‘ç–¯è¿”å›äº†çº¯å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ ["é’¥åŒ™"]ï¼‰ï¼ŒæŠŠå®ƒåŒ…è£…æˆå¯¹è±¡
            if (typeof item === 'string') {
                item = { name: item, type: 'misc', desc: 'çœ‹èµ·æ¥å¾ˆæœ‰ç”¨ã€‚' };
            }
            
            // å®¹é”™å¤„ç†2ï¼šæ ¸å¿ƒä¿®å¤ï¼å¦‚æœç‰©å“æ— æ•ˆæˆ–æ²¡æœ‰åå­—ï¼Œç›´æ¥è·³è¿‡ï¼Œç»ä¸æ˜¾ç¤º undefined
            if (!item || !item.name) return; 

            const existing = gameState.inventory.find(i => i.name === item.name);
            if (existing && existing.type === 'consumable') {
                existing.count++;
            } else if (!existing) {
                item.count = 1;
                item.id = item.id || 'item_' + Date.now();
                if (!item.desc_insane) item.desc_insane = "è¿™ä¸œè¥¿çœ‹èµ·æ¥æ‰­æ›²è€Œæ¶å¿ƒã€‚";
                gameState.inventory.push(item);
            }
            lootText += `\n[è·å¾—ç‰©å“: ${item.name}]`;
        });
        data.description += lootText;
    }

    // 3. å¤„ç†åœ°å›¾è§£é”
    // ä¿®æ”¹ï¼šå¢åŠ åˆ¤æ–­ï¼Œå¦‚æœ AI è¿”å› "none" åˆ™ä¸æ‰§è¡Œ
    if (data.unlock_location && data.unlock_location.toLowerCase() !== "none") {
        const locName = data.unlock_location;
        if (!gameState.unlockedLocations.find(l => l.name === locName)) {
            gameState.unlockedLocations.push({ name: locName, id: 'loc_'+Date.now(), locked: false, type: 'danger' });
            data.description += `\n[åœ°å›¾æ›´æ–°: å·²æ ‡è®° "${locName}"]`;
        }
    }

    // 4. å¤„ç†æ–°çº¿ç´¢ (æ–°å¢)
    // ä¿®æ”¹ï¼šå¢åŠ åˆ¤æ–­ï¼Œå¦‚æœ AI è¿”å› "none" åˆ™ä¸æ˜¾ç¤º
    if (data.new_clue && data.new_clue.toLowerCase() !== "none") {
        gameState.clues.push(data.new_clue);
        data.description += `\n<span style="color:var(--accent-gold)">[ è®°å½•çº¿ç´¢: ${data.new_clue} ]</span>`;
    }


    // 5. å¤„ç†ä»»åŠ¡æ›´æ–° (æ–°å¢)
    if (data.update_quest) {
        // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æŠŠæ—§ä»»åŠ¡éƒ½æ ‡è®°ä¸ºå®Œæˆï¼Œæ·»åŠ æ–°ä»»åŠ¡
        gameState.quests.forEach(q => q.active = false);
        gameState.quests.push({ id: 'q_'+Date.now(), text: data.update_quest, active: true });
        data.description += `\n<span style="color:var(--accent-glitch); border:1px solid var(--accent-glitch); padding:2px;">[ ä»»åŠ¡æ›´æ–°: ${data.update_quest} ]</span>`;
    }

    // 6. å¤„ç†å£°æœ›/é‡‘é’±å˜åŒ– (AI å¯èƒ½ä¼šåœ¨æè¿°é‡Œæš—ç¤ºï¼Œä½†æˆ‘ä»¬å¯ä»¥åŠ ä¸ªç®€å•çš„å…³é”®è¯æ£€æµ‹)
    // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„é€»è¾‘ï¼šå¦‚æœæè¿°é‡ŒåŒ…å« "å£°æœ›æå‡" æˆ– "åå£°å¤§å™ª"ï¼Œæˆ‘ä»¬æ‰‹åŠ¨åŠ ä¸€ç‚¹
    if (data.description.includes("å£°æœ›æå‡") || data.description.includes("åå£°")) {
        gameState.reputation += 5;
        data.description += `\n<span style="color:var(--accent-gold)">[ â–² å£°æœ›æå‡ ]</span>`;
    }
    // å¦‚æœåŒ…å« "è·å¾—æŠ¥é…¬" æˆ– "è½¬è´¦"
    if (data.description.includes("è·å¾—æŠ¥é…¬") || data.description.includes("å…¥è´¦")) {
        // ç®€å•çš„æ­£åˆ™æå–æ•°å­—ï¼Œæˆ–è€…è®©AIä»¥åæ˜ç¡®è¿”å› money å­—æ®µã€‚
        // æš‚æ—¶æˆ‘ä»¬è®©AIè‡ªç”±å‘æŒ¥ï¼Œè¿™é‡Œåªåšè§†è§‰æç¤ºï¼Œæ•°å€¼ç”±AIä¸‹æ¬¡è¯»å–æ—¶æ›´æ–°ï¼ˆå¦‚æœAIæ²¡æ”¹ï¼Œæˆ‘ä»¬æ‰‹åŠ¨åŠ ä¸€ç‚¹ä½ä¿ï¼‰
        // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬ç»™ä¸ªä½ä¿ï¼š
        gameState.money += 100; 
        data.description += `\n<span style="color:var(--accent-glitch)">[ Â¥ èµ„é‡‘å˜åŠ¨ ]</span>`;
    }


    // çŠ¶æ€åˆ‡æ¢ï¼šç­‰å¾… -> å°±ç»ª
    avgState.isWaitingForAI = false;
    avgState.isReadyToPlay = true;
    avgState.pendingChoices = [];
    avgState.tempData = data; 

    // ã€ä¿®å¤ã€‘ç¡®ä¿é€‰é¡¹å±‚æ˜¯å…³é—­ä¸”ç©ºçš„ï¼Œé˜²æ­¢UIç©¿æ¨¡
    const choicesLayer = document.getElementById('choices-layer');
    choicesLayer.classList.remove('active');
    choicesLayer.innerHTML = ''; 

    // è§†è§‰åé¦ˆ
    const textEl = document.getElementById('main-text');
    textEl.innerHTML = `<span style="color: var(--accent-glitch); animation: blink 0.5s infinite;">[ ä¿¡å·å·²æ•è· / ç‚¹å‡»è¯»å– ]</span>`;
    document.getElementById('click-arrow').classList.add('show');
}

function startPlayingText(data) {
    let rawText = data.description.replace(/<br>/g, "\n");
    
    // === æ ¸å¿ƒä¿®å¤ï¼šä¿æŠ¤ HTML æ ‡ç­¾ä¸è¢«æ ‡ç‚¹ç¬¦å·åˆ‡ç¢ ===
    // 1. å…ˆæŠŠæ‰€æœ‰çš„ <span...>...</span> æå–å‡ºæ¥ï¼Œç”¨å ä½ç¬¦ä»£æ›¿
    const htmlTags = [];
    rawText = rawText.replace(/<span[^>]*>.*?<\/span>/g, (match) => {
        htmlTags.push(match);
        return `___HTML_PROTECT_${htmlTags.length - 1}___`; // ä½¿ç”¨ä¸å«æ ‡ç‚¹çš„å ä½ç¬¦
    });

    // 2. æ‰§è¡ŒåŸæœ‰çš„åˆ†å¥é€»è¾‘ï¼ˆç°åœ¨ä¸ä¼šåˆ‡æ–­HTMLäº†ï¼Œå› ä¸ºå ä½ç¬¦é‡Œæ²¡æ ‡ç‚¹ï¼‰
    let sentences = rawText.match(/[^ã€‚ï¼ï¼Ÿ\n]+[ã€‚ï¼ï¼Ÿ\n]+|[^ã€‚ï¼ï¼Ÿ\n]+$/g) || [rawText];
    
    // 3. æŠŠå ä½ç¬¦è¿˜åŸå› HTML æ ‡ç­¾ï¼Œå¹¶å­˜å…¥é˜Ÿåˆ—
    avgState.textQueue = sentences.map(s => {
        let text = s.trim();
        // æ£€æŸ¥å¹¶è¿˜åŸ
        if (text.includes('___HTML_PROTECT_')) {
            text = text.replace(/___HTML_PROTECT_(\d+)___/g, (m, id) => htmlTags[id]);
        }
        return text;
    }).filter(s => s.length > 0);
    
    // é‡ç½®çŠ¶æ€
    avgState.pendingChoices = data.choices || []; 
    document.getElementById('choices-layer').innerHTML = ''; 
    document.getElementById('choices-layer').classList.remove('active');
    document.getElementById('click-arrow').classList.remove('show');
    
    nextText(); 
}

function nextText() {
    if (avgState.isWaitingForAI) return;

    if (avgState.isReadyToPlay) {
        avgState.isReadyToPlay = false;
        startPlayingText(avgState.tempData);
        return;
    }

    const textEl = document.getElementById('main-text');
    const arrowEl = document.getElementById('click-arrow');

    // 1. å¦‚æœæ­£åœ¨æ‰“å­—ï¼Œç©å®¶ç‚¹å‡»äº†ï¼Œç¬é—´æ˜¾ç¤ºå…¨å¥
    if (avgState.isTyping) {
        clearInterval(avgState.typingTimer);
        // è¿™é‡Œæ”¹ç”¨ innerHTMLï¼Œé˜²æ­¢æ‰“æ–­æ—¶æ ·å¼å¤±æ•ˆ
        textEl.innerHTML = avgState.currentFullText; 
        avgState.isTyping = false;
        arrowEl.classList.add('show');
        return;
    }

    // 2. é˜Ÿåˆ—é‡Œè¿˜æœ‰è¯æ²¡è¯´å®Œ
    if (avgState.textQueue.length > 0) {
        const nextLine = avgState.textQueue.shift();
        avgState.currentFullText = nextLine;
        
        // === æ ¸å¿ƒä¿®å¤å¼€å§‹ï¼šæ£€æµ‹æ˜¯å¦åŒ…å«HTMLæ ‡ç­¾ ===
        // å¦‚æœè¿™ä¸€è¡Œæ˜¯ä»¥ < å¼€å¤´çš„ï¼ˆæ¯”å¦‚ä»»åŠ¡æ›´æ–°ã€è·å¾—ç‰©å“çš„æç¤ºï¼‰ï¼Œè¯´æ˜å®ƒæ˜¯HTMLä»£ç 
        // æˆ‘ä»¬ç›´æ¥ç”¨ innerHTML æ¸²æŸ“å®ƒï¼Œè·³è¿‡æ‰“å­—æœºåŠ¨ç”»ï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºä¹±ç 
        if (nextLine.trim().startsWith('<')) {
            textEl.innerHTML = nextLine; 
            // å­˜å…¥æ—¥å¿—æ—¶ï¼ŒæŠŠHTMLæ ‡ç­¾å»æ‰ï¼Œåªç•™çº¯æ–‡æœ¬ï¼Œä¸ç„¶æ—¥å¿—é‡Œä¹Ÿä¼šä¹±ç 
            addToLog(nextLine.replace(/<[^>]+>/g, '')); 
            arrowEl.classList.add('show'); // ç›´æ¥æ˜¾ç¤ºâ€œç»§ç»­â€ç®­å¤´
            return; 
        }
        // === æ ¸å¿ƒä¿®å¤ç»“æŸ ===

        avgState.charIndex = 0;
        avgState.isTyping = true;
        textEl.innerHTML = ""; // æ¸…ç©ºå½“å‰æ–‡æœ¬
        arrowEl.classList.remove('show');
        addToLog(nextLine); // æ™®é€šå¯¹è¯å­˜å…¥æ—¥å¿—

        avgState.typingTimer = setInterval(() => {
            // è¿™é‡Œç”¨ textContent è¿½åŠ å­—ç¬¦ï¼Œé˜²æ­¢æ‰“å­—è¿‡ç¨‹ä¸­æŠŠ HTML æ ‡ç­¾æ‹†æ•£
            textEl.textContent += avgState.currentFullText.charAt(avgState.charIndex);
            avgState.charIndex++;
            if (avgState.charIndex >= avgState.currentFullText.length) {
                clearInterval(avgState.typingTimer);
                avgState.isTyping = false;
                arrowEl.classList.add('show');
            }
        }, 30); // æ‰“å­—é€Ÿåº¦
        return;
    }

    // 3. æ²¡è¯è¯´äº†ï¼Œæ˜¾ç¤ºé€‰é¡¹
    if (!document.getElementById('choices-layer').classList.contains('active')) {
        showChoices(avgState.pendingChoices);
    }
}

function showChoices(choices) {
    const layer = document.getElementById('choices-layer');
    layer.innerHTML = ''; // å†æ¬¡æ¸…ç©ºï¼Œç¡®ä¿å®‰å…¨
    if(!choices || choices.length === 0) {
        choices = [{text: "ç»§ç»­...", action: "continue"}];
    }
    choices.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'pixel-btn';
        let btnText = c.text;
        
        // æ¶ˆè€—æ—¶é—´æç¤º
        if (c.costTime) btnText += ` [â³]`;
        // æ¶ˆè€—é‡‘é’±æç¤º
        if (c.costMoney) btnText += ` [Â¥${c.costMoney}]`;
        // æ£€å®šæç¤º
        if (c.check) btnText += ` [${c.check}]`;

        btn.innerText = btnText;
        btn.onclick = (e) => { e.stopPropagation(); handleChoice(c); };
        layer.appendChild(btn);
    });
    layer.classList.add('active');
}

// --- æ ¸å¿ƒåœºæ™¯é€»è¾‘ ---

async function handleScene(action, extraInfo = "") {
    let prompt = "";
    let isSystemEvent = false;

    // 1. å¼ºåˆ¶å¼€åœºæµç¨‹ (åŒæ—¶ç”Ÿæˆç¬¬ä¸€ä¸ªæ ¸å¿ƒè°œå›¢)
    if (action === "intro_day1") {
        gameState.currentLocation = "404å·äº‹åŠ¡æ‰€";
        // å¼ºåˆ¶è¦æ±‚ç”Ÿæˆ mystery_setup
        prompt = `æ¸¸æˆå¼€å§‹ã€‚ç©å®¶${gameState.player.name}åˆšæ¬è¿›404å·äº‹åŠ¡æ‰€ã€‚
        è¯·æè¿°ç©å®¶æ•´ç†è¡Œææ—¶çš„è¯¡å¼‚æ°›å›´ã€‚
        åŒæ—¶ï¼Œ**å¿…é¡»**ç”Ÿæˆç¬¬ä¸€ä¸ªæ ¸å¿ƒè°œå›¢ï¼ˆMystery Setupï¼‰ã€‚
        è°œå›¢è¦æ±‚ï¼šä¸€ä¸ªå…·ä½“çš„ã€è¯¡å¼‚çš„äº‹ä»¶ï¼ˆå¦‚ï¼šåŠå¤œçš„æ•²é—¨å£°ã€å¢™é‡Œçš„è€é¼ å£°å…¶å®æ˜¯äººå£°ç­‰ï¼‰ã€‚
        è®¾å®šä¸€ä¸ªâ€œçœŸç›¸â€ï¼ˆç©å®¶ä¸å¯è§ï¼‰ï¼Œå¹¶è®¾å®šè§£å†³æœŸé™ï¼ˆ2-4å¤©ï¼‰ã€‚
        **æ³¨æ„ï¼šä¸è¦åœ¨ description æ–‡æœ¬é‡Œå†™â€œ[è§¦å‘è°œå›¢]â€ä¹‹ç±»çš„ç³»ç»Ÿæç¤ºï¼Œåªè¿”å› JSON å­—æ®µå³å¯ï¼ŒUIä¼šè‡ªåŠ¨æ¸²æŸ“æç¤ºæ¡†ã€‚**`;
        isSystemEvent = true;
    } 

    // 2. äº‹åŠ¡æ‰€ç”µè„‘äº¤äº’
    else if (action === "check_email") {
        if (!gameState.mystery.active) {
            // æ²¡æœ‰è°œå›¢æ—¶ï¼Œå¼ºåˆ¶å¼•å¯¼ç”Ÿæˆæ–°è°œå›¢
            prompt = `ç©å®¶æŸ¥çœ‹äº†ç”µè„‘é‚®ä»¶ã€‚è¯·ç”Ÿæˆä¸€ä¸ªæ–°çš„å§”æ‰˜æˆ–æ€ªè°ˆï¼Œå¹¶**å¿…é¡»**è¿”å› mystery_setup å­—æ®µæ¥å¼€å¯è¿™ä¸ªæ–°è°œå›¢ã€‚
            æè¿°é‚®ä»¶çš„å†…å®¹ï¼Œè¶Šè¯¡å¼‚è¶Šå¥½ã€‚`;
        } else {
            // æœ‰è°œå›¢æ—¶ï¼Œæä¾›çº¿ç´¢
            prompt = `ç©å®¶åˆ©ç”¨ç”µè„‘æŸ¥è¯¢å…³äºâ€œ${gameState.mystery.title}â€çš„èµ„æ–™ã€‚
            è¯·æ ¹æ®çœŸç›¸â€œ${gameState.mystery.truth}â€ï¼Œæä¾›ä¸€æ¡ç›¸å…³çš„çº¿ç´¢ï¼ˆnew_clueï¼‰ã€‚`;
        }
    }

    // 3. ç§»åŠ¨é€»è¾‘
    else if (action === "move") {
        const oldLocation = gameState.currentLocation;
        gameState.currentLocation = extraInfo;
        prompt = `ç©å®¶å†³å®šç¦»å¼€ã€${oldLocation}ã€‘ï¼Œå‰å¾€ã€${extraInfo}ã€‘ã€‚
        è¯·æŒ‰ä»¥ä¸‹é€»è¾‘ç”Ÿæˆå‰§æƒ…ï¼š
        1. æè¿°ç§»åŠ¨è¿‡ç¨‹ã€‚
        2. æè¿°æŠµè¾¾ã€${extraInfo}ã€‘åçš„æ™¯è±¡ã€‚
        å½“å‰æ—¶é—´ï¼š${TIME_PHASES[gameState.timePhase]}ã€‚`;
        if (gameState.timePhase === 3) prompt += " å¤œæ™šå……æ»¡äº†å±é™©æ°”æ¯ã€‚";
    }
    // 4. ç¡è§‰ç»“ç®— (åŒ…å«è°œå›¢æˆªæ­¢æ—¥åˆ¤å®š)
    else if (action === "sleep") {
        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æˆªæ­¢æ—¥æœŸ
        if (gameState.mystery.active && gameState.day >= gameState.mystery.deadlineDay) {
            // è§¦å‘å¼ºåˆ¶ç»“ç®—
            handleScene('resolve_mystery_check');
            return; // ä¸­æ–­æ™®é€šç¡è§‰é€»è¾‘
        }

        // æ™®é€šç¡è§‰
        gameState.stats.hp = Math.min(gameState.stats.maxHp, gameState.stats.hp + 30);
        gameState.stats.san = Math.min(gameState.stats.maxSan, gameState.stats.san + 15);
        gameState.day++;
        gameState.timePhase = 0;
        updateStatsUI();
        prompt = `ç©å®¶ç¡äº†ä¸€è§‰ï¼Œåº¦è¿‡äº†å¹³å®‰å¤œã€‚ç°åœ¨æ˜¯ç¬¬${gameState.day}å¤©ä¸Šåˆã€‚æè¿°é†’æ¥çš„æ„Ÿè§‰ã€‚`;
    }
    // === æ–°å¢ï¼šè°œå›¢ç»“ç®—åˆ¤å®š ===
    else if (action === "resolve_mystery_check") {
        isSystemEvent = true;
        // è®©AIæ ¹æ®ç©å®¶çš„å†å²è¡Œä¸ºåˆ¤æ–­æ˜¯å¦è§£å¼€äº†è°œé¢˜
        prompt = `ã€æ ¸å¿ƒè°œå›¢ç»“ç®—æ—¶åˆ»ã€‘
        å½“å‰è°œå›¢ï¼š${gameState.mystery.title}
        è®¾å®šçœŸç›¸ï¼š${gameState.mystery.truth}
        
        è¯·å›é¡¾ç©å®¶æœ€è¿‘å‡ å¤©çš„è°ƒæŸ¥è®°å½•ï¼ˆHistoryï¼‰ï¼Œåˆ¤æ–­ç©å®¶æ˜¯å¦å·²ç»å‘ç°äº†çœŸç›¸æˆ–è§£å†³äº†æºå¤´ã€‚
        
        è¯·ä¸¥æ ¼è¿”å›JSONï¼ŒåŒ…å« "mystery_result": { "success": true/false, "reason": "..." }ã€‚
        å¹¶æè¿°ç»“ç®—å‰§æƒ…ï¼š
        - å¦‚æœæˆåŠŸï¼šæè¿°ç©å®¶å¦‚ä½•æ­ç©¿äº†çœŸç›¸ï¼Œæˆ–è€…åœ¨æ¢¦ä¸­å‡»è´¥äº†æ¢¦é­‡ã€‚
        - å¦‚æœå¤±è´¥ï¼šæè¿°çœŸç›¸å¦‚ä½•åå™¬äº†ç©å®¶ï¼ˆä¾‹å¦‚ï¼šæ•²é—¨å£°å˜æˆäº†ç ´é—¨è€Œå…¥ï¼Œæˆ–è€…ç©å®¶è¢«æŸç§è¯…å’’ç¼ èº«ï¼‰ï¼Œå¹¶ç»™äºˆæƒ©ç½šã€‚
        
        æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæ—¶é—´éƒ½ä¼šè¿›å…¥ç¬¬äºŒå¤©ã€‚`;
        
        // ç»“ç®—åå¼ºåˆ¶è¿‡ä¸€å¤©
        gameState.day++;
        gameState.timePhase = 0;
    }
    // === è‡ªç”±è¡ŒåŠ¨åˆ¤å®šé€»è¾‘ ===
    else if (action === "judge_action") {
        isSystemEvent = true;
        prompt = `ç©å®¶æƒ³è¦æ‰§è¡Œè‡ªç”±è¡ŒåŠ¨ï¼šã€${extraInfo}ã€‘ã€‚
        è¯·åˆ¤æ–­è¯¥è¡ŒåŠ¨æ˜¯å¦éœ€è¦è¿›è¡Œå±æ€§æ£€å®šã€‚
        è¯·ä¸¥æ ¼è¿”å›JSONæ ¼å¼ï¼š{"check_needed": "PHY"|"DEX"|"INT"|"CHA"|"MYS"|"NONE", "reason": "..."}`;
    }
    // === åˆ¤å®šåæ‰§è¡Œé€»è¾‘ ===
    else if (action === "resolve_action") {
        prompt = `ç©å®¶æ‰§è¡Œäº†è¡ŒåŠ¨ã€‚${extraInfo}ã€‚
        è¯·æ ¹æ®è¿™ä¸ªç»“æœç”Ÿæˆç²¾å½©çš„å‰§æƒ…æè¿°ã€‚å¦‚æœå¤±è´¥ï¼Œè¯·æè¿°åæœã€‚`;
    }
    // === æ— åˆ¤å®šè‡ªç”±è¡ŒåŠ¨ ===
    else if (action === "free_action") {
        prompt = `ç©å®¶æ‰§è¡Œäº†è‡ªç”±è¡ŒåŠ¨ï¼šã€${extraInfo}ã€‘ã€‚
        è¯·ç›´æ¥æè¿°ç©å®¶çš„è¡Œä¸ºå’Œç»“æœã€‚`;
    }
    // 5. é€šç”¨å‰§æƒ…
    else {
        prompt = `ç©å®¶é€‰æ‹©äº†ï¼š${extraInfo}ã€‚ç»§ç»­å‰§æƒ…ã€‚`;
    }

    // æ¶ˆè€—æ—¶é—´é€»è¾‘
    if (action === "work" || action === "explore") {
        advanceTime();
    }

    // UI çŠ¶æ€åˆ‡æ¢
    avgState.isWaitingForAI = true;
    avgState.pendingChoices = [];
    document.getElementById('main-text').innerHTML = `<span style="animation: blink 1s infinite;">æ­£åœ¨è¿æ¥çµç•Œä¿¡å·...</span>`;
    
    // ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶æ¸…ç©ºæ—§æŒ‰é’®ï¼Œé˜²æ­¢å›å¼¹ï¼
    const choicesLayer = document.getElementById('choices-layer');
    choicesLayer.classList.remove('active');
    choicesLayer.innerHTML = ''; 

    document.getElementById('click-arrow').classList.remove('show');

    // === è°ƒç”¨ AI ===
    const result = await callAI(prompt, isSystemEvent);
    
    // === åˆ¤å®šé€»è¾‘åˆ†æ”¯å¤„ç† ===
    if (action === "judge_action") {
        avgState.isWaitingForAI = false; // åˆ¤å®šç»“æŸï¼Œå‡†å¤‡ä¸‹ä¸€æ­¥
        
        if (result && result.check_needed && result.check_needed !== "NONE") {
            // éœ€è¦æ£€å®šï¼šè§¦å‘éª°å­åŠ¨ç”»
            const checkObj = {
                text: extraInfo, // åŸå§‹è¡ŒåŠ¨æ–‡æœ¬
                action: 'resolve_action', // ä¸‹ä¸€æ­¥åŠ¨ä½œ
                check: result.check_needed // éœ€è¦çš„å±æ€§
            };
            // å»¶è¿Ÿä¸€ç‚¹ç‚¹è®©ç©å®¶çœ‹åˆ°â€œåˆ¤å®šä¸­â€
            document.getElementById('main-text').innerText = `[ ç³»ç»Ÿåˆ¤å®š: éœ€è¦ ${result.check_needed} æ£€å®š ]`;
            setTimeout(() => performDiceRoll(checkObj), 500);
        } else {
            // ä¸éœ€è¦æ£€å®šï¼šç›´æ¥æ‰§è¡Œ
            handleScene('free_action', extraInfo);
        }
        return; // åˆ¤å®šè¯·æ±‚ä¸ç›´æ¥ç”Ÿæˆå‰§æƒ…ï¼Œç›´æ¥è¿”å›
    }

    // === å¸¸è§„å‰§æƒ…å¤„ç† ===
    if (result) processSceneData(result);
    else {
        avgState.isWaitingForAI = false;
        document.getElementById('main-text').innerText = "è¿æ¥æ–­å¼€ã€‚";
        showChoices([{text: "é‡è¯•", action: action}]);
    }
}

function advanceTime() {
    if (gameState.timePhase < 3) {
        gameState.timePhase++;
        updateStatsUI();
    }
}

async function handleChoice(choice) {
    // 1. æ£€æŸ¥é‡‘é’±
    if (choice.costMoney && gameState.money < choice.costMoney) {
        alert("èµ„é‡‘ä¸è¶³ï¼");
        return;
    }
    
    // 2. æ£€æŸ¥æ—¶é—´
    if (choice.costTime && gameState.timePhase >= 3) {
        alert("å¤ªæ™šäº†ï¼Œå¿…é¡»å…ˆä¼‘æ¯ã€‚");
        return;
    }

    // 3. æ‰£é™¤é‡‘é’± (å¦‚æœæœ‰)
    if (choice.costMoney) {
        gameState.money -= choice.costMoney;
        updateStatsUI();
    }

    // 4. å±æ€§æ£€å®šé€»è¾‘ (ä¿®æ”¹ç‚¹ï¼šæ‹¦æˆªå¹¶æ’­æ”¾åŠ¨ç”»)
    if (choice.check) {
        // è¿™é‡Œçš„ return éå¸¸é‡è¦ï¼Œå®ƒæ‰“æ–­äº†ç›´æ¥å‘é€è¯·æ±‚ï¼Œè½¬è€Œå»æ‰§è¡Œ performDiceRoll
        performDiceRoll(choice); 
        return; 
    } 
    
    // 5. å¦‚æœæ²¡æœ‰æ£€å®šï¼Œç›´æ¥æ‰§è¡Œæ™®é€šå‰§æƒ…
    handleScene(choice.action, choice.text);
}

// --- æ–°å¢ï¼šéª°å­åŠ¨ç”»é€»è¾‘ ---
function performDiceRoll(choice) {
    const layer = document.getElementById('dice-layer');
    const valEl = document.getElementById('dice-val');
    const resEl = document.getElementById('dice-result');
    const targetEl = document.getElementById('target-val');
    const attrEl = document.getElementById('check-attr');
    const box = document.getElementById('dice-box');

    const attr = choice.check.toLowerCase();
    const statVal = gameState.stats[attr] || 10;

    // åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
    layer.style.display = 'flex';
    resEl.innerText = '';
    box.style.borderColor = 'var(--fg)';
    box.style.transform = 'scale(1)';
    valEl.style.color = 'var(--fg)';
    targetEl.innerText = statVal;
    attrEl.innerText = choice.check;

    // åŠ¨ç”»é˜¶æ®µï¼šæ•°å­—ç‹‚è·³
    let count = 0;
    const maxCount = 15; // è·³åŠ¨æ¬¡æ•°
    const interval = setInterval(() => {
        valEl.innerText = Math.floor(Math.random() * 20) + 1;
        count++;
        // å¢åŠ ä¸€ç‚¹éšæœºéœ‡åŠ¨æ„Ÿ
        box.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        if(count >= maxCount) {
            clearInterval(interval);
            finalizeRoll(choice, statVal);
        }
    }, 60); // 60msè·³ä¸€æ¬¡
}

function finalizeRoll(choice, statVal) {
    const roll = Math.floor(Math.random() * 20) + 1; // çœŸæ­£çš„å‘½è¿ä¸€æ·
    const success = roll <= statVal; // D20è§„åˆ™ï¼šå°äºç­‰äºå±æ€§å€¼ç®—æˆåŠŸ
    
    const valEl = document.getElementById('dice-val');
    const resEl = document.getElementById('dice-result');
    const box = document.getElementById('dice-box');

    valEl.innerText = roll;
    box.style.transform = 'rotate(0deg)';

    // è§†è§‰åé¦ˆ
    if(success) {
        resEl.innerText = "SUCCESS";
        resEl.style.color = "#0f0"; // ç»¿è‰²
        box.style.borderColor = "#0f0";
        valEl.style.color = "#0f0";
        box.style.boxShadow = "0 0 30px rgba(0, 255, 0, 0.3)";
    } else {
        resEl.innerText = "FAILURE";
        resEl.style.color = "#f00"; // çº¢è‰²
        box.style.borderColor = "#f00";
        valEl.style.color = "#f00";
        box.style.boxShadow = "0 0 30px rgba(255, 0, 0, 0.3)";
        // å¤±è´¥éœ‡åŠ¨ç‰¹æ•ˆ
        box.style.animation = "shake 0.5s";
        setTimeout(()=> box.style.animation = "", 500);
    }

    // åœé¡¿ 1.5ç§’ è®©ç©å®¶çœ‹æ¸…ç»“æœï¼Œç„¶åç»§ç»­å‰§æƒ…
    setTimeout(() => {
        document.getElementById('dice-layer').style.display = 'none';
        
        // æ„é€ ç»“æœæ–‡æœ¬
        const resultText = `è¡ŒåŠ¨: ${choice.text} (æ£€å®š${choice.check}: æ·å‡º${roll} / ç›®æ ‡${statVal} -> ${success ? "æˆåŠŸ" : "å¤±è´¥"})`;
        
        // å¦‚æœæ˜¯è‡ªç”±è¡ŒåŠ¨è§¦å‘çš„ï¼ˆactionæ˜¯resolve_actionï¼‰ï¼Œèµ°resolveæµç¨‹
        // å¦‚æœæ˜¯æŒ‰é’®è§¦å‘çš„ï¼ˆactionæ˜¯æ™®é€šå‰§æƒ…keyï¼‰ï¼Œä¹ŸæŠŠç»“æœå¸¦è¿›å»
        // ç»Ÿä¸€è°ƒç”¨ handleSceneï¼ŒæŠŠç»“æœæ‹¼åœ¨ extraInfo é‡Œ
        
        // è¿™é‡Œçš„ choice.action å¯èƒ½æ˜¯ 'resolve_action' (è‡ªç”±è¡ŒåŠ¨) æˆ– 'break_door' (æŒ‰é’®)
        // æ— è®ºå“ªç§ï¼Œæˆ‘ä»¬éƒ½æŠŠç»“æœä¼ ç»™ AI
        handleScene(choice.action, resultText);
        
    }, 1500);
}


// --- 4. äº‹åŠ¡æ‰€äº¤äº’é€»è¾‘ ---
function handleOfficeAction(type) {
    // === ä¿®å¤ï¼šå¢åŠ åœ°ç‚¹æ ¡éªŒï¼Œé˜²æ­¢åœ¨å¤–é¢æ“ä½œäº‹åŠ¡æ‰€è®¾æ–½ ===
    if (gameState.currentLocation !== "404å·äº‹åŠ¡æ‰€") {
        addToLog("ç¦»å¾—å¤ªè¿œäº†ï¼Œæ— æ³•æ“ä½œã€‚");
        alert("ä½ ç°åœ¨ä¸åœ¨äº‹åŠ¡æ‰€ï¼Œæ— æ³•è¿›è¡Œæ­¤æ“ä½œï¼");
        updateStatsUI(); // å¼ºåˆ¶åˆ·æ–°ä¸€ä¸‹UIæŠŠæŒ‰é’®è—èµ·æ¥
        return;
    }

    if (type === 'sleep') {
        if (confirm("ç»“æŸè¿™ä¸€å¤©å¹¶ç¡è§‰ï¼Ÿ(æ¢å¤HP/SAN)")) {
            handleScene('sleep');
        }
}
    else if (type === 'computer') {
        // å¦‚æœå½“å‰æ²¡æœ‰è°œå›¢ï¼Œç”µè„‘æ˜¯è·å–æ–°è°œå›¢çš„ä¸»è¦é€”å¾„
        if (!gameState.mystery.active) {
            handleScene('check_email', 'æŸ¥çœ‹ç”µè„‘ä¸Šçš„å§”æ‰˜é‚®ä»¶ï¼ˆå°è¯•è·å–æ–°è°œå›¢ï¼‰');
        } else {
            // å¦‚æœæœ‰è°œå›¢ï¼Œç”µè„‘å¯èƒ½æä¾›çº¿ç´¢
            handleScene('check_email', 'æŸ¥è¯¢å…³äºå½“å‰è°œå›¢çš„èµ„æ–™');
        }
    }

// --- 5. ç‰©å“æ é€»è¾‘ ---

function showInventory() {
    const list = document.getElementById('inventory-list');
    const msg = document.getElementById('empty-bag-msg');
    list.innerHTML = '';
    
    if (gameState.inventory.length === 0) {
        msg.style.display = 'block';
    } else {
        msg.style.display = 'none';
        const isInsane = gameState.stats.san < 30;

        gameState.inventory.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = `item-card ${isInsane ? 'insane-item' : ''} ${item.type === 'key' ? 'key-item' : ''}`;
            
            const displayName = isInsane && item.desc_insane ? "???" : item.name;
            const displayDesc = isInsane && item.desc_insane ? item.desc_insane : item.desc;

            let actionHtml = '';
            if (item.type === 'consumable') {
                actionHtml = `<button class="pixel-btn" style="font-size:0.8rem; padding:5px;" onclick="useItem(${index})">ä½¿ç”¨</button>`;
            } else {
                actionHtml = `<span style="font-size:0.8rem; color:var(--dim)">[å…³é”®]</span>`;
            }

            card.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${displayName} <span class="item-count">x${item.count}</span></div>
                    <div class="item-desc">${displayDesc}</div>
                </div>
                <div class="item-actions">${actionHtml}</div>
            `;
            list.appendChild(card);
        });
    }
    document.getElementById('inventory-layer').style.display = 'flex';
}

function useItem(index) {
    const item = gameState.inventory[index];
    if (!item) return;

    if (item.effect) {
        if (item.effect.includes("hp+")) {
            const val = parseInt(item.effect.split('+')[1]);
            gameState.stats.hp = Math.min(gameState.stats.maxHp, gameState.stats.hp + val);
            alert(`ä½¿ç”¨äº† ${item.name}ï¼ŒHPæ¢å¤äº† ${val}`);
        }
        if (item.effect.includes("san+")) {
            const val = parseInt(item.effect.split('+')[1]);
            gameState.stats.san = Math.min(gameState.stats.maxSan, gameState.stats.san + val);
            alert(`ä½¿ç”¨äº† ${item.name}ï¼Œç†æ™ºæ¢å¤äº† ${val}`);
        }
    }

    item.count--;
    if (item.count <= 0) {
        gameState.inventory.splice(index, 1);
    }
    updateStatsUI();
    showInventory();
}

// --- 5.5 æ‰‹æœºé€»è¾‘ (ç¾åŒ–å¢å¼ºç‰ˆ) ---

function showPhone() {
    document.getElementById('phone-layer').style.display = 'flex';
    closePhoneApp(); // é»˜è®¤æ˜¾ç¤ºä¸»å±å¹•
    
    // æ›´æ–°çŠ¶æ€æ 
    document.getElementById('phone-time').innerText = `${TIME_PHASES[gameState.timePhase]}`;
    document.getElementById('phone-carrier').innerText = gameState.currentLocation === "404å·äº‹åŠ¡æ‰€" ? "WIFI: 404_GUEST" : "5G";
}

function closePhoneApp() {
    const homeGrid = document.getElementById('phone-home');
    
    // === ä¿®å¤ç‚¹ï¼šæ˜¾å¼åœ°æŠŠ display æ”¹å› gridï¼Œå¦åˆ™å®ƒä¼šä¸€ç›´ä¿æŒ none (ä¸æ˜¾ç¤º) ===
    homeGrid.style.display = 'grid'; 
    
    // ç¨å¾®å»¶è¿Ÿ 10ms å†ç§»é™¤é€æ˜åº¦éšè—ç±»ï¼Œè¿™æ ·èƒ½è®©æ·¡å…¥åŠ¨ç”»ç”Ÿæ•ˆï¼Œçœ‹èµ·æ¥æ›´ä¸æ»‘
    setTimeout(() => {
        homeGrid.classList.remove('hidden');
    }, 10);

    document.getElementById('phone-display-area').style.display = 'none';
}

async function handlePhoneAction(app) {
    const homeGrid = document.getElementById('phone-home');
    const displayArea = document.getElementById('phone-display-area');
    const contentDiv = document.getElementById('phone-content');
    const titleEl = document.getElementById('current-app-title');

    // åˆ‡æ¢è§†å›¾åŠ¨ç”»
    homeGrid.classList.add('hidden');
    setTimeout(() => {
        homeGrid.style.display = 'none';
        displayArea.style.display = 'flex';
    }, 300);

    contentDiv.innerHTML = `<div class="loading-text" style="margin-top:50px;">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>`;
    
    let prompt = "";
    let appName = "";

    // å®šä¹‰ Prompt å’Œ æ ‡é¢˜
    if (app === 'takeout') {
        appName = "é¥±äº†ä¹ˆå¤–å–";
        if (gameState.money < 50) {
            contentDiv.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--accent-red);">âš ï¸ ä½™é¢ä¸è¶³ (éœ€è¦ Â¥50)</div>`;
            return;
        }
        gameState.money -= 50;
        gameState.stats.hp = Math.min(gameState.stats.maxHp, gameState.stats.hp + 10);
        updateStatsUI();
        
        // === ä¼˜åŒ–ç‚¹ï¼šä¸¥å‰ç¦æ­¢æ—ç™½ï¼Œç¡®ä¿å°ç¥¨æ ¼å¼æ•´æ´ ===
        prompt = `ç©å®¶ç‚¹äº†ä¸€ä»½å¤–å–ï¼ˆèŠ±è´¹50å…ƒï¼‰ã€‚è¯·ç”Ÿæˆä¸€ä»½ã€å¤–å–å°ç¥¨å†…å®¹ã€‘ã€‚
        ä¸¥ç¦è¾“å‡ºä»»ä½•ç¯å¢ƒæå†™ã€å‰§æƒ…æ—ç™½ï¼æˆ‘åªè¦å°ç¥¨ä¸Šçš„æ–‡å­—ï¼
        æ ¼å¼è¦æ±‚ï¼š
        ç¬¬ä¸€è¡Œï¼šèœå
        ç¬¬äºŒè¡Œï¼šç®€çŸ­çš„å£æ„Ÿæè¿°ï¼ˆå¥½åƒæˆ–éš¾åƒï¼‰
        ç¬¬ä¸‰è¡Œï¼šåº—é“ºå`;
    } 
    else if (app === 'news') {
        appName = "é›¾å·æ—©æŠ¥";
        prompt = `ç”Ÿæˆä¸€æ¡å…³äºé›¾å·å¸‚çš„ã€æ–°é—»æŠ¥é“ã€‘ã€‚
        æ ¼å¼è¦æ±‚ï¼šç¬¬ä¸€è¡Œæ˜¯æ–°é—»æ ‡é¢˜ï¼ˆéœ‡æƒŠä½“æˆ–ä¸¥è‚ƒä½“ï¼‰ï¼Œå‰©ä½™éƒ¨åˆ†æ˜¯æ­£æ–‡ã€‚å†…å®¹è¦åŒ…å«ä¸€äº›éƒ½å¸‚æ€ªè°ˆæˆ–æ”¿åºœæ©ç›–çœŸç›¸çš„æš—ç¤ºã€‚`;
    }
    else if (app === 'sns') {
        appName = "æ ‘æ´ç¤¾åŒº";
        prompt = `ç”Ÿæˆ3æ¡åŒ¿åçš„ç¤¾äº¤ç½‘ç»œåŠ¨æ€ã€‚
        æ ¼å¼è¦æ±‚ï¼šæ¯æ¡åŠ¨æ€ä¹‹é—´ç”¨ "|||" åˆ†éš”ã€‚å†…å®¹åæ˜ å¸‚æ°‘çš„ç„¦è™‘ã€ç›®å‡»æ€ªç‰©çš„ä¼ é—»æˆ–æ— æ„ä¹‰çš„ç–¯ç‹‚å‘“è¯­ã€‚`;
    }
    else if (app === 'msg') {
        appName = "æœªè¯»çŸ­ä¿¡";
        // === ä¿®æ”¹ç‚¹1ï¼šåŠ å¼º Promptï¼Œç¦æ­¢æ—ç™½ ===
        prompt = `ç”Ÿæˆ2-3æ¡çŸ­ä¿¡ã€‚
        ä¸¥ç¦è¾“å‡ºä»»ä½•ç¯å¢ƒæå†™æˆ–æ—ç™½ï¼ç›´æ¥è¾“å‡ºæ•°æ®ï¼
        æ ¼å¼è¦æ±‚ï¼šæ¯æ¡çŸ­ä¿¡ä¹‹é—´ç”¨ "|||" åˆ†éš”ã€‚
        æ¯æ¡çŸ­ä¿¡ä¸¥æ ¼æ ¼å¼ï¼š[å‘é€è€…åå­—]ï¼š[çŸ­ä¿¡å†…å®¹]ã€‚
        å†…å®¹å¯ä»¥æ˜¯åƒåœ¾å¹¿å‘Šã€ç¥ç§˜äººçš„è­¦å‘Šã€æˆ–è€…å‚¬å€ºä¿¡æ¯ã€‚å…¶ä¸­ä¸€æ¡å¿…é¡»çœ‹èµ·æ¥å¾ˆå±é™©æˆ–ä¹±ç ã€‚`;
    }

    titleEl.innerText = appName;

    // è°ƒç”¨ AI
    const result = await callAI(prompt, true); 
    
    if (result) {
        const text = result.description;
        let html = "";

        // === æ ¹æ®ä¸åŒAPPæ¸²æŸ“ä¸åŒæ¨¡æ¿ ===
        
        // 1. å¤–å–æ¸²æŸ“ (å°ç¥¨é£æ ¼)
        if (app === 'takeout') {
            const lines = text.split('\n').filter(l => l.trim());
            const dish = lines[0] || "æœªçŸ¥è‚‰";
            const desc = lines[1] || "å‘³é“åƒåš¼è¿‡çš„æ§Ÿæ¦”ã€‚";
            const shop = lines[2] || "é»‘å··å­ç¬¬4å·æ‘Šä½";
            
            html = `
                <div class="receipt-card">
                    <div class="receipt-header">=== è®¢å• #89757 ===</div>
                    <div class="receipt-item"><span>${dish}</span><span>x1</span></div>
                    <div class="receipt-item" style="color:#555; font-size:0.8rem;">${desc}</div>
                    <div style="border-bottom:1px dashed #000; margin:10px 0;"></div>
                    <div class="receipt-item"><span>é…é€è´¹</span><span>Â¥5.00</span></div>
                    <div class="receipt-item"><span>æ‰“åŒ…è´¹</span><span>Â¥2.00</span></div>
                    <div class="receipt-total">å®ä»˜: Â¥50.00</div>
                    <div class="receipt-footer">
                        åº—é“º: ${shop}<br>
                        æ„Ÿè°¢æ‚¨çš„æƒ é¡¾<br>
                        <span style="font-size:0.6rem">é£Ÿç‰©ä¸­æ¯’æ¦‚ä¸è´Ÿè´£</span>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px; color:var(--accent-glitch);">
                    [ HP +10 ] [ é¥±è…¹æ„Ÿå·²æ¢å¤ ]
                </div>
            `;
        }
        
        // 2. æ–°é—»æ¸²æŸ“ (æŠ¥çº¸é£æ ¼)
        else if (app === 'news') {
            const lines = text.split('\n');
            const headline = lines[0];
            const body = lines.slice(1).join('<br>');
            
            html = `
                <div class="news-card">
                    <div class="news-headline">${headline}</div>
                    <div class="news-body">${body}</div>
                    <div style="text-align:right; margin-top:10px; font-size:0.8rem; color:var(--dim);">
                        â€”â€” é›¾å·æ—¥æŠ¥ç¤¾ ç¼–è¾‘éƒ¨
                    </div>
                </div>
            `;
        }

        // 3. æ ‘æ´æ¸²æŸ“ (å¸–å­é£æ ¼)
        else if (app === 'sns') {
            // === æ–°å¢ï¼šæ—ç™½æ°›å›´å±‚ (è¿˜åŸä½ çš„è®¾å®š) ===
            // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€æ®µæ–œä½“å­—ä½œä¸ºå¼€åœºï¼Œæ¨¡æ‹Ÿç©å®¶ç›¯ç€å±å¹•çš„å¿ƒç†æ´»åŠ¨
            html += `
                <div style="
                    padding: 5px 5px 20px 5px; 
                    border-bottom: 1px dashed var(--dim); 
                    margin-bottom: 20px; 
                    color: #ccc; 
                    font-family: var(--font-read); 
                    font-size: 1.15rem; 
                    line-height: 1.8; 
                    text-shadow: 0 0 5px rgba(0,0,0,0.8);
                ">
                    ä½ ç†Ÿç»ƒåœ°æ‰“å¼€äº†ç”µè„‘ï¼Œåœ¨å¤„ç†é‚£å°ç¥ç§˜é‚®ä»¶ä¹‹å‰ï¼Œä½ ä¸è‡ªè§‰åœ°ç‚¹å¼€äº†æœ¬åœ°ç¤¾äº¤è®ºå›<span style="color:var(--accent-glitch)">ã€é›¾è¯­ã€</span>çš„åŒ¿åæ¿å—ã€‚å±å¹•çš„å…‰æ˜ åœ¨ä½ ç–²æƒ«çš„è„¸ä¸Šï¼Œå‡ æ¡åˆšåˆ·å‡ºçš„åŠ¨æ€å¼•èµ·äº†ä½ çš„æ³¨æ„ï¼š
                </div>
            `;

            const posts = text.split('|||');
            posts.forEach(post => {
                if(!post.trim()) return;
                const userNames = ["åŒ¿åç”¨æˆ·893", "ç»æœ›çš„æ‰“å·¥äºº", "çœ‹è§äº†çœ¼ç›", "å¸‚æ°‘K", "çŒ«å¥´", "404_GUEST"];
                const randomUser = userNames[Math.floor(Math.random() * userNames.length)];
                const likes = Math.floor(Math.random() * 100);
                
                html += `
                    <div class="sns-post">
                        <div class="sns-user">@${randomUser}</div>
                        <div class="sns-content">${post.trim()}</div>
                        <div class="sns-actions">
                            <span>â¤ï¸ ${likes}</span>
                            <span>ğŸ’¬ ${Math.floor(likes/3)}</span>
                            <span>ğŸ”— åˆ†äº«</span>
                        </div>
                    </div>
                `;
            });
        }

        // 4. çŸ­ä¿¡æ¸²æŸ“ (æ°”æ³¡é£æ ¼ - ä¿®å¤ç‰ˆ)
        else if (app === 'msg') {
            // å…¼å®¹å¤„ç†ï¼šå¦‚æœAIæ²¡ç”¨|||åˆ†å‰²ï¼Œè€Œæ˜¯ç”¨äº†æ¢è¡Œ
            let rawMsgs = text.split('|||');
            if (rawMsgs.length === 1 && text.includes('\n')) {
                rawMsgs = text.split('\n');
            }

            html = `<div class="sms-container">`;
            
            rawMsgs.forEach(msg => {
                msg = msg.trim();
                if(!msg) return;

                // === ä¿®æ”¹ç‚¹2ï¼šæ­£åˆ™è¿‡æ»¤ ===
                // åªæœ‰ç¬¦åˆ [åå­—]:å†…å®¹ æ ¼å¼çš„è¡Œæ‰ä¼šè¢«æ¸²æŸ“
                // è¿™æ ·å°±èƒ½æŠŠ "ä½ çš„æ‰‹æœºå“äº†..." è¿™ç§æ—ç™½è¿‡æ»¤æ‰
                const match = msg.match(/^\[(.*?)\]\s*[:ï¼š]\s*(.*)$/);

                if (match) {
                    const sender = match[1].trim();
                    const body = match[2].trim();
                    
                    // åˆ¤æ–­æ˜¯å¦æ˜¯å±é™©ä¿¡æ¯
                    const isUrgent = sender.includes("è­¦å‘Š") || sender.includes("æœªçŸ¥") || body.includes("æ­»") || body.includes("è·‘") || body.includes("ğŸ‘ï¸");
                    
                    html += `
                        <div class="sms-card ${isUrgent ? 'urgent' : ''}">
                            <div class="sms-sender">
                                <span>${sender}</span>
                                <span class="sms-time">åˆšåˆš</span>
                            </div>
                            <div class="sms-body">${body}</div>
                        </div>
                    `;
                }
                // å¦‚æœä¸åŒ¹é…æ­£åˆ™ï¼ˆæ¯”å¦‚æ˜¯æ—ç™½ï¼‰ï¼Œç›´æ¥ä¸¢å¼ƒï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            });
            html += `</div>`;
        }

        contentDiv.innerHTML = html;
    } else {
        contentDiv.innerHTML = `<div style="text-align:center; color:var(--dim);">[ è¿æ¥è¶…æ—¶ ]</div>`;
    }
}


// --- 6. åœ°å›¾é€»è¾‘ ---

function showMap() {
    const grid = document.getElementById('map-grid');
    grid.innerHTML = '';
    
    gameState.unlockedLocations.forEach(loc => {
        const node = document.createElement('div');
        const isCurrent = loc.name === gameState.currentLocation;
        node.className = `map-node ${isCurrent ? 'current' : ''} ${loc.locked ? 'locked' : ''}`;
        
        let tag = "";
        if (loc.type === 'shop') tag = `<div class="map-tag">å•†åº—</div>`;
        if (loc.type === 'heal') tag = `<div class="map-tag">æ²»ç–—</div>`;
        if (loc.type === 'danger') tag = `<div class="map-tag" style="color:red; border-color:red;">å±é™©</div>`;

        node.innerHTML = `${loc.name} ${isCurrent ? "<br>(å½“å‰)" : ""} ${tag}`;
        
        if (!isCurrent && !loc.locked) {
            node.onclick = () => {
                hideOverlay('map-layer');
                handleScene('move', loc.name);
            };
        }
        grid.appendChild(node);
    });

    document.getElementById('current-location-name').innerText = gameState.currentLocation;
    document.getElementById('map-layer').style.display = 'flex';
}

// --- 7. AI æ¥å£ ---

async function callAI(userPrompt, isSystem = false) {
    // æ„å»ºè®°å¿†æ–‡æœ¬
    const activeQuests = gameState.quests.filter(q => q.active).map(q => q.text).join("; ");
    const knownClues = gameState.clues.join("; ");
    
    // æ„å»ºè°œå›¢ä¿¡æ¯ (AIå¯è§ï¼Œç©å®¶ä¸å¯è§)
    let mysteryContext = "";
    if (gameState.mystery.active) {
        mysteryContext = `
        [â˜… å½“å‰æ ¸å¿ƒè°œå›¢ (æ­£åœ¨è¿›è¡Œä¸­)]
        è°œé¢: ${gameState.mystery.title}
        çœŸç›¸(ç©å®¶æœªçŸ¥): ${gameState.mystery.truth}
        æˆªæ­¢: Day ${gameState.mystery.deadlineDay} (ä»Š: Day ${gameState.day})
        *æŒ‡ä»¤*: æ‰€æœ‰å‰§æƒ…å¿…é¡»æš—ç¤ºæ­¤çœŸç›¸ã€‚ä¸è¦ç›´æ¥æ­éœ²ï¼Œè¦é€šè¿‡çº¿ç´¢å¼•å¯¼ã€‚
        `;
    } else {
        mysteryContext = `
        [â˜… å½“å‰æ— æ ¸å¿ƒè°œå›¢]
        *æŒ‡ä»¤*: ç©å®¶ç›®å‰å¤„äºç©ºçª—æœŸã€‚å¦‚æœç©å®¶æ­£åœ¨ã€æŸ¥çœ‹ç”µè„‘/æ‰‹æœºã€‘ã€ã€é˜…è¯»æŠ¥çº¸ã€‘ã€ã€æ¢ç´¢æ–°åœ°ç‚¹ã€‘æˆ–ã€ä¸å…³é”®NPCå¯¹è¯ã€‘ï¼Œä½ å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ mystery_setup æ¥å¼€å¯æ–°æ¡ˆä»¶ã€‚
        `;
    }

    const systemPrompt = `
    ä½ æ˜¯ä¸€ä¸ªåä¸ºâ€œé›¾å·å¼‚é—»å½•â€çš„æ–‡å­—å†’é™©æ¸¸æˆKPï¼ˆå®ˆå¯†äººï¼‰ã€‚
    é£æ ¼ï¼šç°ä»£éƒ½å¸‚æ€ªè°ˆ, æ—¥å¸¸ç”Ÿæ´»æ¨¡æ‹Ÿ, è½»åº¦å…‹è‹é²ã€‚

    [å½“å‰çŠ¶æ€]
    ç©å®¶ï¼š${gameState.player.name} (${gameState.player.job})
    å±æ€§ï¼šPHY ${gameState.stats.phy}, DEX ${gameState.stats.dex}, INT ${gameState.stats.int}, CHA ${gameState.stats.cha}, MYS ${gameState.stats.mys}
    çŠ¶æ€ï¼šHP:${gameState.stats.hp}, SAN:${gameState.stats.san}, é‡‘é’±:${gameState.money}, å£°æœ›:${gameState.reputation}
    æ—¶é—´ï¼šDay ${gameState.day} - ${TIME_PHASES[gameState.timePhase]}
    åœ°ç‚¹ï¼š${gameState.currentLocation}
    
    [é‡è¦è®°å¿†]
    ä»»åŠ¡ï¼š${activeQuests}
    çº¿ç´¢ï¼š${knownClues}
    ${mysteryContext}
    
    [æ ¸å¿ƒè§„åˆ™]
    1. **å¼ºåˆ¶æ£€å®š**ï¼šæ¶‰åŠé£é™©è¡Œä¸ºå¿…é¡»è¿”å› "check" å­—æ®µã€‚
    2. **ç»è¥è¦ç´ **ï¼šå£°æœ›å½±å“å§”æ‰˜ï¼Œå®Œæˆå§”æ‰˜ç»™äºˆé‡‘é’±ã€‚
    3. **åœ°ç‚¹ç§»åŠ¨**ï¼šç§»åŠ¨æ—¶å¿…é¡»è¿”å› "move_to"ã€‚
    4. **å›å¤æ ¼å¼**ï¼šå¿…é¡»æ˜¯çº¯JSONã€‚
    
    è¯·ä¸¥æ ¼è¿”å›JSONæ ¼å¼ï¼ˆç¤ºä¾‹ï¼‰ï¼š
    {
        "description": "å‰§æƒ…æ–‡æœ¬...",
        "choices": [
            {"text": "é€‰é¡¹A", "action": "...", "check": "INT"}, 
            {"text": "é€‰é¡¹B", "action": "..."}
        ],
        "event": "none" | "san_check",
        "loot": [],
        "unlock_location": "åœ°ç‚¹å",
        "new_clue": "çº¿ç´¢å†…å®¹", 
        "update_quest": "ä»»åŠ¡å†…å®¹",
        "move_to": "æ–°åœ°ç‚¹",
        "mystery_setup": { "title": "è°œé¢˜å", "truth": "çœŸç›¸è®¾å®š", "days_limit": 3 },
        "mystery_result": { "success": true, "reason": "..." }
    }
    `;

    const messages = [
        { role: "system", content: systemPrompt },
        ...(isSystem ? [] : gameState.history.slice(-4)),
        { role: "user", content: userPrompt }
    ];

    try {
        const res = await fetch(`${config.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${config.apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: config.model,
                messages: messages,
                response_format: { type: "json_object" }
            })
        });
        const data = await res.json();
        const content = data.choices[0].message.content;
        if (!isSystem) gameState.history.push({ role: "assistant", content: content });
        
        let jsonStr = content.replace(/```json/g, '').replace(/```/g, '');
        return JSON.parse(jsonStr);
    } catch (e) { console.error(e); return null; }
}

// --- è¾…åŠ©å‡½æ•° ---
function addToLog(text) {
    gameState.log.push(text);
    const logContent = document.getElementById('log-content');
    const entry = document.createElement('div');
    entry.style.marginBottom = "10px";
    entry.style.borderBottom = "1px dashed #333";
    entry.innerText = text;
    logContent.appendChild(entry);
}
function showLog() { document.getElementById('log-layer').style.display = 'flex'; }
function showStatus() { document.getElementById('status-layer').style.display = 'flex'; updateStatsUI(); }
function hideOverlay(id) { document.getElementById(id).style.display = 'none'; }

// --- æ–°å¢ï¼šæ‰‹è®°é€»è¾‘ ---
function showNote() {
    const qList = document.getElementById('quest-list');
    const cList = document.getElementById('clue-list');
    
    // æ¸²æŸ“ä»»åŠ¡
    qList.innerHTML = '';
    
    // === æ–°å¢ï¼šæ ¸å¿ƒè°œå›¢ç½®é¡¶æ˜¾ç¤º ===
    if (gameState.mystery.active) {
        const daysLeft = gameState.mystery.deadlineDay - gameState.day;
        const mysteryDiv = document.createElement('div');
        mysteryDiv.style.cssText = "background: rgba(255,0,0,0.1); border: 1px solid var(--accent-red); padding: 10px; margin-bottom: 15px; color: var(--accent-red);";
        mysteryDiv.innerHTML = `
            <div style="font-weight:bold; margin-bottom:5px;">âš ï¸ æ ¸å¿ƒè°œå›¢: ${gameState.mystery.title}</div>
            <div style="font-size:0.9rem;">è·ç¦»å®¡åˆ¤æ—¥è¿˜å‰©: <span style="font-size:1.2rem; font-weight:bold;">${daysLeft}</span> å¤©</div>
            <div style="font-size:0.8rem; opacity:0.8;">(è¯·åœ¨ Day ${gameState.mystery.deadlineDay} ç¡å‰è§£å†³)</div>
        `;
        qList.appendChild(mysteryDiv);
    }

    const activeQuests = gameState.quests.filter(q => q.active && !q.id.startsWith('mystery_')); // è¿‡æ»¤æ‰è‡ªåŠ¨ç”Ÿæˆçš„mysteryä»»åŠ¡ï¼Œé¿å…é‡å¤
    if (activeQuests.length === 0 && !gameState.mystery.active) {
        qList.innerHTML = '<div style="color:var(--dim)">æš‚æ— æ˜ç¡®ç›®æ ‡ï¼Œè¯·è‡ªç”±æ¢ç´¢ã€‚</div>';
    } else {
        activeQuests.forEach(q => {
            const div = document.createElement('div');
            div.innerHTML = `â¤ ${q.text}`;
            div.style.marginBottom = "8px";
            qList.appendChild(div);
        });
    }

    // æ¸²æŸ“çº¿ç´¢
    if (gameState.clues.length > 0) {
        cList.innerHTML = '';
        gameState.clues.forEach(c => {
            const div = document.createElement('div');
            div.innerHTML = `â€¢ <span style="color:var(--fg)">${c}</span>`;
            div.style.marginBottom = "5px";
            div.style.borderBottom = "1px solid #222";
            cList.appendChild(div);
        });
    }
    
    document.getElementById('note-layer').style.display = 'flex';
}


</script>
</body>
</html>
