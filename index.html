<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›¾å·å¼‚é—»å½•ï¼š404å·äº‹åŠ¡æ‰€</title>
    
    <!-- å…¨å±€å­—ä½“ï¼šFusion Pixel -->
    <link href="https://fontsapi.zeoseven.com/570/main/result.css" onload="this.rel='stylesheet'" rel="preload" as="style" crossorigin />
    <noscript><link rel="stylesheet" href="https://fontsapi.zeoseven.com/570/main/result.css" /></noscript>

    <!-- å¼€åœºç™½å­—ä½“ï¼šMaoken Glitch Serif -->
    <link href="https://fontsapi.zeoseven.com/831/main/result.css" onload="this.rel='stylesheet'" rel="preload" as="style" crossorigin />
    <noscript><link rel="stylesheet" href="https://fontsapi.zeoseven.com/831/main/result.css" /></noscript>

    <style>
        /* === 1-bit åƒç´ ææ€–é£æ ¼å®šä¹‰ === */
        :root {
            --bg: #050505;
            --fg: #e0e0e0;
            --dim: #666666;
            --accent-red: #ff3333;
            --accent-glitch: #0ff;
            --accent-gold: #ffd700;
            --border: 2px solid var(--fg);
            
            /* å­—ä½“å˜é‡å®šä¹‰ */
            --font-pixel: "Fusion Pixel 12px M latin", monospace;
            --font-intro: "Maoken Glitch Serif", serif;
            --font-read: "Fusion Pixel 12px M latin", serif; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--fg);
            /* ä¿®æ”¹ï¼šå…¨å±€åº”ç”¨ Fusion Pixel */
            font-family: "Fusion Pixel 12px M latin";
            font-weight: normal;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-size: 18px; /* ç”µè„‘ç«¯é»˜è®¤å­—ä½“ */
        }

        /* === æ–°å¢ï¼šæ¸¸æˆé”å®šçŠ¶æ€ (ç¦æ­¢æ“ä½œ) === */
        .game-locked {
            pointer-events: none !important; /* ç¦æ­¢ç‚¹å‡» */
            filter: grayscale(100%) brightness(0.5); /* å˜ç°å˜æš— */
            cursor: not-allowed;
            transition: all 0.3s;
        }
        /*å“ªæ€•é”å®šäº†ï¼Œå¯¹è¯æ¡†ä¾ç„¶å¯ä»¥ç‚¹ï¼ˆä¸ºäº†åŠ é€Ÿæ–‡å­—ï¼‰*/
        .game-locked .dialogue-box {
            pointer-events: auto !important; 
            filter: none !important;
            cursor: pointer;
        }


        /* === æ‰‹æœºç«¯å­—ä½“é€‚é…ä¼˜åŒ– === */
        @media screen and (max-width: 768px) {
            body {
                font-size: 14px; /* æ‰‹æœºç«¯ç¼©å°å­—ä½“ï¼Œçœ‹èµ·æ¥æ›´ç²¾è‡´ */
            }
            /* æ‰‹æœºç«¯æŒ‰é’®æ–‡å­—ä¹Ÿå¯ä»¥ç¨å¾®å°ä¸€ç‚¹ */
            .pixel-btn {
                font-size: 1rem; 
                padding: 8px 10px;
            }
            /* æ‰‹æœºç«¯æ ‡é¢˜æ–‡å­—ç¼©å° */
            h1, h2 { font-size: 1.5rem; }
            .logo-text { font-size: 2.5rem; }
            /* å¯¹è¯æ¡†æ–‡å­—å¤§å°è°ƒæ•´ */
            .text-content { font-size: 1.3rem !important; }
        }


        /* æ‰«æçº¿ä¸å™ªç‚¹ */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px; pointer-events: none; z-index: 9998; opacity: 0.3;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 9999; opacity: 0.4;
        }

        /* === é€šç”¨ç»„ä»¶ === */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
            padding: 20px; z-index: 10;
            background: var(--bg);
            opacity: 0; transition: opacity 0.5s ease;
        }
        .screen.active { display: flex; opacity: 1; }

        h1, h2 { text-transform: uppercase; letter-spacing: 2px; text-align: center; margin: 0 0 20px 0; font-weight: normal; }
        
        .pixel-btn {
            background: transparent; color: var(--fg);
            border: var(--border);
            padding: 10px 15px; margin: 5px 0;
            font-family: var(--font-pixel);
            font-size: 1.2rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 0 5px rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
        }
        .pixel-btn:active { transform: scale(0.98); }
        .pixel-btn:disabled { border-color: var(--dim); color: var(--dim); cursor: not-allowed; }
        .pixel-btn:hover:not(:disabled) { background: var(--fg); color: var(--bg); box-shadow: 0 0 15px var(--fg); }

        .pixel-input {
            width: 100%; background: rgba(255,255,255,0.05); color: var(--fg);
            border: 1px solid var(--dim); padding: 12px;
            font-family: var(--font-read); font-size: 1rem; margin-bottom: 15px;
            border-radius: 0; outline: none;
        }
        .pixel-input:focus { border-color: var(--accent-glitch); box-shadow: 0 0 8px rgba(0,255,255,0.2); }

        /* === 0. å¼€åœºåŠ¨ç”»å±‚ === */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 2rem; cursor: pointer;
        }
        .intro-text {
            /* ä¿®æ”¹ï¼šå¼€åœºç™½åº”ç”¨ Maoken Glitch Serif */
            font-family: "Maoken Glitch Serif"; 
            font-size: 1.8rem; line-height: 1.6;
            max-width: 800px; text-align: left; opacity: 0;
            transform: translateY(20px); transition: all 0.8s ease-out;
            white-space: pre-wrap; text-shadow: 0 0 5px rgba(255,255,255,0.3);
        }
        .intro-text.show { opacity: 1; transform: translateY(0); }
        .highlight-scary { color: var(--accent-red); font-weight: bold; display: inline-block; animation: shake 3s infinite; }
        .highlight-neon { color: #fff; text-shadow: 0 0 10px var(--accent-glitch), 0 0 20px var(--accent-glitch); }
        .intro-hint { position: absolute; bottom: 30px; font-size: 1rem; color: var(--dim); animation: blink 1.5s infinite; }

        /* === 1. æ ‡é¢˜ç”»é¢ === */
        #title-screen { justify-content: center; align-items: center; }
        .logo-box {
            border: 4px double var(--fg); padding: 30px; margin-bottom: 50px;
            text-align: center; position: relative;
            background: rgba(0,0,0,0.8);
        }
        .logo-text { font-size: 3.5rem; letter-spacing: 5px; text-shadow: 2px 2px 0 #333; position: relative; }
        .logo-text::after {
            content: "é›¾å·å¼‚é—»å½•"; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.5; color: var(--accent-glitch); z-index: -1; animation: glitch-anim 2.5s infinite;
        }

        /* === 2. è®¾ç½®å¼¹çª— === */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 30000;
            display: none; flex-direction: column; padding: 20px; justify-content: center;
        }
        .status-msg { font-size: 0.9rem; margin-top: 10px; min-height: 1.2em; font-family: var(--font-pixel); }
        .success { color: #0f0; } .error { color: #f00; }

        /* === 3. è§’è‰²åˆ›å»º & æ¡£æ¡ˆç”Ÿæˆ === */
        #char-screen { justify-content: center; }
        .form-container { max-width: 500px; margin: 0 auto; width: 100%; }
        label { display: block; margin-bottom: 5px; color: var(--dim); font-size: 0.9rem; }
        
        /* æ¡£æ¡ˆå¡ç‰‡æ ·å¼ */
        #persona-screen { 
            justify-content: center; 
            align-items: center; 
            overflow-y: auto; /* å¢åŠ æ»šåŠ¨ï¼Œé˜²æ­¢å¡ç‰‡å¤ªé•¿è¶…å‡ºå±å¹• */
            padding: 40px 20px; 
        }
        .dossier-card {
            border: 2px solid var(--fg); 
            padding: 35px; /* å†…è¾¹è·åŠ å¤§ï¼Œå‘¼å¸æ„Ÿæ›´å¼º */
            width: 100%; 
            max-width: 700px; /* å®½åº¦åŠ å¤§ï¼Œè®©é˜…è¯»æ›´èˆ’é€‚ */
            background: rgba(10,10,10,0.98); /* èƒŒæ™¯æ›´æ·±ä¸€ç‚¹ */
            position: relative;
            box-shadow: 0 0 40px rgba(255,255,255,0.1); /* é˜´å½±åŠ é‡ */
            display: none;
            margin: auto;
        }
        .dossier-header { 
            border-bottom: 3px solid var(--fg); /* çº¿æ¡åŠ ç²— */
            padding-bottom: 15px; 
            margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .dossier-title { 
            font-size: 2.2rem; /* æ ‡é¢˜æ˜¾è‘—åŠ å¤§ */
            font-weight: bold; 
            background: var(--fg); 
            color: var(--bg); 
            padding: 5px 15px; 
            letter-spacing: 2px;
        }
        .dossier-body { 
            font-family: var(--font-pixel); /* ç»Ÿä¸€ç”¨åƒç´ å­—ä½“ï¼Œæ¸…æ™°åº¦æ›´é«˜ */
            line-height: 1.9; /* è¡Œé«˜åŠ å¤§ï¼Œé˜²æ­¢æ–‡å­—æŒ¤åœ¨ä¸€èµ· */
            font-size: 1.4rem; /* æ­£æ–‡æ˜¾è‘—åŠ å¤§ï¼ */
            margin-bottom: 35px; 
            text-align: justify; /* ä¸¤ç«¯å¯¹é½ */
            color: #eee;
        }
        
        /* å±æ€§ç½‘æ ¼ */
        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; /* é—´è·åŠ å¤§ */
            border-top: 2px dashed var(--dim); padding-top: 25px;
        }
        .stat-item { 
            display: flex; justify-content: space-between; align-items: center; 
            font-family: var(--font-pixel); 
            font-size: 1.5rem; /* å±æ€§æ–‡å­—åŠ å¤§ */
        }
        .stat-label { color: var(--dim); }
        .stat-value { color: var(--accent-glitch); font-weight: bold; font-size: 1.6rem; }
        .stat-mys { color: #a0f; text-shadow: 0 0 8px #a0f; }

        .loading-text { font-size: 1.5rem; animation: blink 0.5s infinite; text-align: center; }

        /* === 4. æ¸¸æˆä¸»ç•Œé¢ (AVG) === */
        #game-screen { padding: 0; }
        .top-bar {
            height: 70px; border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; font-size: 1.1rem; background: #000;
            z-index: 30; /* é¡¶æ å±‚çº§æœ€é«˜ */
            position: relative;
        }
        .bar-left { display: flex; flex-direction: column; justify-content: center; }
        .time-box { font-size: 1.2rem; color: var(--accent-gold); display: flex; align-items: center; gap: 5px; }
        .hp-san-box { display: flex; gap: 10px; font-family: var(--font-pixel); font-size: 0.9rem; color: var(--dim); }
        .val-label { color: var(--fg); font-weight: bold; }
        .money-label { color: var(--accent-glitch); margin-left: 10px; }
        
        .menu-btn {
            background: none; border: 1px solid var(--dim); color: var(--fg);
            cursor: pointer; font-family: var(--font-pixel); padding: 5px 8px;
            font-size: 1rem; text-transform: uppercase;
        }
        .menu-btn:hover { border-color: var(--fg); color: var(--accent-glitch); }

        .visual-area {
            flex: 1; 
            /* ä¿®æ”¹ï¼šä¸å†å¼ºåˆ¶å±…ä¸­ï¼Œæ”¹ä¸ºç›¸å¯¹å®šä½å¸ƒå±€ */
            display: block; 
            border-bottom: var(--border); 
            background: #111; 
            position: relative; 
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }
        /* å›¾ç‰‡é®ç½© */
        .visual-area::before {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); /* è°ƒä½ä¸€ç‚¹é€æ˜åº¦ï¼Œè®©å›¾æ›´äº®ä¸€ç‚¹ */
            z-index: 1;
        }
        
        /* ä¿®æ”¹ï¼šåœ°ç‚¹æ ‡é¢˜æ”¹ä¸ºå·¦ä¸Šè§’æ‚¬æµ®æ ‡ç­¾ */
        .scene-title { 
            z-index: 5; 
            position: absolute; 
            top: 15px; 
            left: 15px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid var(--dim);
            padding: 5px 15px;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--accent-glitch);
            box-shadow: 2px 2px 0 #000;
        }

        /* äº‹åŠ¡æ‰€ä¸“ç”¨UI */
        .office-hud {
            position: absolute; bottom: 15px; right: 15px;
            display: none; gap: 10px;
            z-index: 5; /* ä¿è¯åœ¨é®ç½©ä¹‹ä¸Š */
        }
        .office-hud.active { display: flex; }

        .dialogue-box {
            height: 40%; min-height: 250px; 
            padding: 40px; /* å†…è¾¹è·åŠ å¤§ï¼Œæ–‡å­—ä¸è´´è¾¹ */
            display: flex; flex-direction: column; position: relative; cursor: pointer;
            background: #000;
            z-index: 20; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
        }
        .speaker-name {
            position: absolute; 
            top: -24px; /* é…åˆå¤§å­—å·ï¼Œä½ç½®ä¸Šç§» */
            left: 30px;
            background: var(--bg); border: var(--border);
            padding: 5px 20px; /* åå­—æ¡†åŠ å®½ */
            font-weight: bold; 
            font-size: 1.4rem; /* åå­—åŠ å¤§ */
            z-index: 25; 
            letter-spacing: 2px; /* åå­—å­—é—´è·æ‹‰å¼€ï¼Œæ›´æœ‰æ°”åŠ¿ */
        }
        .text-content { 
            font-family: var(--font-read); 
            font-size: 1.6rem; /* === æ ¸å¿ƒä¿®æ”¹ï¼šæ­£æ–‡æ˜¾è‘—åŠ å¤§ï¼ === */
            line-height: 1.6; /* è¡Œé«˜é€‚é…å¤§å­—å· */
            flex: 1; 
            letter-spacing: 1px; /* å¢åŠ å­—é—´è·ï¼Œé˜²æ­¢åƒç´ å­—ç²˜è¿ */
            color: #eee; /* å­—ä½“é¢œè‰²æäº® */
            text-shadow: 2px 2px 0 #000; /* åŠ ä¸€ç‚¹é˜´å½±ï¼Œè®©å­—æ›´ç«‹ä½“ */
        }
        .click-indicator { text-align: right; animation: blink 1s infinite; font-size: 1.5rem; margin-top: 10px; visibility: hidden; color: var(--accent-glitch); }
        .click-indicator.show { visibility: visible; }

        .choices-overlay {
            position: absolute; 
            top: 45%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 90%; 
            max-width: 500px; 
            bottom: auto !important; 
            background: rgba(0,0,0,0.98); 
            padding: 25px;
            border: var(--border); 
            display: none; 
            flex-direction: column; 
            gap: 12px;
            z-index: 100; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8); 
        }

        .choices-overlay.active { display: flex; }

        /* === 5. è¦†ç›–å±‚ (çŠ¶æ€/ç‰©å“/åœ°å›¾) === */
        .overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; padding: 20px;
        }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--fg); padding-bottom: 10px; }
        .overlay-content { flex: 1; overflow-y: auto; padding-right: 5px; }
        
        /* ç‰©å“æ æ ·å¼ */
        .inventory-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .item-card { 
            border: 1px solid var(--dim); padding: 10px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.05);
        }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.1rem; color: var(--accent-glitch); }
        .item-desc { font-size: 0.9rem; color: #aaa; font-family: var(--font-read); margin-top: 5px; }
        .item-count { font-size: 0.9rem; color: var(--dim); margin-left: 5px; }
        .item-actions { margin-left: 10px; }
        
        .insane-item .item-name { color: var(--accent-red); animation: shake 2s infinite; }
        .insane-item .item-desc { color: #844; font-style: italic; letter-spacing: 1px; }
        .key-item { border-color: #a0f; }
        .key-item .item-name { color: #a0f; }

        /* åœ°å›¾æ ·å¼ - æ ‘çŠ¶ç›®å½•ç»“æ„æ”¹é€  */
        .map-container {
            display: flex; flex-direction: column; gap: 5px;
            padding-left: 10px;
        }

        /* æ ‘çš„åˆ†æ”¯å®¹å™¨ */
        .map-branch {
            position: relative;
            margin-left: 20px;
            border-left: 2px dashed var(--dim); /* ç«–çº¿ */
        }

        /* èŠ‚ç‚¹æœ¬èº« */
        .map-node {
            position: relative;
            margin-bottom: 8px;
            padding: 8px 12px;
            border: 1px solid var(--dim);
            background: rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: space-between;
            font-family: var(--font-pixel);
        }

        /* æ ¹èŠ‚ç‚¹ï¼ˆä¸€çº§åœ°ç‚¹ï¼‰ä¸éœ€è¦å·¦è¾¹è·å¤ªå¤§ */
        .map-root > .map-node {
            border: 2px solid var(--fg);
            background: rgba(255,255,255,0.05);
            margin-left: 0;
        }

        /* å­èŠ‚ç‚¹çš„è¿æ¥æ¨ªçº¿ â”œâ”€â”€ */
        .map-branch > .map-node::before {
            content: "";
            position: absolute;
            left: -22px; /* çº¿æ¡å‘å·¦ä¼¸å‡º */
            top: 50%;
            width: 20px;
            height: 2px;
            background: var(--dim);
        }

        /* äº¤äº’æ•ˆæœ */
        .map-node:hover {
            border-color: var(--accent-glitch);
            color: var(--accent-glitch);
            transform: translateX(5px);
        }
        
        /* å½“å‰æ‰€åœ¨åœ°é«˜äº® */
        .map-node.current {
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
            color: var(--accent-gold);
        }
        .map-node.current::after {
            content: "ğŸ“"; margin-left: 10px;
        }

        .map-node.locked {
            opacity: 0.5; cursor: not-allowed; border-style: dashed;
        }

        /* æ ‡ç­¾å¾®è°ƒ */
        .map-tag {
            font-size: 0.7rem; padding: 1px 4px; margin-left: 8px;
            border: 1px solid currentColor; border-radius: 2px;
        }
        .tag-danger { color: #ff3333; border-color: #ff3333; }
        .tag-shop { color: var(--accent-gold); border-color: var(--accent-gold); }
        .tag-safe { color: #0f0; border-color: #0f0; }
        .tag-new { color: var(--accent-glitch); border-color: var(--accent-glitch); animation: blink 1s infinite; }

        /* æ‰‹æœºç•Œé¢æ ·å¼ (ç¾åŒ–ç‰ˆ) */
        .app-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
            padding: 20px 10px;
            transition: opacity 0.3s;
        }
        .app-grid.hidden { display: none; opacity: 0; }

        .app-icon {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .app-icon:hover { transform: scale(1.1); }
        .app-symbol {
            width: 55px; height: 55px; border: 2px solid var(--fg); border-radius: 14px;
            display: flex; justify-content: center; align-items: center; font-size: 1.8rem;
            margin-bottom: 8px; background: rgba(255,255,255,0.05);
            box-shadow: 0 4px 0 var(--dim); /* åƒç´ ç«‹ä½“æ„Ÿ */
        }
        .app-icon:active .app-symbol { transform: translateY(4px); box-shadow: none; }
        .app-icon:hover .app-symbol { border-color: var(--accent-glitch); color: var(--accent-glitch); }
        .app-name { font-size: 0.8rem; color: var(--dim); font-family: var(--font-pixel); letter-spacing: 1px; }

        /* æ‰‹æœºåº”ç”¨å†…å®¹å®¹å™¨ */
        #phone-display-area {
            display: none; flex-direction: column; height: 100%;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .app-header {
            display: flex; align-items: center; border-bottom: 1px solid var(--dim);
            padding-bottom: 10px; margin-bottom: 15px;
        }
        .back-btn {
            background: none; border: none; color: var(--accent-glitch); font-family: var(--font-pixel);
            font-size: 1.2rem; cursor: pointer; margin-right: 15px; padding: 0 5px;
        }
        .back-btn:hover { text-decoration: underline; }
        .app-title { font-size: 1.2rem; font-weight: bold; letter-spacing: 2px; }

        /* === å•†åº—ç³»ç»Ÿæ ·å¼ (æ–°å¢) === */
        .shop-hud {
            position: absolute; bottom: 15px; left: 15px; /* æ”¾åœ¨å·¦ä¸‹è§’ï¼Œä¸äº‹åŠ¡æ‰€æŒ‰é’®åŒºåˆ† */
            display: none; gap: 10px;
            z-index: 5;
        }
        .shop-hud.active { display: flex; }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .shop-card {
            border: 2px solid var(--dim); padding: 15px; 
            background: rgba(0,0,0,0.6); position: relative;
            transition: all 0.2s; display: flex; flex-direction: column;
        }
        .shop-card:hover { border-color: var(--accent-gold); background: rgba(255,215,0,0.05); transform: translateY(-2px); }
        
        .shop-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .shop-item-name { font-weight: bold; font-size: 1.2rem; color: #fff; }
        .shop-item-price { color: var(--accent-gold); font-family: var(--font-pixel); font-size: 1.2rem; }
        
        .shop-item-desc { font-size: 0.9rem; color: #aaa; font-family: var(--font-read); flex: 1; margin-bottom: 15px; line-height: 1.4; }
        
        .shop-buy-btn {
            background: transparent; border: 1px solid var(--accent-gold); color: var(--accent-gold);
            padding: 8px; cursor: pointer; font-family: var(--font-pixel); text-transform: uppercase;
            transition: 0.2s; width: 100%;
        }
        .shop-buy-btn:hover { background: var(--accent-gold); color: #000; font-weight: bold; }
        .shop-buy-btn:disabled { border-color: var(--dim); color: var(--dim); cursor: not-allowed; background: transparent; }



        /* === APP ç‰¹å®šæ ·å¼æ¨¡æ¿ (å¤§å­—å·èˆ’é€‚ç‰ˆ) === */
        
        /* 1. çŸ­ä¿¡é£æ ¼ */
        .sms-container { display: flex; flex-direction: column; gap: 20px; } /* é—´è·åŠ å¤§ */
        .sms-card {
            border: 1px solid var(--dim); background: rgba(0,0,0,0.6);
            padding: 20px; /* å†…è¾¹è·åŠ å¤§ */
            position: relative;
            border-left: 4px solid var(--fg);
        }
        .sms-card.urgent { border-color: var(--accent-red); border-left-width: 6px; background: rgba(50,0,0,0.15); }
        .sms-sender { font-size: 1.1rem; /* å­—ä½“åŠ å¤§ */ color: var(--accent-glitch); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .sms-time { color: var(--dim); font-size: 0.9rem; }
        .sms-body { font-family: var(--font-read); font-size: 1.25rem; /* æ­£æ–‡åŠ å¤§ */ line-height: 1.6; color: #ddd; }

        /* 2. æ–°é—»é£æ ¼ */
        .news-card {
            border: 2px double var(--fg); padding: 25px; /* å†…è¾¹è·åŠ å¤§ */ background: #111;
            text-align: justify;
        }
        .news-headline { 
            font-size: 1.6rem; /* æ ‡é¢˜åŠ å¤§ */ font-weight: bold; border-bottom: 1px solid var(--fg); 
            padding-bottom: 12px; margin-bottom: 15px; color: var(--accent-gold);
        }
        .news-body { font-family: var(--font-read); font-size: 1.2rem; /* æ­£æ–‡åŠ å¤§ */ line-height: 1.8; color: #ccc; }

        /* 3. å¤–å–å°ç¥¨é£æ ¼ (ä¿æŒå¤§å°ºå¯¸) */
        .receipt-card {
            background: #fff; color: #000; 
            padding: 35px; 
            font-family: 'Courier New', monospace; width: 100%; 
            max-width: 450px; 
            margin: 20px auto;
            box-shadow: 0 0 25px rgba(255,255,255,0.15); 
            transform: rotate(-1deg);
            font-size: 1.15rem; 
            line-height: 1.5;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1.1rem; } /* æ¡ç›®åŠ å¤§ */
        .receipt-total { border-top: 2px solid #000; margin-top: 15px; padding-top: 10px; text-align: right; font-weight: bold; font-size: 1.4rem; } /* æ€»ä»·åŠ å¤§ */
        .receipt-footer { text-align: center; margin-top: 20px; font-size: 0.9rem; color: #555; }

        /* 4. æ ‘æ´é£æ ¼ */
        .sns-post {
            border-bottom: 1px solid #333; padding: 20px 0; /* é—´è·åŠ å¤§ */
        }
        .sns-user { font-weight: bold; color: #aaa; font-size: 1.1rem; /* ç”¨æˆ·ååŠ å¤§ */ margin-bottom: 8px; }
        .sns-content { font-family: var(--font-read); font-size: 1.25rem; /* å†…å®¹åŠ å¤§ */ color: var(--fg); line-height: 1.6; }
        .sns-actions { margin-top: 12px; font-size: 0.95rem; color: var(--dim); display: flex; gap: 20px; }


        /* çŠ¶æ€é¢æ¿ç‰¹æœ‰æ ·å¼ */
        .status-full-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .attr-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; }
        .attr-name { color: var(--fg); }
        .attr-desc { font-size: 0.8rem; color: var(--dim); margin-left: 10px; }
        .attr-val { color: var(--accent-glitch); font-size: 1.4rem; font-family: var(--font-pixel); }
        
        .status-bio {
            margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed var(--dim);
        }
        .bio-text { font-size: 1rem; color: #aaa; margin-top: 10px; font-style: italic; }

        /* === 11. é€šç”¨åƒç´ å¼¹çª— (æ–°å¢ç¾åŒ–) === */
        .pixel-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 60000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-box {
            background: #000; border: 2px solid var(--fg);
            padding: 5px; /* åŒå±‚è¾¹æ¡†é—´éš” */
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            max-width: 400px; width: 85%;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-inner { 
            border: 1px solid var(--dim); padding: 25px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .modal-text { 
            font-family: var(--font-read); font-size: 1.3rem; 
            margin-bottom: 30px; line-height: 1.6; color: #fff; 
            text-align: center; text-shadow: 0 2px 0 #000;
        }

        /* === æ–°å¢ï¼šéª°å­å¤§æˆåŠŸ/å¤§å¤±è´¥ç‰¹æ•ˆ === */
        
        /* 1. å¤§æˆåŠŸï¼šé‡‘è‰²ä¼ è¯´ (ä¿æŒä¸å˜) */
        .dice-crit-success {
            border-color: #ffd700 !important;
            color: #ffd700 !important;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8), inset 0 0 20px rgba(255, 215, 0, 0.5) !important;
            animation: pulse-gold 0.8s infinite alternate !important;
            text-shadow: 0 0 10px #ffd700;
            background: rgba(255, 215, 0, 0.1) !important;
        }
        @keyframes pulse-gold { from { transform: scale(1); box-shadow: 0 0 30px #ffd700; } to { transform: scale(1.1); box-shadow: 0 0 80px #ffd700; } }

        /* 2. æ™®é€šå¤±è´¥ï¼šé²œçº¢è­¦å‘Š (æ–°å¢) */
        .dice-fail {
            border-color: #ff4444 !important;
            color: #ff4444 !important;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3) !important;
            animation: shake 0.5s !important;
        }

        /* 3. å¤§å¤±è´¥ï¼šæ•…éšœå´©æºƒçº¢ (é‡åšï¼Œå†²å‡»åŠ›MAX) */
        .dice-crit-fail {
            border-color: #ff0000 !important;
            color: #fff !important; /*ä»¥æ­¤åè¡¬çº¢è‰²èƒŒæ™¯*/
            background: #cc0000 !important;
            box-shadow: 0 0 0 5px #000, 0 0 60px rgba(255, 0, 0, 1) !important; /* åŒå±‚è¾¹æ¡†+çº¢å…‰ */
            animation: glitch-violent 0.3s infinite !important;
            text-shadow: 2px 0 #000, -2px 0 #000, 0 2px #000, 0 -2px #000; /* é»‘è‰²æè¾¹ */
            transform: scale(1.1);
        }

        /* æ•…éšœåŠ¨ç”»ï¼šç–¯ç‹‚ä½ç§»+å½¢å˜ */
        @keyframes glitch-violent {
            0% { clip-path: inset(20% 0 80% 0); transform: translate(-2px, 2px) scale(1.1); }
            20% { clip-path: inset(60% 0 10% 0); transform: translate(2px, -2px) scale(1.1); }
            40% { clip-path: inset(40% 0 50% 0); transform: translate(-2px, 2px) rotate(2deg) scale(1.15); }
            60% { clip-path: inset(80% 0 5% 0); transform: translate(2px, -2px) rotate(-2deg) scale(1.15); }
            80% { clip-path: inset(10% 0 60% 0); transform: translate(1px, 2px) scale(1.1); }
            100% { clip-path: inset(30% 0 30% 0); transform: translate(0) scale(1.1); }
        }

        /* å±å¹•çº¢è‰²é—ªçƒç‰¹æ•ˆ */
        .screen-flash-red {
            animation: flash-red-anim 0.5s ease-out;
            background: rgba(100, 0, 0, 0.5) !important; /* ç¬é—´å˜çº¢èƒŒæ™¯ */
        }
        @keyframes flash-red-anim {
            0% { background: rgba(255, 0, 0, 0.8); }
            100% { background: rgba(0, 0, 0, 0.98); }
        }



        /* === åŠ¨ç”» === */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes shake { 0% { transform: translate(0, 0); } 2% { transform: translate(-1px, 1px); } 4% { transform: translate(1px, -1px); } 6% { transform: translate(0, 0); } 100% { transform: translate(0, 0); } }
        @keyframes glitch-anim { 0% { clip-path: inset(10% 0 80% 0); transform: translate(-2px, 1px); } 5% { clip-path: inset(80% 0 10% 0); transform: translate(2px, -1px); } 10% { clip-path: inset(40% 0 50% 0); transform: translate(-1px, 2px); } 15% { clip-path: inset(90% 0 5% 0); transform: translate(1px, -2px); } 20% { clip-path: inset(100% 0 0 0); transform: translate(0, 0); } 100% { clip-path: inset(100% 0 0 0); transform: translate(0, 0); } }
        .glitch-text { animation: glitch 0.3s infinite; }
        @keyframes glitch { 0% { transform: translate(0) } 20% { transform: translate(-2px, 2px) } 40% { transform: translate(-2px, -2px) } 60% { transform: translate(2px, 2px) } 80% { transform: translate(2px, -2px) } 100% { transform: translate(0) } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div class="scanlines"></div>

    <!-- 0. å¼€åœºåŠ¨ç”»å±‚ -->
    <div id="intro-layer" onclick="nextSlide()">
        <div id="intro-content" class="intro-text"></div>
        <div class="intro-hint">[ ç‚¹å‡»å±å¹• ç»§ç»­ ]</div>
    </div>

    <!-- 1. æ ‡é¢˜ç”»é¢ -->
    <div id="title-screen" class="screen">
        <div class="logo-box">
            <div class="logo-text">é›¾å·å¼‚é—»å½•</div>
            <div style="font-size: 1.2rem; margin-top: 10px; letter-spacing: 3px; color: var(--dim);">AGENCY 404</div>
        </div>
        
        <div style="width: 100%; max-width: 350px;">
            <!-- æ–°å¢ï¼šè¯»å–å­˜æ¡£æŒ‰é’® -->
            <button class="pixel-btn" id="btn-continue" onclick="loadGame()" style="width: 100%; display: none; border-color: var(--accent-gold); color: var(--accent-gold); margin-bottom: 15px;">ğŸ“‚ è¯»å–å­˜æ¡£ (CONTINUE)</button>
            
            <!-- æ–°å¢ï¼šæ•™ç¨‹æŒ‰é’® -->
            <button class="pixel-btn" onclick="showTutorial()" style="width: 100%; color: var(--accent-glitch); border-color: var(--accent-glitch); margin-bottom: 15px;">ğŸ“– å‘˜å·¥æ‰‹å†Œ / ç©æ³•æ•™ç¨‹</button>

            <button class="pixel-btn" onclick="openSettings()" style="width: 100%">ç³»ç»Ÿè®¾ç½® / API</button>
            <button class="pixel-btn" id="btn-enter-town" onclick="goToCharCreation()" disabled style="width: 100%">è¿›å…¥å…¬å¯“ (NEW GAME)</button>
            <div id="api-status-indicator" style="text-align: center; font-size: 0.9rem; color: var(--dim); margin-top: 10px;">[ âš ï¸ ç¥ç»è¿æ¥æœªå°±ç»ª ]</div>
        </div>
    </div>


    <!-- 2. è®¾ç½®/API ç•Œé¢ -->
    <div id="settings-modal">
        <h2>/// ç¥ç»è¿æ¥è®¾ç½® ///</h2>
        <div style="max-width: 500px; width: 100%; margin: 0 auto;">
            
            <!-- æ–°å¢ï¼šæœ‹å‹ä¸“å±å£ä»¤é€šé“ (æ›¿æ¢å¼€å§‹) -->
            <div style="border: 1px solid var(--accent-glitch); padding: 15px; margin-bottom: 20px; background: rgba(0,255,255,0.05);">
                <label style="color: var(--accent-glitch); font-weight: bold;">ğŸ”‘ æœ‹å‹ä¸“å±é€šé“ (è¾“å…¥å£ä»¤)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="pixel-input" id="secret-code" placeholder="è¾“å…¥å£ä»¤è‡ªåŠ¨è¿æ¥..." style="margin-bottom: 0;">
                    <button class="pixel-btn" onclick="applySecretCode()" style="width: 100px; margin: 0; border-color: var(--accent-glitch); color: var(--accent-glitch);">ğŸš€ å¯åŠ¨</button>
                </div>
            </div>
            <!-- æ–°å¢ï¼šæœ‹å‹ä¸“å±å£ä»¤é€šé“ (æ›¿æ¢ç»“æŸ) -->

            <!-- æ–°å¢ï¼šå­˜æ¡£ç®¡ç†åŒºåŸŸ -->
            <div style="border: 1px dashed var(--dim); padding: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.05);">
                <div style="color: var(--accent-gold); margin-bottom: 10px;">[ è®°å¿†æ•°æ®ç®¡ç† ]</div>
                <div style="display: flex; gap: 10px;">
                    <button class="pixel-btn" onclick="saveGame()" style="flex: 1;">ğŸ’¾ ä¿å­˜å½“å‰è¿›åº¦</button>
                    <button class="pixel-btn" onclick="deleteSave()" style="flex: 1; border-color: var(--accent-red); color: var(--accent-red);">ğŸ—‘ï¸ åˆ é™¤å­˜æ¡£</button>
                </div>
            </div>

            <label>API Base URL</label>
            <input type="text" class="pixel-input" id="api-url" value="https://api.openai.com/v1">
            <label>API Key</label>
            <input type="password" class="pixel-input" id="api-key" placeholder="sk-...">
            <label>Model</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" class="pixel-input" id="api-model" value="gpt-3.5-turbo" placeholder="æ¨¡å‹åç§°">
                <button class="pixel-btn" onclick="fetchModels()" style="width: 100px; margin: 0 0 15px 0; font-size: 1rem;">åˆ—è¡¨</button>
            </div>
            <button class="pixel-btn" onclick="testConnection()" style="width: 100%">âš¡ æµ‹è¯•è¿æ¥ä¿¡å·</button>
            <div id="test-msg" class="status-msg"></div>
            <div style="margin-top: 30px; display: flex; gap: 20px;">
                <button class="pixel-btn" onclick="closeSettings()" style="flex: 1">è¿”å›</button>
                <button class="pixel-btn" onclick="saveSettings()" style="flex: 1; border-color: var(--accent-glitch); color: var(--accent-glitch);">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- 3. è§’è‰²åˆ›å»º -->
    <div id="char-screen" class="screen">
        <h2>/// ç™»è®°å…¥ä½ ///</h2>
        <div class="form-container">
            <div style="text-align: right; margin-bottom: 10px;">
                <button class="pixel-btn" onclick="randomizeInputs()" style="font-size: 0.9rem; padding: 5px 10px; border-color: var(--accent-gold); color: var(--accent-gold);">ğŸ² éšæœºç”Ÿæˆæ¡£æ¡ˆ</button>
            </div>
            <label>å§“å / ä»£å·</label>
            <input type="text" class="pixel-input" id="char-name" placeholder="ä½ çš„åå­—">
            <label>å‰èŒ (å½±å“åˆå§‹å±æ€§)</label>
            <input type="text" class="pixel-input" id="char-job" placeholder="ä¾‹: ç§å®¶ä¾¦æ¢, åŒ»ç”Ÿ, ç¨‹åºå‘˜...">
            <label>é¢å¤–ç‰¹è´¨ / ç§˜å¯† (å¯é€‰)</label>
            <input type="text" class="pixel-input" id="char-extra" placeholder="ä¾‹: æ€•é»‘, é˜´é˜³çœ¼, æ¬ äº†å·¨æ¬¾...">
            <button class="pixel-btn" onclick="generatePersona()" style="margin-top: 30px; width: 100%">æäº¤æ¡£æ¡ˆ & ç”Ÿæˆäººè®¾</button>
        </div>
    </div>

    <!-- 3.5 æ¡£æ¡ˆç”Ÿæˆå±•ç¤ºé¡µ -->
    <div id="persona-screen" class="screen">
        <div id="persona-loading" class="loading-text">
            æ­£åœ¨æ£€ç´¢æ¡£æ¡ˆåº“...<br>
            <span style="font-size: 1rem; color: var(--dim)">ANALYZING SOUL DATA...</span>
        </div>

        <div id="persona-result" class="dossier-card">
            <div class="dossier-header">
                <div class="dossier-title">INVESTIGATOR</div>
                <div style="text-align: right;">
                    <div id="dossier-name">NAME: ???</div>
                    <div id="dossier-job" style="color: var(--dim)">JOB: ???</div>
                </div>
            </div>
            
            <div class="dossier-body" id="dossier-desc"></div>

            <div class="stat-grid">
                <div class="stat-item"><span class="stat-label">PHY ä½“é­„</span> <span id="p-phy" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">DEX çµå·§</span> <span id="p-dex" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">INT å­¦è¯†</span> <span id="p-int" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">CHA é­…åŠ›</span> <span id="p-cha" class="stat-value">0</span></div>
                <div class="stat-item" style="grid-column: span 2; border-top: 1px solid #333; margin-top: 5px; padding-top: 5px;">
                    <span class="stat-label" style="color: #a0f;">MYS çµè§† (æ ¸å¿ƒ)</span> 
                    <span id="p-mys" class="stat-value stat-mys">0</span>
                </div>
                <div class="stat-item"><span class="stat-label">HP ç”Ÿå‘½</span> <span id="p-hp" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">SAN ç†æ™º</span> <span id="p-san" class="stat-value">0</span></div>
            </div>

            <button class="pixel-btn" onclick="realStartGame()" style="width: 100%; margin-top: 20px; border-color: var(--accent-red);">ç¡®è®¤æ¡£æ¡ˆ & å…¥ä½</button>
        </div>
    </div>

    <!-- 4. æ¸¸æˆä¸»ç•Œé¢ (AVG) -->
    <div id="game-screen" class="screen">
        <div class="top-bar">
            <div class="bar-left">
                <div class="time-box">
                    <span id="day-num">DAY 1</span>
                    <span id="time-icon">â˜€ï¸</span>
                    <span id="time-text" style="font-size: 0.9rem; color: var(--dim)">ä¸Šåˆ</span>
                </div>
                <div class="hp-san-box">
                    <span>HP <span id="val-hp" class="val-label">100</span></span>
                    <span>SAN <span id="val-san" class="val-label">60</span></span>
                    <span class="money-label">Â¥ <span id="val-money">2000</span></span>
                </div>
            </div>
            <div style="display: flex; gap: 5px;">
                <!-- æ–°å¢ï¼šé¡¶éƒ¨æ çš„æ•™ç¨‹æŒ‰é’® -->
                <button class="menu-btn" onclick="showTutorial()" style="color: var(--accent-glitch);">ğŸ“– HELP</button>
                <button class="menu-btn" onclick="showNote()">ğŸ““ NOTE</button>
                <button class="menu-btn" onclick="showPhone()">ğŸ“± PHONE</button>
                <button class="menu-btn" onclick="showMap()">MAP</button>
                <button class="menu-btn" onclick="showInventory()">BAG</button>
                <button class="menu-btn" onclick="showStatus()">STAT</button>
                <button class="menu-btn" onclick="showLog()">LOG</button>
                <button class="menu-btn" onclick="openSettings()" style="border-color: var(--dim);">âš™ï¸</button>
            </div>
        </div>

        <div class="visual-area" id="visual-area">
            <div class="scene-title" id="scene-title">404å·äº‹åŠ¡æ‰€</div>
            
            <!-- äº‹åŠ¡æ‰€ä¸“ç”¨æŒ‰é’® -->
            <div id="office-hud" class="office-hud">
                <button class="pixel-btn" onclick="handleOfficeAction('computer')">ğŸ’» ç”µè„‘ç»ˆç«¯</button>
                <button class="pixel-btn" onclick="handleOfficeAction('sleep')">ğŸ›ï¸ ç¡è§‰ (ç»“ç®—)</button>
            </div>

            <!-- å•†åº—ä¸“ç”¨æŒ‰é’® (ç§»åˆ°è¿™é‡Œé¢æ¥äº†ï¼è¿™æ ·å®ƒå°±ä¼šæ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸Šï¼Œä¸ä¼šè¢«ä¸‹é¢çš„å¯¹è¯æ¡†æŒ¡ä½) -->
            <div id="shop-hud" class="shop-hud">
                <button class="pixel-btn" onclick="openShop()" style="border-color: var(--accent-gold); color: var(--accent-gold);">ğŸ›’ è¿›å…¥äº¤æ˜“ (SHOP)</button>
            </div>
        </div>


        <div class="dialogue-box" onclick="nextText()">
            <div class="speaker-name" id="speaker-name">???</div>
            <div class="text-content" id="main-text"></div>
            <div class="click-indicator" id="click-arrow">â–¼</div>
        </div>

        <!-- è‡ªç”±è¡ŒåŠ¨è¾“å…¥æ  (å‡çº§ç‰ˆ) -->
        <div id="free-action-bar" style="
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: #000; border-top: var(--border); padding: 10px;
            display: flex; gap: 8px; z-index: 60; align-items: stretch;
        ">
            <!-- æ–°å¢ï¼šæ¢ç´¢æŒ‰é’® -->
            <button class="pixel-btn" onclick="triggerExplore()" style="
                margin: 0; width: 50px; border-color: var(--accent-gold); color: var(--accent-gold); font-size: 1.2rem;
            ">ğŸ”</button>
            
            <input type="text" id="free-input" class="pixel-input" placeholder="è¾“å…¥è¡ŒåŠ¨..." style="margin: 0; font-size: 0.9rem; flex: 1; min-width: 0;">
            
            <button class="pixel-btn" onclick="submitFreeAction()" style="margin: 0; width: 70px;">æ‰§è¡Œ</button>
        </div>

        <!-- é€‰é¡¹å±‚ï¼šæ³¨æ„ bottom: 60px æ˜¯ä¸ºäº†é¿å¼€ä¸Šé¢çš„è¾“å…¥æ¡† -->
        <div class="choices-overlay" id="choices-layer" style="bottom: 60px;"></div>
    </div>

    <!-- 4.5 ä¾¦æ¢æ‰‹è®° (Notebook) -->
    <div id="note-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// è°ƒæŸ¥æ‰‹è®° ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('note-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div style="margin-bottom: 20px;">
                <div style="color: var(--accent-gold); border-bottom: 1px dashed var(--dim); padding-bottom: 5px; margin-bottom: 10px;">
                    [ å½“å‰ç›®æ ‡ / CURRENT OBJECTIVE ]
                </div>
                <div id="quest-list" style="font-family: var(--font-read); line-height: 1.6; color: var(--fg);">
                    <!-- ä»»åŠ¡åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div>
                <div style="color: var(--accent-glitch); border-bottom: 1px dashed var(--dim); padding-bottom: 5px; margin-bottom: 10px;">
                    [ çº¿ç´¢è®°å½• / CLUES ]
                </div>
                <div id="clue-list" style="font-family: var(--font-read); font-size: 0.95rem; color: #aaa;">
                    <!-- çº¿ç´¢åŠ¨æ€ç”Ÿæˆ -->
                    <div style="font-style: italic; color: var(--dim)">æš‚æ— å…³é”®çº¿ç´¢...</div>
                </div>
            </div>
        </div>
    </div>


    <!-- 5. çŠ¶æ€é¢æ¿ -->
    <div id="status-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// è°ƒæŸ¥å‘˜çŠ¶æ€ ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('status-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div class="status-bio">
                <div style="color: var(--accent-glitch); font-weight: bold;">[ æ¡£æ¡ˆè®°å½• ]</div>
                <div id="s-bio-text" class="bio-text">æš‚æ— æ•°æ®...</div>
            </div>

            <div class="status-full-grid">
                <!-- æ–°å¢ï¼šå£°æœ›æ˜¾ç¤º -->
                <div class="attr-row" style="border-bottom: 2px solid var(--accent-gold);">
                    <div><span class="attr-name" style="color: var(--accent-gold);">REP å£°æœ›</span><span class="attr-desc">çŸ¥ååº¦ / å§”æ‰˜ç­‰çº§</span></div>
                    <div class="attr-val" id="s-rep" style="color: var(--accent-gold);">0</div>
                </div>

                <div class="attr-row">
                    <div><span class="attr-name">PHY ä½“é­„</span><span class="attr-desc">ç”Ÿå‘½ / æˆ˜æ–— / æŠµæŠ—</span></div>
                    <div class="attr-val" id="s-phy">0</div>
                </div>
                <div class="attr-row">
                    <div><span class="attr-name">DEX çµå·§</span><span class="attr-desc">é—ªé¿ / æ½œè¡Œ / å¼€é”</span></div>
                    <div class="attr-val" id="s-dex">0</div>
                </div>
                <div class="attr-row">
                    <div><span class="attr-name">INT å­¦è¯†</span><span class="attr-desc">è°ƒæŸ¥ / ç¥ç§˜å­¦ / é»‘å®¢</span></div>
                    <div class="attr-val" id="s-int">0</div>
                </div>
                <div class="attr-row">
                    <div><span class="attr-name">CHA é­…åŠ›</span><span class="attr-desc">äº¤æ¶‰ / æ¬ºè¯ˆ / æƒ…æŠ¥</span></div>
                    <div class="attr-val" id="s-cha">0</div>
                </div>
                <div class="attr-row" style="border-color: #a0f;">
                    <div><span class="attr-name" style="color: #a0f;">MYS çµè§†</span><span class="attr-desc">çœ‹è§ä¸å¯è§ä¹‹ç‰© / SANä¸Šé™</span></div>
                    <div class="attr-val" id="s-mys" style="color: #a0f;">0</div>
                </div>
                <div style="margin-top: 20px; border-top: 2px solid var(--fg); padding-top: 10px;">
                    <div class="attr-row">
                        <span class="attr-name">HP å½“å‰ç”Ÿå‘½</span>
                        <span class="attr-val" id="s-hp">0</span>
                    </div>
                    <div class="attr-row">
                        <span class="attr-name">SAN å½“å‰ç†æ™º</span>
                        <span class="attr-val" id="s-san">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. ç‰©å“æ  (Inventory) -->
    <div id="inventory-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// ç‰©å“æ¸…å• ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('inventory-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div id="inventory-list" class="inventory-grid">
                <!-- ç‰©å“å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="empty-bag-msg" style="text-align: center; color: var(--dim); margin-top: 50px; display: none;">
                [ ç©ºæ— ä¸€ç‰© ]
            </div>
        </div>
    </div>

    <!-- 7. åœ°å›¾ (Map) -->
    <div id="map-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// åŸå¸‚å¯¼èˆª ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('map-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content">
            <div style="margin-bottom: 15px; color: var(--dim); font-size: 0.9rem;">
                å½“å‰ä½ç½®: <span id="current-location-name" style="color: var(--accent-glitch)">404å·äº‹åŠ¡æ‰€</span>
                <br>
                <span style="color: var(--accent-gold)">æç¤ºï¼šç™½å¤©å¯è‡ªç”±ç§»åŠ¨ï¼Œå¤œæ™šç§»åŠ¨å¯èƒ½é­é‡å±é™©ã€‚</span>
            </div>
            <div id="map-grid" class="map-grid">
                <!-- åœ°ç‚¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- 7. å•†åº—äº¤æ˜“å±‚ (æ–°å¢) -->
    <div id="shop-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2 id="shop-title">/// äº¤æ˜“ç»ˆç«¯ ///</h2>
            <div style="display:flex; align-items:center; gap:15px;">
                <span style="color:var(--accent-gold); font-family:var(--font-pixel);">
                    æŒæœ‰: Â¥<span id="shop-player-money">0</span>
                </span>
                <button class="pixel-btn" onclick="hideOverlay('shop-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
            </div>
        </div>
        <div class="overlay-content">
            <div id="shop-loading" class="loading-text" style="display:none; margin-top:50px;">
                æ­£åœ¨è·å–å•†å“åˆ—è¡¨...<br>CONNECTING TO MARKET...
            </div>
            <div id="shop-list" class="shop-grid">
                <!-- å•†å“å°†ç”±AIç”Ÿæˆå¹¶å¡«å…… -->
            </div>
        </div>
    </div>



    <!-- 7.5 æ‰‹æœºç»ˆç«¯ (ç¾åŒ–ç‰ˆ) -->
    <div id="phone-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// æ™ºèƒ½ç»ˆç«¯ ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('phone-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content" style="position: relative; overflow: hidden;">
            <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
            <div style="display: flex; justify-content: space-between; padding: 0 10px 10px 10px; border-bottom: 1px solid #333; color: var(--dim); font-size: 0.8rem;">
                <span id="phone-carrier">NO SIGNAL</span>
                <span><span id="phone-time">12:00</span> | ğŸ”‹ 84%</span>
            </div>
            
            <!-- APP å›¾æ ‡ç½‘æ ¼ -->
            <div id="phone-home" class="app-grid">
                <div class="app-icon" onclick="handlePhoneAction('sns')">
                    <div class="app-symbol" style="border-color: #ff79c6; color: #ff79c6;">ğŸ’¬</div>
                    <div class="app-name">æ ‘æ´</div>
                </div>
                <div class="app-icon" onclick="handlePhoneAction('news')">
                    <div class="app-symbol" style="border-color: #8be9fd; color: #8be9fd;">ğŸ“°</div>
                    <div class="app-name">æ—©æŠ¥</div>
                </div>
                <div class="app-icon" onclick="handlePhoneAction('takeout')">
                    <div class="app-symbol" style="border-color: #f1fa8c; color: #f1fa8c;">ğŸ”</div>
                    <div class="app-name">é¥±äº†ä¹ˆ</div>
                </div>
                <div class="app-icon" onclick="handlePhoneAction('msg')">
                    <div class="app-symbol" style="border-color: #ff5555; color: #ff5555;">ğŸ“©</div>
                    <div class="app-name">çŸ­ä¿¡</div>
                </div>
            </div>

            <!-- APP å†…å®¹æ˜¾ç¤ºåŒº -->
            <div id="phone-display-area">
                <div class="app-header">
                    <button class="back-btn" onclick="closePhoneApp()">â†</button>
                    <span class="app-title" id="current-app-title">åº”ç”¨åç§°</span>
                </div>
                <div id="phone-content" style="flex: 1; overflow-y: auto; padding-bottom: 20px;">
                    <!-- åŠ¨æ€å†…å®¹å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>
    </div>

    <!-- 9. å‘½è¿éª°å­åŠ¨ç”»å±‚ (æ–°å¢) -->
    <div id="dice-layer" class="overlay-layer" style="justify-content: center; align-items: center; background: rgba(0,0,0,0.98); z-index: 50000;">
        <div style="text-align: center; width: 100%;">
            <div id="dice-title" style="color: var(--dim); margin-bottom: 30px; letter-spacing: 4px; font-family: var(--font-pixel);">ATTRIBUTE CHECK...</div>
            
            <!-- éª°å­æœ¬ä½“ -->
            <div id="dice-box" style="
                font-size: 6rem; font-weight: bold; color: var(--fg); 
                border: 6px solid var(--fg); width: 140px; height: 140px; 
                line-height: 120px; margin: 0 auto; position: relative;
                background: #000; box-shadow: 0 0 20px rgba(255,255,255,0.1);
                transition: all 0.2s;
            ">
                <span id="dice-val">20</span>
            </div>

            <!-- ç»“æœåé¦ˆ -->
            <div id="dice-result" style="font-size: 3rem; margin-top: 30px; height: 50px; font-weight: bold; letter-spacing: 5px; text-shadow: 0 0 10px currentColor;"></div>
            
            <div id="dice-target" style="color: var(--dim); margin-top: 20px; font-size: 1.2rem;">
                CHECK: <span id="check-attr" style="color: var(--accent-gold)">INT</span> | 
                TARGET: <span id="target-val" style="color: #fff">10</span>
            </div>
        </div>
    </div>


    <!-- 8. å†å²è®°å½•å±‚ -->
    <div id="log-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// è°ƒæŸ¥è®°å½• ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('log-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div id="log-content" class="overlay-content"></div>
</div>
    <!-- 11. é€šç”¨å¼¹çª—å±‚ (æ›¿ä»£ä¸‘é™‹çš„alert) -->
    <div id="pixel-modal" class="pixel-modal">
        <div class="modal-box">
            <div class="modal-inner">
                <div id="modal-text" class="modal-text">ç³»ç»Ÿæ¶ˆæ¯</div>
                <button class="pixel-btn" onclick="closePixelMsg()" style="width: 100%; border-color: var(--accent-glitch); color: var(--accent-glitch); font-weight:bold;">ç¡® å®š</button>
            </div>
        </div>
    </div>




    <!-- 10. æ•™ç¨‹/è¯´æ˜ä¹¦å±‚ (æ–°å¢) -->
    <div id="tutorial-layer" class="overlay-layer">
        <div class="overlay-header">
            <h2>/// 404å·å‘˜å·¥æ‰‹å†Œ ///</h2>
            <button class="pixel-btn" onclick="hideOverlay('tutorial-layer')" style="padding: 5px 10px; font-size: 1rem;">X</button>
        </div>
        <div class="overlay-content" style="font-family: var(--font-read); line-height: 1.8; color: #ccc;">
            
            <div style="border: 1px solid var(--accent-glitch); padding: 15px; margin-bottom: 20px; background: rgba(0,255,255,0.05);">
                <h3 style="color: var(--accent-glitch); margin-top: 0;">01. ç¥ç»è¿æ¥ (APIè®¾ç½®)</h3>
                <p>æœ¬æ¸¸æˆç”±AIé©±åŠ¨ï¼Œå¿…é¡»è¿æ¥â€œçµç•Œä¿¡å·â€æ‰èƒ½è¿è¡Œã€‚</p>
                <ul style="list-style: square; padding-left: 20px;">
                    <li><strong>API Base URL:</strong> æ¥å£åœ°å€ã€‚ä¾‹å¦‚ OpenAI å®˜æ–¹ä¸º <code>https://api.openai.com/v1</code>ï¼Œç¬¬ä¸‰æ–¹ä¸­è½¬é€šå¸¸ä¸º <code>https://api.xxx.com/v1</code> (æ³¨æ„æœ«å°¾ä¸è¦å¸¦æ–œæ )ã€‚</li>
                    <li><strong>API Key:</strong> ä½ çš„å¯†é’¥ (sk-...)ã€‚</li>
                    <li><strong>Model:</strong> æ¨èä½¿ç”¨ <code>gpt-3.5-turbo</code> æˆ– <code>gpt-4o-mini</code> ä»¥è·å¾—æœ€ä½³é€Ÿåº¦ä¸ä½“éªŒã€‚</li>
                    <li>ç‚¹å‡» <strong>[âš¡ æµ‹è¯•è¿æ¥ä¿¡å·]</strong>ï¼Œæ˜¾ç¤ºç»¿è‰²æˆåŠŸåå³å¯å¼€å§‹æ¸¸æˆã€‚</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--accent-gold);">02. ç”Ÿå­˜æ³•åˆ™</h3>
                <p>ä½ æ˜¯ä¸€åå±…ä½åœ¨â€œé›¾å·å¸‚â€çš„è°ƒæŸ¥å‘˜ï¼Œç»è¥ç€ä¸€å®¶åä¸ºâ€œ404å·â€çš„äº‹åŠ¡æ‰€ã€‚</p>
                <ul style="list-style: square; padding-left: 20px;">
                    <li><strong>HP (ç”Ÿå‘½):</strong> å½’é›¶åˆ™æ­»äº¡ï¼ˆåˆ æ¡£ï¼‰ã€‚ç¡è§‰ã€åƒå¤–å–ã€å»è¯Šæ‰€å¯æ¢å¤ã€‚</li>
                    <li><strong>SAN (ç†æ™º):</strong> æ¥è§¦è¯¡å¼‚äº‹ç‰©ä¼šæ‰£é™¤ã€‚è¿‡ä½æ—¶ï¼ˆ&lt;30ï¼‰ä¼šçœ‹åˆ°ä¹±ç ã€å¹»è§‰ï¼Œç”šè‡³æ”¹å˜ç‰©å“æè¿°ã€‚</li>
                    <li><strong>MYS (çµè§†):</strong> ä½ çš„æ ¸å¿ƒå±æ€§ã€‚è¶Šé«˜è¶Šå®¹æ˜“å‘ç°éšè—çº¿ç´¢ï¼Œä½†ä¹Ÿè¶Šå®¹æ˜“æ‰SANã€‚</li>
                    <li><strong>æ—¶é—´æµé€:</strong> æ¯å¤©åˆ†ä¸ºä¸Šåˆã€ä¸‹åˆã€é»„æ˜ã€æ·±å¤œã€‚æ·±å¤œå¤–å‡ºæå…¶å±é™©ã€‚</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--accent-red);">03. æ ¸å¿ƒè°œå›¢ä¸è°ƒæŸ¥</h3>
                <p>æ¸¸æˆä¸­ä¼šéšæœºè§¦å‘<strong>[æ ¸å¿ƒè°œå›¢]</strong>ï¼ˆå¦‚ï¼šåˆå¤œæ•²é—¨å£°ï¼‰ã€‚</p>
                <ul style="list-style: square; padding-left: 20px;">
                    <li><strong>æˆªæ­¢æ—¥æœŸ:</strong> æ¯ä¸ªè°œå›¢éƒ½æœ‰å€’è®¡æ—¶ã€‚å¿…é¡»åœ¨æˆªæ­¢æ—¥ç¡è§‰å‰æŸ¥æ¸…çœŸç›¸ã€‚</li>
                    <li><strong>å¦‚ä½•è°ƒæŸ¥:</strong> 
                        <br>- ä½¿ç”¨äº‹åŠ¡æ‰€ç”µè„‘æŸ¥é‚®ä»¶ã€‚
                        <br>- å¤–å‡ºæ¢ç´¢ç›¸å…³åœ°ç‚¹ã€‚
                        <br>- åœ¨ä¸‹æ–¹è¾“å…¥æ¡†è¾“å…¥<strong>è‡ªç”±è¡ŒåŠ¨</strong>ï¼ˆå¦‚ï¼šâ€œä»”ç»†æ£€æŸ¥å¢™å£â€ã€â€œè¯¢é—®å…³äºæ•²é—¨å£°çš„äº‹â€ï¼‰ã€‚
                    </li>
                    <li><strong>ç»“ç®—:</strong> æˆªæ­¢æ—¥å½“æ™šä¼šè‡ªåŠ¨ç»“ç®—ã€‚æˆåŠŸåˆ™è·å¾—å£°æœ›ä¸é‡‘é’±ï¼Œå¤±è´¥å°†é­å—æ°¸ä¹…è¯…å’’ã€‚</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #fff;">04. å¸¸ç”¨å·¥å…·</h3>
                <ul style="list-style: square; padding-left: 20px;">
                    <li><strong>ğŸ“± æ‰‹æœº:</strong> ç‚¹å¤–å–(å›è¡€)ã€çœ‹æ–°é—»(æƒ…æŠ¥)ã€åˆ·æ ‘æ´(æ€ªè°ˆ)ã€‚</li>
                    <li><strong>ğŸ““ æ‰‹è®°:</strong> æŸ¥çœ‹å½“å‰ä»»åŠ¡ç›®æ ‡å’Œå·²æ”¶é›†çš„çº¿ç´¢ã€‚</li>
                    <li><strong>ğŸ² æ£€å®š:</strong> å½“ä½ è¯•å›¾è¿›è¡Œå±é™©åŠ¨ä½œï¼ˆå¦‚æ’¬é”ã€è¯´æœï¼‰æ—¶ï¼Œä¼šè§¦å‘å±æ€§æ£€å®šã€‚</li>
                </ul>
            </div>

            <div style="text-align: center; margin-top: 30px; color: var(--dim); font-size: 0.9rem;">
                â€”â€” ç¥ä½ å¥½è¿ï¼Œè°ƒæŸ¥å‘˜ã€‚ â€”â€”
            </div>
        </div>
    </div>

<script>
/**
 * å…¨å±€çŠ¶æ€ä¸é…ç½®
 */
let config = {
    baseUrl: localStorage.getItem('mc_base_url') || 'https://api.openai.com/v1',
    apiKey: localStorage.getItem('mc_api_key') || '',
    model: localStorage.getItem('mc_model') || 'gpt-3.5-turbo'
};

// æ—¶é—´é˜¶æ®µå¸¸é‡
const TIME_PHASES = ["ä¸Šåˆ", "ä¸‹åˆ", "é»„æ˜", "æ·±å¤œ"];
const TIME_ICONS = ["â˜€ï¸", "â˜€ï¸", "ğŸŒ‡", "ğŸŒ™"];

let gameState = {
    day: 1,
    timePhase: 0, // 0-3
    money: 2000,
    reputation: 0, // å£°æœ›å€¼
    currentLocation: "404å·äº‹åŠ¡æ‰€",
    player: { name: "", job: "", extra: "", desc: "" },
    // === ä¿®æ”¹ï¼šåˆå§‹å±æ€§æ”¹ä¸º D100 æ ‡å‡† (å¹³å‡50) ===
    stats: { 
        hp: 100, maxHp: 100, 
        san: 60, maxSan: 60,
        phy: 50, dex: 50, int: 50, cha: 50, mys: 50 
    },
    // === æ–°å¢ï¼šæ ¸å¿ƒè°œå›¢ç³»ç»Ÿ ===
    mystery: {
        active: false,      // æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„è°œå›¢
        title: "",          // è°œé¢
        truth: "",          // è°œåº• (AIå·²çŸ¥)
        deadlineDay: 0,     // æˆªæ­¢æ—¥æœŸ
        status: "pending",   // pending, solved, failed
        tempQuizData: null   // ä¸´æ—¶å­˜å‚¨æ™šä¸Šçš„é¢˜ç›®
    },
    inventory: [],
    quests: [
        { id: "main", text: "å¤„ç†é‚»å±…ç‹é˜¿å§¨çš„å§”æ‰˜ï¼šå¯»æ‰¾èµ°å¤±çš„æ³¢æ–¯çŒ«ã€‚", active: true } 
    ],
    clues: [], 
    unlockedLocations: [
        { name: "404å·äº‹åŠ¡æ‰€", id: "home", locked: false, type: "safe" },
        { name: "ä¾¿åˆ©åº—", id: "shop", locked: false, type: "shop" },
        { name: "å¿ƒç†è¯Šæ‰€", id: "clinic", locked: false, type: "heal" }
    ],
    history: [], 
    log: [],
    flags: {
        introDone: false,
        hasCheckedMail: false
    }
};

// === æ–°å¢ï¼šåœºæ™¯èƒŒæ™¯å›¾é…ç½® (æ”¯æŒç™½å¤©/é»‘å¤œåˆ‡æ¢) ===
const SCENE_CONFIG = {
    // æ ¼å¼ï¼š "å…³é”®è¯": { day: "ç™½å¤©å›¾", night: "æ™šä¸Šå›¾" }
    
    // 1. äº‹åŠ¡æ‰€ (ç©å®¶çš„å®¶)
    "äº‹åŠ¡æ‰€": {
        day: "https://i.postimg.cc/qvJcFkDn/sheng-cheng-te-ding-feng-ge-tu-pian.png",
        night: "https://i.postimg.cc/9FpZZ6Xz/shi-wu-suo-ye-wan.png"
    },
    "404": { // é˜²æ­¢AIæœ‰æ—¶å€™åªè¯´â€œ404å·â€
        day: "https://i.postimg.cc/qvJcFkDn/sheng-cheng-te-ding-feng-ge-tu-pian.png",
        night: "https://i.postimg.cc/9FpZZ6Xz/shi-wu-suo-ye-wan.png"
    },

    // 2. ä¾¿åˆ©åº—/å•†åº—
    "ä¾¿åˆ©åº—": {
        day: "https://i.postimg.cc/44vJ3ZPr/bian-li-dian.png",
        night: "https://i.postimg.cc/HWzfKLB3/bian-li-dian-ye-wan.png"
    },
    "å•†åº—": { // å…¼å®¹å«æ³•
        day: "https://i.postimg.cc/44vJ3ZPr/bian-li-dian.png",
        night: "https://i.postimg.cc/HWzfKLB3/bian-li-dian-ye-wan.png"
    },

    // 3. åŒ»é™¢/è¯Šæ‰€
    "åŒ»é™¢": { 
        day: "https://i.postimg.cc/0yvxR47x/yi-yuan-zhen-shi.png",
        night: "https://i.postimg.cc/qvr0VF2J/yi-yuan-zhen-shi-ye-wan.png"
    },
    "è¯Šæ‰€": { 
        day: "https://i.postimg.cc/0yvxR47x/yi-yuan-zhen-shi.png",
        night: "https://i.postimg.cc/qvr0VF2J/yi-yuan-zhen-shi-ye-wan.png"
    }
};

// é»˜è®¤èƒŒæ™¯ï¼ˆè¡—é“/è¡—åŒºï¼‰- å½“è¯†åˆ«ä¸åˆ°å…·ä½“åœ°ç‚¹æ—¶ä½¿ç”¨
const DEFAULT_SCENE = {
    day: "https://i.postimg.cc/3wJk7N2v/jie-dao-bai-tian.png",
    night: "https://i.postimg.cc/TYgLJZRj/jie-dao-ye-wan.png"
};

// åˆ‡æ¢èƒŒæ™¯å›¾çš„å‡½æ•°
function updateSceneBackground(locationName) {
    const visualArea = document.getElementById('visual-area');
    
    // 1. åˆ¤æ–­æ˜¯ç™½å¤©è¿˜æ˜¯æ™šä¸Š
    // æ¸¸æˆé€»è¾‘ï¼š0=ä¸Šåˆ, 1=ä¸‹åˆ, 2=é»„æ˜, 3=æ·±å¤œ
    // è®¾å®šï¼šé»„æ˜(2)å’Œæ·±å¤œ(3)ä½¿ç”¨â€œå¤œæ™šå›¾â€ï¼Œä¸Šåˆ(0)å’Œä¸‹åˆ(1)ä½¿ç”¨â€œç™½å¤©å›¾â€
    const isNight = gameState.timePhase >= 2; 

    // 2. å…ˆè®¾ç½®é»˜è®¤å›¾ç‰‡ï¼ˆè¡—é“ï¼‰
    let bgUrl = isNight ? DEFAULT_SCENE.night : DEFAULT_SCENE.day;

    // 3. éå†é…ç½®ï¼Œå¯»æ‰¾åŒ¹é…çš„å…³é”®è¯
    // åªè¦åœ°ç‚¹åå­—åŒ…å«å…³é”®è¯ï¼ˆæ¯”å¦‚"ç¬¬ä¸€äººæ°‘åŒ»é™¢"åŒ…å«"åŒ»é™¢"ï¼‰ï¼Œå°±åº”ç”¨ç‰¹å®šå›¾ç‰‡
    for (const [key, urls] of Object.entries(SCENE_CONFIG)) {
        if (locationName.includes(key)) {
            bgUrl = isNight ? urls.night : urls.day;
            break; // æ‰¾åˆ°åŒ¹é…çš„å°±åœæ­¢
        }
    }

    // 4. åº”ç”¨èƒŒæ™¯
    // ä¸ºäº†é˜²æ­¢å›¾ç‰‡é—ªçƒï¼Œåªæœ‰å½“URLçœŸæ­£æ”¹å˜æ—¶æ‰è®¾ç½®
    // è¿™é‡Œåšäº†ä¸€ä¸ªç®€å•çš„æ­£åˆ™å¤„ç†å»æ‰url("")çš„åŒ…è£…æ¥å¯¹æ¯”
    const currentBg = visualArea.style.backgroundImage.slice(5, -2); // å»æ‰ url(" ... ")
    if (currentBg !== bgUrl) {
        visualArea.style.backgroundImage = `url('${bgUrl}')`;
    }
}

let avgState = {
    textQueue: [],
    currentFullText: "",
    isTyping: false,
    typingTimer: null,
    charIndex: 0,
    pendingChoices: [],
    isWaitingForAI: false, // æ­£åœ¨ç­‰AIè¯·æ±‚
    isReadyToPlay: false,
    tempData: null
};

// === ä¿®æ”¹ï¼šå…¨å±€è¾“å…¥é”å®šæ£€æŸ¥ ===
function checkInputLock() {
    // 1. æ­£åœ¨ç­‰AIè¯·æ±‚ -> é”
    // 2. æ­£åœ¨æ‰“å­—æœºæ‰“å­— -> é”
    // 3. é˜Ÿåˆ—é‡Œè¿˜æœ‰æ²¡æ’­æ”¾å®Œçš„æ®µè½ -> é” (è¿™å°±æ˜¯ä½ è¦çš„åŠŸèƒ½ï¼)
    // 4. æœ‰å¾…æ˜¾ç¤ºçš„é€‰é¡¹è¿˜æ²¡æ˜¾ç¤ºå‡ºæ¥ -> é” (é˜²æ­¢æœ€åä¸€å¥åˆšæ’­å®Œè¿˜æ²¡å‡ºé€‰é¡¹æ—¶ç©å®¶ä¹±ç‚¹)
    if (avgState.isWaitingForAI || 
        avgState.isTyping || 
        avgState.textQueue.length > 0 || 
        (avgState.pendingChoices && avgState.pendingChoices.length > 0 && !document.getElementById('choices-layer').classList.contains('active'))) {
        return true; 
    }
    return false; // åªæœ‰å®Œå…¨æ²¡äº‹äº†ï¼Œæ‰è§£é”
}

// === æ–°å¢ï¼šæ›´æ–°ç•Œé¢é”å®šçŠ¶æ€ ===
function updateLockVisuals() {
    const isLocked = checkInputLock();
    const gameScreen = document.getElementById('game-screen');
    
    // æˆ‘ä»¬é”å®šé™¤äº†å¯¹è¯æ¡†ä»¥å¤–çš„æ‰€æœ‰ä¸œè¥¿
    const topBar = document.querySelector('.top-bar');
    const bottomBar = document.getElementById('free-action-bar');
    const choices = document.getElementById('choices-layer');
    const officeHud = document.getElementById('office-hud');
    const shopHud = document.getElementById('shop-hud');

    if (isLocked) {
        if(topBar) topBar.classList.add('game-locked');
        if(bottomBar) bottomBar.classList.add('game-locked');
        if(choices) choices.classList.add('game-locked');
        if(officeHud) officeHud.classList.add('game-locked');
        if(shopHud) shopHud.classList.add('game-locked');
        // æ˜¾ç¤ºä¸€ä¸ªå°æç¤º
        document.getElementById('click-arrow').style.display = 'none';
    } else {
        if(topBar) topBar.classList.remove('game-locked');
        if(bottomBar) bottomBar.classList.remove('game-locked');
        if(choices) choices.classList.remove('game-locked');
        if(officeHud) officeHud.classList.remove('game-locked');
        if(shopHud) shopHud.classList.remove('game-locked');
        // æ¢å¤ç®­å¤´
        document.getElementById('click-arrow').style.display = 'block';
    }
};

// --- 0. å¼€åœºåŠ¨ç”»é€»è¾‘ ---
const slides = [
    { text: "ä½ å¥½ï¼Œæ¬¢è¿æ¥åˆ° <span class='highlight-neon' style='font-size: 2.2rem'>é›¾å·å¸‚Â·è€åŸåŒº</span>ã€‚", style: "text-align: center;" },
    { text: "è¿™é‡Œçš„æˆ¿ç§Ÿä¾¿å®œå¾—æ„Ÿäººï¼Œæ¥¼ä¸‹çš„ä¾¿åˆ©åº—æ°¸è¿œåœ¨æ‰“æŠ˜ï¼Œ\nç©ºæ°”é‡Œå¸¸å¹´é£˜ç€ä¸€è‚¡â€¦â€¦\n<br><span class='highlight-scary' style='font-size: 2rem'>çº¢çƒ§ç‰›è‚‰é¢å’Œä¸‹æ°´é“æ··åˆçš„å‘³é“</span>ã€‚", style: "text-align: left;" },
    { text: "ä½ ç»è¥ç€ <span style='border-bottom: 2px solid white'>404å·äº‹åŠ¡æ‰€</span>ã€‚\nä½œä¸ºä¸€åæ€»æ˜¯å…¥ä¸æ•·å‡ºçš„ç§å®¶ä¾¦æ¢ï¼Œä½ æ¯å¤©çš„çƒ¦æ¼ä¸æ˜¯æ‹¯æ•‘ä¸–ç•Œï¼Œè€Œæ˜¯ä¸‹ä¸ªæœˆçš„æ°´ç”µè´¹ã€‚", style: "text-align: left;" },
    { text: "å¶å°”ï¼Œç¡®å®ä¼šæœ‰ä¸€äº›â€œå¥‡æ€ªâ€çš„é‚»å±…æ‰¾ä¸Šé—¨â€¦â€¦\n\n1. æ¥¼ä¸Šæ²¡ä½äººï¼Œä½†åŠå¤œæ€»æœ‰å¼¹ç å£°ã€‚\n2. å¿«é€’å‘˜æœ‰æ—¶å€™æ²¡æœ‰è„¸ã€‚\n3. <span style='font-style:italic'>æ— è®ºçœ‹åˆ°ä»€ä¹ˆï¼Œåªè¦ä¸åŠ é’±ï¼Œå°±å½“æ²¡çœ‹è§ã€‚</span>", style: "text-align: left;" },
    { text: "å‡†å¤‡å¥½å¼€å§‹ä½ é¸¡é£ç‹—è·³çš„ä¾¦æ¢ç”Ÿæ´»äº†å—ï¼Ÿ", style: "text-align: center; font-size: 1.5rem;" }
];


let currentSlide = 0;
const introLayer = document.getElementById('intro-layer');
const introContent = document.getElementById('intro-content');

showSlide(0);

function showSlide(index) {
    introContent.classList.remove('show');
    setTimeout(() => {
        if (index >= slides.length) { endIntro(); return; }
        introContent.innerHTML = slides[index].text;
        introContent.style.cssText = slides[index].style;
        introContent.classList.add('show');
    }, 300);
}

function nextSlide() {
    currentSlide++;
    if (currentSlide < slides.length) showSlide(currentSlide);
    else endIntro();
}

function endIntro() {
    introLayer.style.opacity = '0';
    introLayer.style.pointerEvents = 'none';
    setTimeout(() => {
        introLayer.style.display = 'none';
        document.getElementById('title-screen').classList.add('active');
    }, 1000);
}

// --- 1. åˆå§‹åŒ–ä¸è®¾ç½® ---
document.getElementById('api-url').value = config.baseUrl;
document.getElementById('api-key').value = config.apiKey;
document.getElementById('api-model').value = config.model;
checkApiStatus();

// === æ–°å¢ï¼šå£ä»¤è‡ªåŠ¨é…ç½®åŠŸèƒ½ (ç¾åŒ–å‡çº§ç‰ˆ) ===
async function applySecretCode() {
    const codeInput = document.getElementById('secret-code');
    const code = codeInput.value.trim();

    // è¿™é‡Œè®¾å®šä½ çš„å£ä»¤æ˜¯ "404VIP"
    if (code === "404VIP") {
        // 1. è‡ªåŠ¨å¡«å…¥ä½ çš„é…ç½®
        document.getElementById('api-url').value = "https://gcli.ggchan.dev/v1";
        document.getElementById('api-key').value = "gg-gcli-sevpzHoR8GJmy6nm9vpNb-1lRLCbl0-76KReiz3Ubh0";
        
        // è‡ªåŠ¨å¡«å…¥æ¨¡å‹ï¼Œé˜²æ­¢å®ƒæ˜¯ä¸‹æ‹‰æ¡†å¯¼è‡´èµ‹å€¼å¤±è´¥
        const modelInput = document.getElementById('api-model');
        if (modelInput.tagName === 'SELECT') {
            const tempInput = document.createElement('input');
            tempInput.type = 'text';
            tempInput.className = 'pixel-input';
            tempInput.id = 'api-model';
            modelInput.parentNode.replaceChild(tempInput, modelInput);
        }
        document.getElementById('api-model').value = "gemini-3-flash-preview";

        // 2. ä¿å­˜
        saveSettings(); 
        
        // 3. è§†è§‰åé¦ˆï¼šä½¿ç”¨æ¼‚äº®å¼¹çª—ï¼Œè€Œä¸æ˜¯ä¸‘é™‹çš„alert
        // å…ˆæ˜¾ç¤ºç¬¬ä¸€é˜¶æ®µï¼šéªŒè¯æˆåŠŸ
        showPixelMsg("ğŸ”“ èº«ä»½éªŒè¯æˆåŠŸï¼<br><span style='color:var(--dim); font-size:0.9rem'>æ­£åœ¨æ¥å…¥ GCLI-NODE...</span>");

        // 4. ç¨å¾®åœé¡¿1ç§’ï¼Œè®©ç©å®¶çœ‹æ¸…æç¤ºï¼Œç„¶åå¼€å§‹æµ‹è¯•è¿æ¥
        setTimeout(async () => {
            await testConnection(); // æ‰§è¡Œè¿æ¥æµ‹è¯•
            
            // è·å–æµ‹è¯•ç»“æœï¼ˆå°±æ˜¯è®¾ç½®é¢æ¿ä¸Šé‚£ä¸ªå°å­—çš„å…ƒç´ ï¼‰
            const resultMsg = document.getElementById('test-msg');
            
            // å¦‚æœæµ‹è¯•æˆåŠŸï¼ˆæ ¹æ®æ–‡å­—é¢œè‰²åˆ¤æ–­ï¼Œsuccessç±»æ˜¯ç»¿è‰²çš„ï¼‰
            if (resultMsg.classList.contains('success')) {
                // æ›´æ–°å¼¹çª—ä¸ºæœ€ç»ˆæˆåŠŸçŠ¶æ€
                showPixelMsg("âœ… ç¥ç»è¿æ¥å»ºç«‹å®Œæ¯•ï¼<br><span style='color:var(--accent-glitch); font-weight:bold;'>ä¿¡å·åŒæ­¥ç‡ 100%</span><br><span style='font-size:0.8rem; color:#aaa'>(è¯·ç‚¹å‡»ç¡®å®šæˆ–èƒŒæ™¯å…³é—­)</span>");
            } else {
                // å¦‚æœè¿æ¥å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                showPixelMsg("âš ï¸ éªŒè¯é€šè¿‡ä½†è¿æ¥å¤±è´¥<br><span style='font-size:0.8rem; color:var(--accent-red)'>" + resultMsg.innerText + "</span>");
            }
        }, 1200); // 1.2ç§’å»¶è¿Ÿï¼Œè¥é€ ä¸€ç§æ­£åœ¨è®¡ç®—çš„æ„Ÿè§‰

        // 5. æ¸…ç©ºå£ä»¤æ¡†
        codeInput.value = "";
        
    } else {
        // é”™è¯¯æç¤ºä¹Ÿæ”¹æˆç¾åŒ–ç‰ˆ
        showPixelMsg("âŒ å£ä»¤é”™è¯¯ï¼šæ‹’ç»è®¿é—®ã€‚<br><span style='color:var(--accent-red); font-size:0.8rem'>IPåœ°å€å·²è®°å½•...</span>");
        codeInput.value = "";
    }
}

function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

function saveSettings() {
    config.baseUrl = document.getElementById('api-url').value.replace(/\/$/, "");
    config.apiKey = document.getElementById('api-key').value;
    config.model = document.getElementById('api-model').value;
    localStorage.setItem('mc_base_url', config.baseUrl);
    localStorage.setItem('mc_api_key', config.apiKey);
    localStorage.setItem('mc_model', config.model);
    checkApiStatus();
    closeSettings();
}

function checkApiStatus() {
    const btn = document.getElementById('btn-enter-town');
    const indicator = document.getElementById('api-status-indicator');
    if (config.apiKey && config.apiKey.length > 5) {
        btn.disabled = false;
        indicator.innerText = "[ âˆš ç¥ç»è¿æ¥å°±ç»ª ]";
        indicator.style.color = "var(--accent-glitch)";
    } else {
        btn.disabled = true;
        indicator.innerText = "[ âš ï¸ ç¥ç»è¿æ¥æœªå°±ç»ª ]";
        indicator.style.color = "var(--dim)";
    }
}

// === æ–°å¢ï¼šå­˜æ¡£ç³»ç»Ÿ ===
function checkSaveFile() {
    const save = localStorage.getItem('mc_save_data');
    const btn = document.getElementById('btn-continue');
    if (save) {
        btn.style.display = 'block';
        btn.innerText = `ğŸ“‚ è¯»å–å­˜æ¡£ (DAY ${JSON.parse(save).day})`;
    } else {
        btn.style.display = 'none';
    }
}

function saveGame() {
    try {
        localStorage.setItem('mc_save_data', JSON.stringify(gameState));
        alert("âœ… è¿›åº¦å·²ä¿å­˜è‡³æœ¬åœ°ç¥ç»å›è·¯ã€‚");
        checkSaveFile(); // åˆ·æ–°æ ‡é¢˜ç”»é¢æŒ‰é’®çŠ¶æ€
    } catch (e) {
        alert("âŒ ä¿å­˜å¤±è´¥: " + e.message);
    }
}

function loadGame() {
    const save = localStorage.getItem('mc_save_data');
    if (!save) return alert("æœªæ‰¾åˆ°å­˜æ¡£è®°å½•ã€‚");
    
    if (confirm("ç¡®å®šè¦è¯»å–å­˜æ¡£å—ï¼Ÿå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚")) {
        try {
            const loadedState = JSON.parse(save);
            // è¦†ç›–å½“å‰çŠ¶æ€
            gameState = loadedState;
            
            // æ¢å¤ç•Œé¢
            document.getElementById('title-screen').classList.remove('active');
            document.getElementById('intro-layer').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            
            // åˆ·æ–°æ‰€æœ‰UI
            updateStatsUI();
            addToLog("[ç³»ç»Ÿ] å­˜æ¡£è¯»å–æˆåŠŸã€‚");
            
            // å°è¯•æ¢å¤ä¸Šä¸€æ¡æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
            if (gameState.history.length > 0) {
                const lastMsg = gameState.history[gameState.history.length - 1];
                if (lastMsg.role === 'assistant') {
                    // ç®€å•çš„æ¢å¤æ˜¾ç¤ºï¼Œä¸è§¦å‘æ‰“å­—æœº
                    document.getElementById('main-text').innerText = "ï¼ˆ...è®°å¿†é‡è½½å®Œæˆ...ï¼‰";
                    setTimeout(() => {
                         // è¿™é‡Œæˆ‘ä»¬ä¸é‡æ–°è§£æJSONï¼Œåªæ˜¯ç»™ä¸ªæç¤ºï¼Œè®©ç©å®¶ç»§ç»­æ“ä½œ
                         handleScene('continue', 'è¯»å–å­˜æ¡£åç»§ç»­');
                    }, 1000);
                }
            } else {
                handleScene('intro_day1'); // å¦‚æœæ˜¯åæ¡£ï¼Œé‡ç½®åˆ°ç¬¬ä¸€å¤©
            }
            
        } catch (e) {
            alert("âŒ å­˜æ¡£æŸå: " + e.message);
        }
    }
}

function deleteSave() {
    if (confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤å­˜æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) {
        localStorage.removeItem('mc_save_data');
        checkSaveFile();
        alert("å­˜æ¡£å·²ç²‰ç¢ã€‚");
    }
}

// åˆå§‹åŒ–æ—¶æ£€æŸ¥å­˜æ¡£
window.addEventListener('load', checkSaveFile);


async function testConnection() {
    const msgEl = document.getElementById('test-msg');
    
    // === ä¼˜åŒ–ï¼šç›´æ¥è¯»å–è¾“å…¥æ¡†é‡Œçš„æœ€æ–°å€¼ï¼Œä¸ç”¨éå¾—å…ˆç‚¹ä¿å­˜ ===
    const currentUrl = document.getElementById('api-url').value.replace(/\/$/, "");
    const currentKey = document.getElementById('api-key').value.trim();
    const currentModel = document.getElementById('api-model').value;

    if (!currentKey) {
        msgEl.innerText = "âŒ é”™è¯¯ï¼šè¯·å…ˆå¡«å…¥ API Key"; 
        msgEl.className = "status-msg error";
        return;
    }

    msgEl.innerText = "æ­£åœ¨å‘¼å«çµç•Œä¿¡å·..."; 
    msgEl.className = "status-msg";
    
    try {
        const response = await fetch(`${currentUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${currentKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                model: currentModel, 
                messages: [{ role: "user", content: "Say OK" }], 
                max_tokens: 5 
            })
        });
        
        if (response.ok) {
            msgEl.innerText = "âœ… è¿æ¥æˆåŠŸï¼çµç•Œä¿¡å·ç¨³å®šã€‚"; 
            msgEl.className = "status-msg success";
            // æµ‹è¯•æˆåŠŸé¡ºä¾¿è‡ªåŠ¨ä¿å­˜ä¸€ä¸‹ï¼Œçœå¾—å¿˜äº†
            saveSettings(); 
        } else { 
            // å°è¯•è¯»å–é”™è¯¯ä¿¡æ¯
            const errData = await response.json().catch(() => ({}));
            const errMsg = errData.error?.message || response.statusText;
            throw new Error(`HTTP ${response.status}: ${errMsg}`); 
        }
    } catch (e) {
        console.error("API Error:", e);
        let showMsg = "âŒ è¿æ¥å¤±è´¥: " + e.message;
        if (e.message.includes("Failed to fetch")) {
            showMsg = "âŒ è¿æ¥è¢«é˜»æ–­ (CORSæˆ–ç½‘ç»œé—®é¢˜)ï¼Œè¯·æ£€æŸ¥ä»£ç†åœ°å€ã€‚";
        }
        // å¦‚æœæ˜¯ 401ï¼Œæç¤ºæ›´æ˜ç¡®ä¸€ç‚¹
        if (e.message.includes("401")) {
            showMsg = "âŒ é‰´æƒå¤±è´¥ (401)ï¼šAPI Key æ— æ•ˆæˆ–ä½™é¢ä¸è¶³ã€‚";
        }
        msgEl.innerText = showMsg; 
        msgEl.className = "status-msg error";
    }
}

// å®šä¹‰å…¨å±€æ§åˆ¶å™¨ï¼ˆå¦‚æœåˆšæ‰æ²¡åŠ ï¼Œè¿™é‡ŒåŠ ä¸Šï¼›å¦‚æœåŠ äº†ï¼Œè¦†ç›–ä¹Ÿæ²¡äº‹ï¼‰
let modelAbortController = null; 

async function fetchModels() {
    // === ä¿®å¤æ ¸å¿ƒï¼šå®æ—¶è·å–è¾“å…¥æ¡†é‡Œçš„ URL å’Œ Keyï¼Œè€Œä¸æ˜¯è¯»å–æ—§é…ç½® ===
    const currentUrl = document.getElementById('api-url').value.replace(/\/$/, "");
    const currentKey = document.getElementById('api-key').value;

    if(!currentKey) return alert("è¯·è¾“å…¥Key");

    const btn = document.activeElement; 
    const isBtn = btn && btn.tagName === 'BUTTON';
    const inputEl = document.getElementById('api-model'); // è·å–å½“å‰çš„è¾“å…¥æ¡†

    // 1. å–æ¶ˆé€»è¾‘
    if (modelAbortController) {
        modelAbortController.abort();
        modelAbortController = null;
        if(isBtn) {
            btn.innerText = "åˆ—è¡¨";
            btn.disabled = false;
        }
        return;
    }

    // 2. å¼€å§‹æ‹‰å–
    modelAbortController = new AbortController();
    const signal = modelAbortController.signal;

    if(isBtn) btn.innerText = "å–æ¶ˆ (15s)";
    
    // è¶…æ—¶è®¡æ—¶å™¨
    const timeoutId = setTimeout(() => {
        if (modelAbortController) {
            modelAbortController.abort();
            alert("âš ï¸ è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
        }
    }, 15000);

    try {
        // === ä¿®å¤ï¼šä½¿ç”¨ currentUrl å‘é€è¯·æ±‚ ===
        const res = await fetch(`${currentUrl}/models`, {
            method: 'GET', 
            headers: { 'Authorization': `Bearer ${currentKey}` },
            signal: signal
        });
        
        clearTimeout(timeoutId);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        // è·å–æ¨¡å‹æ•°ç»„
        const modelList = (data.data || data).map(m => m.id || m);

        if(modelList.length === 0) throw new Error("æœªæ‰¾åˆ°æ¨¡å‹");

        // === âœ¨ æ ¸å¿ƒé­”æ³•ï¼šåŸåœ°å˜èº«ä¸‹æ‹‰èœå• ===
        
        // 1. åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹æ‹‰æ¡†
        const select = document.createElement('select');
        select.id = 'api-model'; // ä¿æŒIDä¸å˜ï¼Œè¿™æ ·ä¿å­˜åŠŸèƒ½ä¾ç„¶æœ‰æ•ˆ
        select.className = 'pixel-input'; // ä¿æŒæ ·å¼ä¸å˜
        
        // 2. å¡«å……é€‰é¡¹
        modelList.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.innerText = m;
            // å¦‚æœå’Œå½“å‰å¡«çš„ä¸€æ ·ï¼Œè‡ªåŠ¨é€‰ä¸­
            if(m === config.model) opt.selected = true;
            select.appendChild(opt);
        });

        // 3. æ›¿æ¢æ‰åŸæ¥çš„è¾“å…¥æ¡†
        inputEl.parentNode.replaceChild(select, inputEl);

        // 4. æç¤ºæˆåŠŸ
        if(isBtn) btn.innerText = "âˆš å°±ç»ª";
        setTimeout(() => { if(isBtn) btn.innerText = "åˆ—è¡¨"; }, 2000);

    } catch(e) { 
        if (e.name !== 'AbortError') {
            console.error(e);
            alert("âš ï¸ æ‹‰å–å¤±è´¥: " + e.message); 
        }
    } finally {
        modelAbortController = null;
        clearTimeout(timeoutId);
        if(isBtn && btn.innerText.includes("å–æ¶ˆ")) {
            btn.innerText = "åˆ—è¡¨";
            btn.disabled = false;
        }
    }
}

// === æ–°å¢ï¼šéšæœºäººè®¾åº“ ===
const R_NAMES = ["é˜¿å¼º", "Lisa", "è€ç‹", "Kå…ˆç”Ÿ", "é™ˆæŸ", "å°ç¾", "ä¸§å½ª", "æ— åæ°", "å‘¨å‘¨", "é˜¿è±ª"];
const R_JOBS = [
    "è¢«è£å‘˜çš„ç¨‹åºå‘˜", 
    "çµå¼‚å¤§å·´å¸æœº", 
    "ä¸‰æµå°è¯´å®¶", 
    "å…¼èŒå¤–å–å‘˜çš„é“å£«", 
    "è¿‡æ°”ç½‘çº¢", 
    "æ‹¥æœ‰é»‘å®¢æŠ€æœ¯çš„å®…ç”·", 
    "æ·±å¤œä¾¿åˆ©åº—åº—å‘˜", 
    "ä¸“é—¨æ‰¾çŒ«çš„ä¾¦æ¢"
];
const R_EXTRAS = [
    "ç©·ç¥é™„ä½“ï¼ˆçœŸçš„æ²¡é’±ï¼‰", 
    "é‡åº¦æ‹–å»¶ç—‡", 
    "åªå–å†°ç¾å¼", 
    "èƒ½çœ‹è§é¬¼ä½†å‡è£…çœ‹ä¸è§", 
    "çŒ«æ¯›è¿‡æ•", 
    "å¤œçŒ«å­", 
    "ç¤¾æåçº§", 
    "è¿æ°”æ€»æ˜¯å·®ä¸€ç‚¹ç‚¹"
];

function randomizeInputs() {
    document.getElementById('char-name').value = R_NAMES[Math.floor(Math.random() * R_NAMES.length)];
    document.getElementById('char-job').value = R_JOBS[Math.floor(Math.random() * R_JOBS.length)];
    document.getElementById('char-extra').value = R_EXTRAS[Math.floor(Math.random() * R_EXTRAS.length)];
}

// === æ–°å¢ï¼šä¸€é”®æ¢ç´¢åŠŸèƒ½ ===
function triggerExplore() {
    if (avgState.isWaitingForAI) return showPixelMsg("æ­£åœ¨è¿æ¥çµç•Œï¼Œè¯·ç¨å€™...");
    
    // éšè—é€‰é¡¹å±‚ï¼Œé˜²æ­¢å†²çª
    document.getElementById('choices-layer').classList.remove('active');
    
    // æ’­æ”¾ä¸€ä¸ªç®€å•çš„ç‚¹å‡»åé¦ˆåŠ¨ç”»ï¼ˆå¯é€‰ï¼‰
    const btn = event.currentTarget;
    btn.style.transform = "scale(0.9)";
    setTimeout(() => btn.style.transform = "scale(1)", 100);

    // ç›´æ¥è°ƒç”¨åœºæ™¯å¤„ç†ï¼Œä¼ å…¥ç‰¹æ®ŠåŠ¨ä½œ 'explore_current_location'
    handleScene('explore_current_location');
}


// === æ–°å¢ï¼šè‡ªç”±è¡ŒåŠ¨å¤„ç† ===
function submitFreeAction() {
    const inputEl = document.getElementById('free-input');
    const actionText = inputEl.value.trim();
    
    if (!actionText) return;
    if (avgState.isWaitingForAI) return alert("æ­£åœ¨è¿æ¥çµç•Œï¼Œè¯·ç¨å€™...");
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    inputEl.value = "";
    
    // éšè—é€‰é¡¹å±‚ï¼Œé˜²æ­¢å†²çª
    document.getElementById('choices-layer').classList.remove('active');
    
    // ä¿®æ”¹é€»è¾‘ï¼šä¸å†ç›´æ¥ç”Ÿæˆå‰§æƒ…ï¼Œè€Œæ˜¯å…ˆè¯·æ±‚AIè¿›è¡Œâ€œè£åˆ¤åˆ¤å®šâ€
    handleScene('judge_action', actionText);
}


// --- 2. è§’è‰²åˆ›å»ºä¸æ¡£æ¡ˆç”Ÿæˆ ---

function goToCharCreation() {
    document.getElementById('title-screen').classList.remove('active');
    document.getElementById('char-screen').classList.add('active');
}

async function generatePersona() {
    const name = document.getElementById('char-name').value.trim();
    const job = document.getElementById('char-job').value.trim();
    const extra = document.getElementById('char-extra').value.trim();

    if (!name || !job) return alert("è¯·è‡³å°‘å¡«å†™å§“åå’Œå‰èŒã€‚");

    gameState.player = { name, job, extra, desc: "" };

    document.getElementById('char-screen').classList.remove('active');
    document.getElementById('persona-screen').classList.add('active');
    document.getElementById('persona-loading').style.display = 'block';
    document.getElementById('persona-result').style.display = 'none';

    // === ä¿®æ”¹ï¼šæç¤ºè¯è¦æ±‚ D100 æ•°å€¼ä½“ç³» ===
    const prompt = `
    ç©å®¶æ­£åœ¨åˆ›å»ºè§’è‰²ï¼Œæ¸¸æˆé£æ ¼ä¸ºï¼šç°ä»£éƒ½å¸‚æ€ªè°ˆ + é»‘è‰²å¹½é»˜ + è´«ç©·æ¨¡æ‹Ÿå™¨ã€‚
    
    å§“åï¼š${name}
    å‰èŒä¸šï¼š${job}
    é¢å¤–ç‰¹è´¨/æ€ªç™–ï¼š${extra || "å¹³å¹³æ— å¥‡"}
    
    è¯·ç”Ÿæˆä¸€ä¸ª**ç°ä»£æ„Ÿå¼ºã€å¸¦ç‚¹è‡ªå˜²æˆ–åæ§½é£æ ¼**çš„äººç‰©ä¾§å†™ã€‚
    
    é‡ç‚¹æè¿°ï¼š
    1. ä½ çš„ç»æµçŠ¶å†µï¼ˆé€šå¸¸ä¸å¤ªå¥½ï¼‰ã€‚
    2. ä½ ä¸ºä»€ä¹ˆè½¬èŒä½åœ¨404å·è¿™ç§ç ´å»‰ç§Ÿå…¬å¯“é‡Œå½“ç§å®¶ä¾¦æ¢ã€‚
    3. ä½ å¯¹å¾…â€œçµå¼‚äº‹ä»¶â€çš„æ€åº¦ã€‚
    
    ã€é‡è¦ç¦ä»¤ã€‘ï¼š
    æè¿°ä¸­**ç»å¯¹ä¸è¦**åŒ…å«å…·ä½“çš„ HPã€SANã€é‡‘é’± ç­‰æ•°å€¼ã€‚
    
    å¹¶æ ¹æ®èŒä¸šå’Œç‰¹è´¨ï¼Œç”Ÿæˆä»¥ä¸‹å±æ€§æ•°å€¼ï¼ˆ**é‡‡ç”¨ D100 è§„åˆ™ï¼ŒèŒƒå›´ 1-99ï¼Œæ™®é€šäººå¹³å‡ 50**ï¼‰ï¼š
    - PHY (ä½“é­„): æŠ—æèƒ½åŠ› (å»ºè®® 40-80)
    - DEX (çµå·§): è·‘è·¯é€Ÿåº¦ (å»ºè®® 40-80)
    - INT (å­¦è¯†): çŸ¥è¯†æ°´å¹³ (å»ºè®® 40-90)
    - CHA (é­…åŠ›): é¢œå€¼å£æ‰ (å»ºè®® 30-80)
    - MYS (çµè§†): çµæ„Ÿ/é€šçµ (å»ºè®® 20-70)
    
    è¯·ä¸¥æ ¼è¿”å›JSONæ ¼å¼ï¼š
    {
        "description": "ä¸€æ®µç¬¬äºŒäººç§°çš„æè¿°...",
        "phy": 50,
        "dex": 50,
        "int": 50,
        "cha": 50,
        "mys": 50
    }
    `;

    const result = await callAI(prompt, true);

    if (result) {
        document.getElementById('persona-loading').style.display = 'none';
        document.getElementById('persona-result').style.display = 'block';
        
        document.getElementById('dossier-name').innerText = `NAME: ${name}`;
        document.getElementById('dossier-job').innerText = `JOB: ${job}`;
        document.getElementById('dossier-desc').innerText = result.description;
        
        gameState.player.desc = result.description;

        document.getElementById('p-phy').innerText = result.phy;
        document.getElementById('p-dex').innerText = result.dex;
        document.getElementById('p-int').innerText = result.int;
        document.getElementById('p-cha').innerText = result.cha;
        document.getElementById('p-mys').innerText = result.mys;

        // === ä¿®æ”¹ï¼šHP å’Œ SAN çš„è®¡ç®—å…¬å¼é€‚é… D100 ===
        // HP = (ä½“é­„ + 80) / 2ï¼Œè¿™æ ·å¤§éƒ¨åˆ†äººåœ¨ 60-80 è¡€ä¹‹é—´ï¼Œæ¯”è¾ƒåˆç†
        const hp = Math.floor((result.phy + 80) / 2);
        // SAN = çµè§† (MYS) ä¹Ÿå°±æ˜¯æ„å¿—åŠ›
        const san = result.mys;

        document.getElementById('p-hp').innerText = hp;
        document.getElementById('p-san').innerText = san;

        gameState.stats = {
            hp: hp, maxHp: hp,
            san: san, maxSan: san,
            phy: result.phy, dex: result.dex, int: result.int, cha: result.cha, mys: result.mys
        };
        
        gameState.inventory.push({
            id: "dice", name: "å‘½è¿éª°å­", type: "key", count: 1,
            desc: "ä¸€é¢—ç£¨æŸçš„ç™¾é¢éª°å­(D100)ï¼Œæ¯ä¸€æ¬¡æ»šåŠ¨éƒ½æ˜¯å‘½è¿çš„ä½è¯­ã€‚",
            desc_insane: "å®ƒåœ¨çœ‹ç€ä½ ã€‚ä¸Šé¢çš„æ•°å­—åœ¨ä¸æ–­å˜åŒ–ï¼Œä»¿ä½›åœ¨å€’è®¡æ—¶ã€‚",
            effect: "none"
        });

    } else {
        alert("æ¡£æ¡ˆç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚");
        document.getElementById('persona-screen').classList.remove('active');
        document.getElementById('char-screen').classList.add('active');
    }
}

function realStartGame() {
    document.getElementById('persona-screen').classList.remove('active');
    document.getElementById('game-screen').classList.add('active');
    updateStatsUI();
    // å¼ºåˆ¶è¿›å…¥ Day 1 æ•™å­¦æµç¨‹
    handleScene("intro_day1");
}

// --- 3. æ¸¸æˆä¸»å¾ªç¯ (æ ¸å¿ƒäº¤äº’é€»è¾‘) ---

function updateStatsUI() {
    document.getElementById('val-hp').innerText = gameState.stats.hp;
    document.getElementById('val-san').innerText = gameState.stats.san;
    document.getElementById('val-money').innerText = gameState.money;
    
    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    document.getElementById('day-num').innerText = `DAY ${gameState.day}`;
    document.getElementById('time-icon').innerText = TIME_ICONS[gameState.timePhase];
    document.getElementById('time-text').innerText = TIME_PHASES[gameState.timePhase];
    
    // äº‹åŠ¡æ‰€HUDæ§åˆ¶
    const officeHud = document.getElementById('office-hud');
    // ä¿®æ”¹ï¼šåªè¦åå­—é‡ŒåŒ…å« 404 æˆ–è€… äº‹åŠ¡æ‰€ï¼Œå°±æ˜¾ç¤ºäº‹åŠ¡æ‰€æŒ‰é’®
    if (gameState.currentLocation && gameState.currentLocation.match(/äº‹åŠ¡æ‰€|404|Home/)) {
        officeHud.classList.add('active');
    } else {
        officeHud.classList.remove('active');
    }
    
    // å•†åº—HUDæ§åˆ¶ (æ–°å¢)
    const shopHud = document.getElementById('shop-hud');
    
    // === æš´åŠ›ä¿®å¤æ ¸å¿ƒ ===
    // ä¸å†å»æŸ¥é‚£ä¸ªå¤æ‚çš„è¡¨æ ¼äº†ï¼Œç›´æ¥çœ‹åœ°ç‚¹åå­—ï¼
    // åªè¦åœ°ç‚¹åå­—é‡ŒåŒ…å«ï¼šä¾¿åˆ©åº—ã€è¶…å¸‚ã€å•†åº—... ä¸”ä¸åŒ…å«â€œä»“åº“â€ã€â€œåå··â€ç­‰éè¥ä¸šåŒºåŸŸï¼Œæ‰æ˜¾ç¤ºè´­ä¹°æŒ‰é’®
    const locName = gameState.currentLocation;
    const isShoppingArea = /ä¾¿åˆ©åº—|è¶…å¸‚|å•†åº—|è¯Šæ‰€|è¯åº—|å•†åœº|é»‘å¸‚|Shop|Store|Mart|Clinic/i.test(locName);
    const isNotHiddenArea = !/ä»“åº“|åå··|ä¸‹æ°´é“|æš—å®¤|Bedroom|Storage/i.test(locName); // æ’é™¤æ‰éè¥ä¸šåŒºåŸŸ

    if (isShoppingArea && isNotHiddenArea) {
        shopHud.classList.add('active');
    } else {
        shopHud.classList.remove('active');
    }

    // æ›´æ–°çŠ¶æ€é¢æ¿
    document.getElementById('s-bio-text').innerText = gameState.player.desc || "æš‚æ— æ•°æ®...";
    // æ–°å¢ï¼šæ›´æ–°å£°æœ›
    document.getElementById('s-rep').innerText = gameState.reputation;
    
    document.getElementById('s-phy').innerText = gameState.stats.phy;
    document.getElementById('s-dex').innerText = gameState.stats.dex;
    document.getElementById('s-int').innerText = gameState.stats.int;
    document.getElementById('s-cha').innerText = gameState.stats.cha;
    document.getElementById('s-mys').innerText = gameState.stats.mys;
    document.getElementById('s-hp').innerText = `${gameState.stats.hp} / ${gameState.stats.maxHp}`;
    document.getElementById('s-san').innerText = `${gameState.stats.san} / ${gameState.stats.maxSan}`;

    if (gameState.stats.san < 30) document.body.classList.add('glitch-text');
    else document.body.classList.remove('glitch-text');
}

function processSceneData(data) {
    // === ä¼˜å…ˆå¤„ç†åœ°ç‚¹å˜æ›´ ===
    if (data.move_to && data.move_to.toLowerCase() !== "none" && data.move_to.toLowerCase() !== "null" && data.move_to.trim() !== "") {
        if (gameState.currentLocation !== data.move_to) {
            currentShopItems = []; 
        }
        gameState.currentLocation = data.move_to;
    }

    // === æ–°å¢ï¼šä¼˜å…ˆå¤„ç†æ—¶é—´å˜æ›´ (å¬ä»AIçš„ç›´æ¥æŒ‡æŒ¥) ===
    // ä½ çš„æ€è·¯ï¼šç›´æ¥è¯»å– AI å‘å›çš„ change_time å­—æ®µï¼Œå‡†ç¡®æ— è¯¯ï¼
    if (typeof data.change_time !== 'undefined' && data.change_time !== null) {
        let newTime = parseInt(data.change_time);
        if (newTime >= 0 && newTime <= 3) {
            gameState.timePhase = newTime;
            updateStatsUI(); // åˆ·æ–°å³ä¸Šè§’å›¾æ ‡
            updateSceneBackground(gameState.currentLocation); // åˆ·æ–°èƒŒæ™¯å›¾(ç™½å¤©/é»‘å¤œ)
        }
    }

    // === å¤„ç†ç¡å‰ Quiz ===
    if (data.quiz) {
        gameState.mystery.tempQuizData = data.quiz;
        const options = data.quiz.options.map((opt, index) => ({
            text: opt,
            action: "quiz_answer", 
            rawIndex: index
        }));
        data.choices = options;
    }

    // === å¤„ç†æ ¸å¿ƒè°œå›¢ç”Ÿæˆ ===
    if (data.mystery_setup && (!gameState.mystery.active || gameState.mystery.title !== data.mystery_setup.title)) {
        gameState.mystery.active = true;
        gameState.mystery.title = data.mystery_setup.title;
        gameState.mystery.truth = data.mystery_setup.truth;
        gameState.mystery.deadlineDay = gameState.day + (data.mystery_setup.days_limit || 3);
        gameState.mystery.status = "pending";
        
        data.description += `\n\n<div style="border:1px solid var(--accent-red); background:rgba(50,0,0,0.3); padding:15px; margin:15px 0; text-align:center; animation: blink 2s infinite;">
            <div style="color:var(--accent-red); font-weight:bold; font-size:1.2rem; letter-spacing:2px;">âš ï¸ è§¦å‘æ ¸å¿ƒè°œå›¢</div>
            <div style="color:#fff; font-size:1.1rem; margin:5px 0;">ã€ ${gameState.mystery.title} ã€</div>
            <div style="color:#aaa; font-size:0.9rem;">å¿…é¡»åœ¨ Day ${gameState.mystery.deadlineDay} ç»“æŸå‰æŸ¥æ¸…çœŸç›¸</div>
        </div>`;
        
        gameState.quests.push({ 
            id: 'mystery_'+Date.now(), 
            text: `[æ ¸å¿ƒ] è§£å†³è°œå›¢ï¼š${gameState.mystery.title} (æˆªæ­¢: Day ${gameState.mystery.deadlineDay})`, 
            active: true 
        });
    }

    // === å¤„ç†è°œå›¢ç»“ç®—ç»“æœ ===
    if (data.mystery_result) {
        gameState.mystery.active = false; 
        gameState.mystery.truth = "";    
        
        if (data.mystery_result.success) {
            gameState.reputation += 20;
            gameState.money += 1000;
            gameState.stats.san = Math.min(gameState.stats.maxSan, gameState.stats.san + 20);
            data.description += `\n<span style="color:#0f0; font-size:1.2rem;">[ âœ… è°œé¢˜ç ´è§£æˆåŠŸï¼ ]</span>\nè·å¾—ï¼šå£°æœ›+20, èµ„é‡‘+1000, SAN+20`;
        } else {
            gameState.reputation -= 10;
            gameState.stats.san -= 20;
            gameState.stats.maxHp -= 10;
            data.description += `\n<span style="color:#f00; font-size:1.2rem;">[ âŒ è°œé¢˜ç ´è§£å¤±è´¥... ]</span>\næƒ©ç½šï¼šå£°æœ›-10, SAN-20, ç”Ÿå‘½ä¸Šé™æ°¸ä¹…-10`;
        }
    }

    updateStatsUI(); 
    document.getElementById('scene-title').innerText = gameState.currentLocation;
    updateSceneBackground(gameState.currentLocation);

    // === â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå±æ€§æ•°å€¼æŠ“å– (æ— åå¼•å·å®‰å…¨ç‰ˆ) â˜…â˜…â˜… ===
    const regexStats = /(HP|SAN|REP|PHY|DEX|INT|CHA|MYS|Life|ç†æ™º|ç”Ÿå‘½|å£°æœ›|ä½“é­„|çµå·§|å­¦è¯†|é­…åŠ›|çµè§†)[ :]?([+\-]\d+)/gi;
    let matchStat;
    let statChanged = false;
    let hpDamageTaken = false;
    
    while ((matchStat = regexStats.exec(data.description)) !== null) {
        let type = matchStat[1].toUpperCase();
        let val = parseInt(matchStat[2]); 
        
        if (type.match(/HP|LIFE|ç”Ÿå‘½/)) {
            gameState.stats.hp += val;
            if (gameState.stats.hp > gameState.stats.maxHp) gameState.stats.hp = gameState.stats.maxHp;
            if (gameState.stats.hp < 0) gameState.stats.hp = 0;
            if (val < 0) hpDamageTaken = true;
            statChanged = true;
        }
        else if (type.match(/SAN|ç†æ™º/)) {
            gameState.stats.san += val;
            if (gameState.stats.san > gameState.stats.maxSan) gameState.stats.san = gameState.stats.maxSan;
            if (gameState.stats.san < 0) gameState.stats.san = 0;
            statChanged = true;
        }
        else if (type.match(/REP|å£°æœ›/)) {
            gameState.reputation += val;
            statChanged = true;
        }
        // å¼ºåŒ–å±æ€§
        else if (type.match(/PHY|ä½“é­„/)) { gameState.stats.phy += val; statChanged = true; }
        else if (type.match(/DEX|çµå·§/)) { gameState.stats.dex += val; statChanged = true; }
        else if (type.match(/INT|å­¦è¯†/)) { gameState.stats.int += val; statChanged = true; }
        else if (type.match(/CHA|é­…åŠ›/)) { gameState.stats.cha += val; statChanged = true; }
        else if (type.match(/MYS|çµè§†/)) { gameState.stats.mys += val; statChanged = true; }
    }

    if (hpDamageTaken) {
        const visualArea = document.getElementById('visual-area');
        const flash = document.createElement('div');
        flash.style.position = "absolute";
        flash.style.top = "0"; flash.style.left = "0";
        flash.style.width = "100%"; flash.style.height = "100%";
        flash.style.background = "rgba(255,0,0,0.4)";
        flash.style.zIndex = "99";
        flash.style.pointerEvents = "none";
        flash.style.transition = "opacity 0.5s";
        visualArea.appendChild(flash);
        setTimeout(() => flash.style.opacity = "0", 100);
        setTimeout(() => flash.remove(), 600);
    }
    if (statChanged) updateStatsUI();

    // 1. SAN Check
    if (data.event === 'san_check') {
        const roll = Math.floor(Math.random() * 100) + 1;
        const success = roll <= gameState.stats.san;
        const dmg = success ? 0 : Math.floor(Math.random() * 10) + 1;
        gameState.stats.san -= dmg;
        updateStatsUI();
        const checkText = `[SANæ£€å®š: ${roll}/${gameState.stats.san + dmg}] ${success ? 'ä½ ç¨³ä½äº†å¿ƒç¥ã€‚' : 'ä½ çš„ç†æ™ºå—åˆ°äº†å†²å‡»ï¼(SAN -'+dmg+')'}`;
        data.description = checkText + "\n" + data.description;
    }

    // 2. Loot ç»“ç®—
    if (data.loot && Array.isArray(data.loot) && data.loot.length > 0) {
        let lootText = "";
        data.loot.forEach(item => {
            if (typeof item === 'string') item = { name: item, type: 'misc', desc: 'è¿™å°±åªæ˜¯ä¸€ä¸ªæ™®é€šçš„' + item + 'ã€‚' };
            if (!item || !item.name) return;

            if (item.name.match(/é‡‘é’±|Money|æŠ¥é…¬|èµ„é‡‘|ä½™é¢|æ•£é’±|é’ç¥¨|ç°é‡‘|Cash|Coin|å…ƒ/i)) {
                let val = parseInt(item.name.replace(/[^0-9]/g, ''));
                if (!val || val <= 0) val = item.count ? item.count * 10 : 50; 
                gameState.money += val;
                lootText += `\n<span style="color:var(--accent-glitch)">[ è´¦æˆ·å…¥è´¦: Â¥${val} ]</span>`;
                return;
            }

            if (item.name.match(/å£°æœ›|Reputation|åå£°/i)) {
                let val = parseInt(item.name.replace(/[^0-9]/g, '')) || item.count || 10;
                gameState.reputation += val;
                lootText += `\n<span style="color:var(--accent-gold)">[ å£°æœ›æå‡: +${val} ]</span>`;
                return;
            }

            if (item.name.match(/å•|ç¥¨|çº¸|ä¹¦|ä¿¡|Bill|Paper|Trash|åƒåœ¾|åºŸ/i)) {
                item.type = 'misc';
                delete item.effect;
            }
            if (!item.desc || item.desc.length < 2) {
                if (item.type === 'consumable') item.desc = "çœ‹èµ·æ¥å¯ä»¥åƒï¼Œä½†ä¸ä¿è¯å‘³é“ã€‚";
                else if (item.type === 'key') item.desc = "è¿™ä¸€å®šèƒ½æ‰“å¼€æŸæ ·ä¸œè¥¿ã€‚";
                else item.desc = "å¹³å¹³æ— å¥‡çš„ç‰©å“ï¼Œä¹Ÿè®¸ä»¥åæœ‰ç”¨ã€‚";
            }
            if (!item.type) {
                if (item.name.match(/è¯|æ°´|é¥­|é¢åŒ…|é…’|èŒ¶|Drink|Food|Pill/i)) item.type = 'consumable';
                else if (item.name.match(/é’¥åŒ™|å¡|Key|Card/i)) item.type = 'key';
                else item.type = 'misc';
            }
            if (item.type === 'consumable' && !item.effect) {
                if (item.name.match(/SAN|ç†æ™º|çƒŸ|é…’|ç³–/i)) item.effect = "san+5";
                else item.effect = "hp+10";
            }

            const existing = gameState.inventory.find(i => i.name === item.name);
            if (existing && existing.type === 'consumable') {
                existing.count = (existing.count || 1) + (item.count || 1);
            } else if (!existing) {
                item.count = item.count || 1;
                item.id = item.id || 'item_' + Date.now() + Math.random();
                if (!item.desc_insane) item.desc_insane = "å®ƒåœ¨çœ‹ç€ä½ ...ç”šè‡³åœ¨å‘¼å¸ã€‚";
                gameState.inventory.push(item);
            }
            lootText += `\n[è·å¾—ç‰©å“: ${item.name}]`;
        });
        updateStatsUI();
        data.description += lootText;
    }

    // 3. åœ°å›¾è§£é”
    if (data.unlock_location && data.unlock_location.toLowerCase() !== "none") {
        const locName = data.unlock_location;
        if (!gameState.unlockedLocations.find(l => l.name === locName)) {
            let locType = 'normal'; 
            if (/å±|æ­»|æš—|ç¦|Danger|Dark/i.test(locName)) locType = 'danger';
            if (/åº—|å•†|Shop|Store|Mart/i.test(locName)) locType = 'shop';
            if (/åŒ»|è¯|Heal|Clinic/i.test(locName)) locType = 'heal';

            gameState.unlockedLocations.push({ 
                name: locName, 
                id: 'loc_' + Date.now(), 
                locked: false, 
                type: locType,
                parent: gameState.currentLocation 
            });
            
            data.description += `\n<span style="color:var(--accent-glitch)">[ åœ°å›¾æ›´æ–°: å‘ç°æ–°åŒºåŸŸ "${locName}" (ä½äº ${gameState.currentLocation} é™„è¿‘) ]</span>`;
        }
    }

    // 4. æ–°çº¿ç´¢
    if (data.new_clue && data.new_clue.toLowerCase() !== "none") {
        const badKeywords = ["æ— ", "å¤±è´¥", "æœªè·å¾—", "æ²¡æœ‰", "None", "Nothing", "Fail"];
        const isBadClue = badKeywords.some(kw => data.new_clue.includes(kw));

        if (!isBadClue) {
            gameState.clues.push(data.new_clue);
            data.description += `\n<span style="color:var(--accent-gold)">[ è®°å½•çº¿ç´¢: ${data.new_clue} ]</span>`;
        } else {
            data.description += `\n<span style="color:var(--dim); font-size:0.9rem;">( ${data.new_clue} )</span>`;
        }
    }

    // 5. ä»»åŠ¡æ›´æ–°
    if (data.update_quest) {
        gameState.quests.forEach(q => q.active = false);
        gameState.quests.push({ id: 'q_'+Date.now(), text: data.update_quest, active: true });
        data.description += `\n<span style="color:var(--accent-glitch); border:1px solid var(--accent-glitch); padding:2px;">[ ä»»åŠ¡æ›´æ–°: ${data.update_quest} ]</span>`;
    }

    // 6. å£°æœ›å˜åŒ–
    if (data.description.includes("å£°æœ›æå‡") || data.description.includes("åå£°å¤§å™ª")) {
        gameState.reputation += 5;
        data.description += `\n<span style="color:var(--accent-gold)">[ â–² å£°æœ›æå‡ ]</span>`;
    }

    avgState.isWaitingForAI = false;
    avgState.isReadyToPlay = true;
    avgState.pendingChoices = [];
    avgState.tempData = data; 

    const choicesLayer = document.getElementById('choices-layer');
    choicesLayer.classList.remove('active');
    choicesLayer.innerHTML = ''; 

    const textEl = document.getElementById('main-text');
    textEl.innerHTML = `<span style="color: var(--accent-glitch); animation: blink 0.5s infinite;">[ ä¿¡å·å·²æ•è· / ç‚¹å‡»è¯»å– ]</span>`;
    document.getElementById('click-arrow').classList.add('show');
}

function startPlayingText(data) {
    let rawText = data.description.replace(/<br>/g, "\n");
    
    // HTMLæ ‡ç­¾ä¿æŠ¤é€»è¾‘
    const htmlTags = [];
    rawText = rawText.replace(/<span[^>]*>.*?<\/span>/g, (match) => {
        htmlTags.push(match);
        return `___HTML_PROTECT_${htmlTags.length - 1}___`; 
    });
    // div å—çº§å…ƒç´ ä¿æŠ¤ (æ–°å¢)
    rawText = rawText.replace(/<div[^>]*>.*?<\/div>/s, (match) => {
        htmlTags.push(match);
        return `___HTML_PROTECT_${htmlTags.length - 1}___`; 
    });

    let sentences = rawText.match(/[^ã€‚ï¼ï¼Ÿ\n]+[ã€‚ï¼ï¼Ÿ\n]+|[^ã€‚ï¼ï¼Ÿ\n]+$/g) || [rawText];
    
    avgState.textQueue = sentences.map(s => {
        let text = s.trim();
        if (text.includes('___HTML_PROTECT_')) {
            text = text.replace(/___HTML_PROTECT_(\d+)___/g, (m, id) => htmlTags[id]);
        }
        return text;
    }).filter(s => s.length > 0);
    
    avgState.pendingChoices = data.choices || []; 
    document.getElementById('choices-layer').innerHTML = ''; 
    document.getElementById('choices-layer').classList.remove('active');
    document.getElementById('click-arrow').classList.remove('show');
    
    nextText(); 
}

function nextText() {
    // 1. å¦‚æœæ­£åœ¨è¿æ¥AIï¼Œç»å¯¹ç¦æ­¢æ“ä½œ
    if (avgState.isWaitingForAI) return;

    // 2. å¦‚æœæ•°æ®åˆšå›æ¥å‡†å¤‡æ’­æ”¾
    if (avgState.isReadyToPlay) {
        avgState.isReadyToPlay = false;
        startPlayingText(avgState.tempData);
        updateLockVisuals(); // å¼€å§‹æ’­æ”¾ï¼Œç«‹å³ä¸Šé”
        return;
    }

    const textEl = document.getElementById('main-text');
    const arrowEl = document.getElementById('click-arrow');

    // 3. ç‚¹å‡»åŠ é€Ÿï¼šå¦‚æœæ­£åœ¨æ‰“å­—ï¼Œç©å®¶ç‚¹å‡»äº†ï¼Œç¬é—´æ˜¾ç¤ºå…¨å¥
    if (avgState.isTyping) {
        clearInterval(avgState.typingTimer);
        textEl.innerHTML = avgState.currentFullText; // æ˜¾ç¤ºå…¨å¥
        avgState.isTyping = false;
        arrowEl.classList.add('show');
        
        // å…³é”®ç‚¹ï¼šåŠ é€Ÿæ‰“å®Œåï¼Œè™½ç„¶isTypingå‡äº†ï¼Œä½†checkInputLockä¼šæ£€æŸ¥é˜Ÿåˆ—
        // å¦‚æœé˜Ÿåˆ—è¿˜æœ‰è¯ï¼ŒUIä¾ç„¶ä¼šä¿æŒé”å®šçŠ¶æ€ï¼Œåªæœ‰å¯¹è¯æ¡†èƒ½ç‚¹
        updateLockVisuals(); 
        return;
    }

    // 4. é˜Ÿåˆ—é‡Œè¿˜æœ‰è¯æ²¡è¯´å®Œ (è¿ç»­æ’­æ”¾é˜¶æ®µ)
    if (avgState.textQueue.length > 0) {
        const nextLine = avgState.textQueue.shift();
        avgState.currentFullText = nextLine;
        
        // åªè¦è¿˜æœ‰è¯æ²¡è¯´å®Œï¼Œå°±ä¿æŒé”å®š
        avgState.isTyping = true;
        updateLockVisuals(); // ç¡®ä¿æ›´æ–°è§†è§‰çŠ¶æ€

        // HTMLç‰¹æ®Šæ¸²æŸ“ï¼ˆç›´æ¥æ˜¾ç¤ºï¼Œä¸æ‰“å­—ï¼‰
        if (nextLine.trim().startsWith('<')) {
            textEl.innerHTML = nextLine; 
            // å»é™¤HTMLæ ‡ç­¾å­˜æ—¥å¿—
            addToLog(nextLine.replace(/<[^>]+>/g, '')); 
            
            avgState.isTyping = false; // ç¬é—´å®Œæˆ
            arrowEl.classList.add('show');
            // å³ä½¿ç¬é—´å®Œæˆï¼Œåªè¦é˜Ÿåˆ—è¿˜æœ‰ä¸‹ä¸€å¥ï¼ŒcheckInputLockä¾ç„¶è¿”å›true
            updateLockVisuals();
            return; 
        }

        // æ™®é€šæ‰“å­—æœºé€»è¾‘
        avgState.charIndex = 0;
        textEl.innerHTML = ""; 
        arrowEl.classList.remove('show');
        addToLog(nextLine); 

        avgState.typingTimer = setInterval(() => {
            textEl.textContent += avgState.currentFullText.charAt(avgState.charIndex);
            avgState.charIndex++;
            if (avgState.charIndex >= avgState.currentFullText.length) {
                clearInterval(avgState.typingTimer);
                avgState.isTyping = false;
                arrowEl.classList.add('show');
                // ä¸€å¥æ‰“å®Œäº†ï¼Œåˆ·æ–°ä¸€ä¸‹é”çš„çŠ¶æ€
                // å› ä¸ºæˆ‘ä»¬ä¿®æ”¹äº†checkInputLockï¼Œåªè¦è¿˜æœ‰ä¸‹ä¸€å¥ï¼Œè¿™é‡Œä¾ç„¶æ˜¯é”ç€çš„
                updateLockVisuals();
            }
        }, 30); 
        return;
    }

    // 5. æ²¡è¯è¯´äº† (é˜Ÿåˆ—ç©ºäº†) -> è¿›å…¥é€‰æ‹©é˜¶æ®µæˆ–è‡ªç”±æ¨¡å¼
    // åªæœ‰åˆ°äº†è¿™ä¸€æ­¥ï¼Œæ‰€æœ‰æ–‡å­—éƒ½æ’­å®Œäº†ï¼Œæˆ‘ä»¬æ‰æ˜¾ç¤ºé€‰é¡¹ï¼Œæˆ–è€…è§£é”UI
    if (!document.getElementById('choices-layer').classList.contains('active')) {
        showChoices(avgState.pendingChoices);
        
        // åªæœ‰é€‰é¡¹æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œæˆ–è€…è¿›å…¥äº†è‡ªç”±æ¨¡å¼ï¼ŒcheckInputLock æ‰ä¼šè¿”å› false
        // è¿™æ—¶å€™æ‰§è¡Œæ›´æ–°ï¼ŒUIæ‰ä¼šäº®èµ·æ¥
        updateLockVisuals(); 
    }
}

// === ä¿®æ”¹åçš„ showChoicesï¼šæ”¯æŒè‡ªç”±æ¢ç´¢æ¨¡å¼ ===
function showChoices(choices) {
    const layer = document.getElementById('choices-layer');
    layer.innerHTML = ''; // å†æ¬¡æ¸…ç©ºï¼Œç¡®ä¿å®‰å…¨
    
    // === æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœ choices ä¸ºç©ºæ•°ç»„ï¼Œè¯´æ˜è¿›å…¥è‡ªç”±æ¢ç´¢æ¨¡å¼ ===
    if (!choices || choices.length === 0) {
        layer.classList.remove('active'); // éšè—é€‰é¡¹å±‚
        
        // æˆ‘ä»¬ç»™è¾“å…¥æ¡†åŠ ä¸ªé«˜äº®åŠ¨ç”»
        const freeInput = document.getElementById('free-action-bar');
        freeInput.style.boxShadow = "0 0 15px var(--accent-glitch)";
        setTimeout(() => { freeInput.style.boxShadow = "none"; }, 1000);
        
        // ã€ä¿®å¤ã€‘é˜²æ­¢é‡å¤è¿½åŠ æç¤ºã€‚å…ˆè·å–å¯¹è¯æ¡†ï¼Œæ£€æŸ¥é‡Œé¢æ˜¯å¦å·²ç»åŒ…å«äº†è¿™å¥è¯
        const textEl = document.getElementById('main-text');
        const tipText = "[ è‡ªç”±æ¢ç´¢æ¨¡å¼: è¯·ä½¿ç”¨åœ°å›¾ç§»åŠ¨æˆ–ä¸‹æ–¹è¾“å…¥æ¡†è¡ŒåŠ¨ ]";
        
        // åªæœ‰å½“æ–‡æœ¬é‡Œè¿˜æ²¡æœ‰è¿™å¥è¯æ—¶ï¼Œæ‰è¿½åŠ 
        if (!textEl.innerText.includes(tipText)) {
            textEl.innerHTML += `<br><br><span style="color:var(--accent-gold); font-size:0.9rem; border:1px solid var(--accent-gold); padding:2px 5px;">${tipText}</span>`;
        }
        return; 
    }
    // ================================================

    choices.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'pixel-btn';
        let btnText = c.text;
        
        // æ¶ˆè€—æ—¶é—´æç¤º
        if (c.costTime) btnText += ` [â³]`;
        // æ¶ˆè€—é‡‘é’±æç¤º
        if (c.costMoney) btnText += ` [Â¥${c.costMoney}]`;
        // æ£€å®šæç¤º
        if (c.check) btnText += ` [${c.check}]`;

        btn.innerText = btnText;
        btn.onclick = (e) => { e.stopPropagation(); handleChoice(c); };
        layer.appendChild(btn);
    });
    layer.classList.add('active');
}

// --- æ ¸å¿ƒåœºæ™¯é€»è¾‘ ---

async function handleScene(action, extraInfo = "") {
    let prompt = "";
    let isSystemEvent = false;

    // 1. å¼ºåˆ¶å¼€åœºæµç¨‹
    if (action === "intro_day1") {
        gameState.currentLocation = "404å·äº‹åŠ¡æ‰€";
        // ä¿®æ”¹ï¼šè®¾å®šä¸ºéƒ½å¸‚æ—¥å¸¸å…¼æ€ªè°ˆé£æ ¼ï¼Œå¼ºè°ƒâ€œç©·â€å’Œâ€œæ—¥å¸¸â€
        prompt = `æ¸¸æˆå¼€å§‹ã€‚
        èƒŒæ™¯ï¼šç©å®¶${gameState.player.name}è½¬èŒç§å®¶ä¾¦æ¢å…¥ä½é›¾å·å¸‚è€åŸåŒºçš„404å·äº‹åŠ¡æ‰€å·²ç»ä¸‰ä¸ªæœˆäº†ã€‚
        ç°åœ¨çš„çŠ¶æ€æ˜¯ï¼šå¾ˆç©·ï¼Œéå¸¸ç©·ã€‚å†°ç®±é‡Œåªå‰©åŠç“¶å¯ä¹ï¼Œè´¦æˆ·ä½™é¢ä»¤äººå¿ƒç¢ã€‚
        
        è¯·æè¿°ï¼š
        1. ä¸€ä¸ªå……æ»¡ç”Ÿæ´»æ°”æ¯çš„æ—©æ™¨
        2. ç©å®¶æ­£åœ¨åšä¸€ä»¶æåº¦æ— èŠçš„äº‹ã€‚
        3. **çªå‘äº‹ä»¶**ï¼šäº‹åŠ¡æ‰€çš„é—¨é“ƒå“äº†ï¼Œæˆ–è€…æ‰‹æœºéœ‡åŠ¨äº†ï¼Œç©å®¶çœ‹çœ‹æ€ä¹ˆä¸ªäº‹å„¿ã€‚
        
        **å¿…é¡»**ç”Ÿæˆç¬¬ä¸€ä¸ªæ ¸å¿ƒè°œå›¢ï¼ˆMystery Setupï¼‰ã€‚
        è°œå›¢è¦æ±‚ï¼š**éƒ½å¸‚æ€ªè°ˆ/é»‘è‰²å¹½é»˜é£æ ¼**ã€‚ä¸è¦å¤ªææ€–ï¼Œè¦æœ‰ä¸€ç§â€œè¿™äº‹å„¿é€ç€å¤æ€ªä½†åˆæœ‰ç‚¹å¥½ç¬‘â€çš„æ„Ÿè§‰ã€‚
        è®¾å®šä¸€ä¸ªâ€œçœŸç›¸â€ï¼ˆç©å®¶ä¸å¯è§ï¼‰ï¼Œå¹¶è®¾å®šè§£å†³æœŸé™ï¼ˆ3-5å¤©ï¼‰ã€‚
        ä¸è¦åœ¨ description å†™ç³»ç»Ÿæç¤ºï¼Œåªè¿”å› JSONã€‚`;
        isSystemEvent = true;
    } 

    // 2. äº‹åŠ¡æ‰€ç”µè„‘äº¤äº’
    else if (action === "check_email") {
        if (!gameState.mystery.active) {
            prompt = `ç©å®¶æŸ¥çœ‹äº†ç”µè„‘é‚®ä»¶ã€‚è¯·ç”Ÿæˆä¸€ä¸ªæ–°çš„å§”æ‰˜æˆ–æ€ªè°ˆï¼Œå¹¶**å¿…é¡»**è¿”å› mystery_setup å­—æ®µæ¥å¼€å¯è¿™ä¸ªæ–°è°œå›¢ã€‚`;
        } else {
            prompt = `ç©å®¶æŸ¥è¯¢å…³äºâ€œ${gameState.mystery.title}â€çš„èµ„æ–™ã€‚
            è¯·æ ¹æ®çœŸç›¸â€œ${gameState.mystery.truth}â€ï¼Œæä¾›ä¸€æ¡ç›¸å…³çš„çº¿ç´¢ï¼ˆnew_clueï¼‰ã€‚`;
        }
}


    // 3. ç§»åŠ¨é€»è¾‘
    else if (action === "move") {
        const oldLocation = gameState.currentLocation;
        gameState.currentLocation = extraInfo;
        prompt = `ç©å®¶ç¦»å¼€ã€${oldLocation}ã€‘å‰å¾€ã€${extraInfo}ã€‘ã€‚
        æè¿°ç§»åŠ¨è¿‡ç¨‹å’ŒæŠµè¾¾åçš„æ™¯è±¡ã€‚å½“å‰æ—¶é—´ï¼š${TIME_PHASES[gameState.timePhase]}ã€‚`;
        if (gameState.timePhase === 3) prompt += " å¤œæ™šå……æ»¡äº†å±é™©æ°”æ¯ã€‚";
}

    // === æ–°å¢ï¼šå¤„ç†ä¸€é”®æ¢ç´¢é€»è¾‘ ===
    else if (action === "explore_current_location") {
        isSystemEvent = true;
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ¢ç´¢æ˜¯è€—æ—¶è¡Œä¸ºï¼Œå¼ºåˆ¶æ¨è¿›æ—¶é—´ â˜…â˜…â˜…
        // åªæœ‰å½“æ—¶é—´è¿˜æ²¡åˆ°æ·±å¤œ(3)æ—¶æ‰æ¨è¿›ï¼Œé¿å…æ·±å¤œæ¢ç´¢ç›´æ¥è·³åˆ°ç¬¬äºŒå¤©
        if (gameState.timePhase < 3) {
            advanceTime(); 
        }

        // è·å–ç©å®¶çš„ MYS (çµè§†) å’Œ INT (å­¦è¯†) å±æ€§
        const mys = gameState.stats.mys;
        const int = gameState.stats.int;
        
        prompt = `ç©å®¶å†³å®šèŠ±è´¹æ—¶é—´åœ¨ã€${gameState.currentLocation}ã€‘ä»”ç»†æœå¯»ä¸€ç•ªã€‚
        â˜… æ³¨æ„ï¼šç©å®¶èŠ±è´¹äº†æ—¶é—´ï¼Œå½“å‰æ—¶é—´å˜æˆäº†ï¼š${TIME_PHASES[gameState.timePhase]}ã€‚
        è¯·åœ¨æè¿°ä¸­ä½“ç°æ—¶é—´çš„æµé€ï¼ˆä¾‹å¦‚ï¼šæœå¯»äº†å¾ˆä¹…ï¼Œå¤©è‰²æ¸æ™š...ï¼‰ã€‚
        
        ç©å®¶å±æ€§ï¼šçµè§†(MYS):${mys}, å­¦è¯†(INT):${int}ã€‚
        
        è¯·æ ¹æ®åœ°ç‚¹å’Œå±æ€§ç”Ÿæˆç»“æœï¼š
        1. **ç‰©å“ (Loot)**ï¼šå¦‚æœæœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œè¯·æ”¾å…¥ loot æ•°ç»„ã€‚
        2. **çº¿ç´¢ (Clue)**ï¼šå¦‚æœè¿™é‡Œæœ‰å…³äºè°œå›¢çš„è››ä¸é©¬è¿¹ï¼Œè¯·é€šè¿‡ new_clue å­—æ®µè¿”å›ã€‚
        3. **æè¿°**ï¼šæè¿°ç©å®¶ç¿»ç®±å€’æŸœçš„è¿‡ç¨‹ã€‚å¦‚æœä¸€æ— æ‰€è·ï¼Œè¯·ç›´è¯´ã€‚`;
    }


    // === æ–°å¢ï¼šç¡å‰æ¨ç†é¢˜ç”Ÿæˆ (Trigger Quiz) - éš¾åº¦å‡çº§ç‰ˆ ===
    else if (action === "generate_night_quiz") {
        isSystemEvent = true;
        
        // è·å–å½“å‰çº¿ç´¢ï¼Œè®©é¢˜ç›®æ›´å…·ä½“
        const clueText = gameState.clues.length > 0 ? gameState.clues.join("ã€") : "æš‚æ— æ˜ç¡®çº¿ç´¢ï¼Œåªèƒ½é ç›´è§‰";

        prompt = `ç©å®¶å‡†å¤‡ç¡è§‰ï¼Œè¿›å…¥ã€çƒ§è„‘æ¨ç†ç¯èŠ‚ã€‘ã€‚
        å½“å‰è°œå›¢ï¼šã€${gameState.mystery.title}ã€ã€‚
        çœŸç›¸æ˜¯ï¼šã€${gameState.mystery.truth}ã€ã€‚
        ç©å®¶å·²çŸ¥çš„çº¿ç´¢ï¼š${clueText}ã€‚
        
        è¯·ç”Ÿæˆä¸€ä¸ªã€é«˜éš¾åº¦çš„ä¸‰é€‰ä¸€é€»è¾‘æ¨ç†é¢˜ã€‘ï¼Œè®©ç©å®¶æ¨æµ‹çœŸç›¸ã€‚
        
        â˜… æ ¸å¿ƒè¦æ±‚ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š
        1. **æ‹’ç»å¼±æ™ºé€‰é¡¹**ï¼šé”™è¯¯é€‰é¡¹å¿…é¡»éå¸¸æœ‰è¿·æƒ‘æ€§ï¼å®ƒä»¬åº”è¯¥æ˜¯çœ‹ä¼¼ç¬¦åˆé€»è¾‘ä½†ç»†èŠ‚é”™è¯¯çš„â€œé™·é˜±â€ï¼Œæˆ–è€…æ˜¯ç¬¦åˆææ€–ç‰‡å¥—è·¯çš„â€œçº¢é²±é±¼â€ã€‚
        2. **å¢åŠ æ¨¡ç³Šåº¦**ï¼šæ­£ç¡®é€‰é¡¹ä¸è¦å†™å¾—å¤ªç›´ç™½ï¼Œè¦å«è“„ã€æ·±åˆ»ï¼Œæˆ–è€…åç›´è§‰ã€‚
        3. **è€ƒå¯Ÿç»†èŠ‚**ï¼šé—®é¢˜åº”è¯¥ç›´æŒ‡è°œå›¢çš„æ ¸å¿ƒçŸ›ç›¾ï¼Œè€Œä¸æ˜¯ç®€å•çš„è¡¨é¢ç°è±¡ã€‚
        
        è¯·ä¸¥æ ¼è¿”å›JSONæ ¼å¼ï¼Œå¿…é¡»åŒ…å« "quiz" å­—æ®µï¼š
        {
            "description": "å¤œæ·±äº†ï¼Œçª—å¤–çš„é£å£°åƒæ˜¯æœ‰äººåœ¨å‘œå’½ã€‚å…³äºã€${gameState.mystery.title}ã€çš„ç¢ç‰‡åœ¨è„‘æµ·ä¸­æ‹¼å‡‘â€¦â€¦ä½ å¿½ç„¶æ„è¯†åˆ°ä¸€ä¸ªè¢«å¿½ç•¥çš„ç»†èŠ‚ï¼š",
            "quiz": {
                "question": "è¿™é‡Œå¡«å…¥å…·ä½“çš„æ¨ç†é—®é¢˜ï¼ˆä¾‹å¦‚ï¼šé‚£ä¸ªå£°éŸ³çš„çœŸæ­£æ¥æºå…¶å®æ˜¯ï¼Ÿï¼‰",
                "options": ["çœ‹ä¼¼åˆç†ä½†é”™è¯¯çš„å¹²æ‰°é¡¹Aï¼ˆè¯¯å¯¼ç©å®¶ï¼‰", "æ­£ç¡®ä½†åç›´è§‰çš„æ¨è®ºB", "ç¬¦åˆå¸¸ç†ä½†é”™è¯¯çš„å¹²æ‰°é¡¹C"],
                "correct_index": 1
            }
        }
        `;
    }

    // === æ–°å¢ï¼šæ¨ç†ç»“æœå¤„ç†ä¸å…¥ç¡ ===
    else if (action === "process_quiz_answer") {
        // extraInfo è¿™é‡Œä¼ å…¥çš„æ˜¯ { choiceIndex: number, isCorrect: boolean }
        const result = extraInfo;
        
        // 1. ç­”å¯¹äº†
        if (result.isCorrect) {
            gameState.mystery.status = "solved";
            // å¥–åŠ±å‘æ”¾
            gameState.money += 2000;
            gameState.reputation += 30;
            gameState.stats.san = Math.min(gameState.stats.maxSan, gameState.stats.san + 30);
            
            prompt = `ç©å®¶åœ¨ç¡å‰å‡†ç¡®åœ°æ¨ç†å‡ºäº†çœŸç›¸ï¼(ç©å®¶é€‰æ‹©äº†æ­£ç¡®çš„é€‰é¡¹)ã€‚
            è™½ç„¶ç°åœ¨å·²ç»æ˜¯æ·±å¤œï¼Œä½†ç©å®¶å®‰å¿ƒåœ°ç¡ç€äº†ã€‚
            è¯·ç®€çŸ­æè¿°ç©å®¶æ„Ÿåˆ°å¦‚é‡Šé‡è´Ÿï¼Œåšäº†ä¸€ä¸ªå¥½æ¢¦ã€‚
            (æ³¨æ„ï¼šå…·ä½“çš„æ­ç§˜å‰§æƒ…ç•™åˆ°æ˜å¤©æ—©ä¸Šé†’æ¥å†è¯´)`;
            
            // æ ‡è®°ï¼Œæ–¹ä¾¿ç¬¬äºŒå¤©æ—©ä¸Šç”¨
            gameState.mystery.readyToResolve = true; 
        } 
        // 2. ç­”é”™äº†
        else {
            // æ£€æŸ¥æ˜¯å¦åˆ°äº†æ­»æœŸ
            const isDeadline = gameState.day >= gameState.mystery.deadlineDay;
            
            if (isDeadline) {
                gameState.mystery.status = "failed";
                gameState.stats.san -= 30;
                gameState.stats.maxHp -= 20;
                prompt = `ç©å®¶æ¨ç†é”™è¯¯ï¼è€Œä¸”ä»Šæ™šå·²ç»æ˜¯æœ€åçš„æœŸé™äº†ã€‚
                æè¿°ç©å®¶å¸¦ç€é”™è¯¯çš„çŒœæµ‹å…¥ç¡ï¼Œæ„Ÿåˆ°ä¸€ç§æ·±æ·±çš„ä¸å®‰å’Œå³å°†åˆ°æ¥çš„å„è¿ã€‚`;
                gameState.mystery.readyToResolve = true; // å‡†å¤‡è¿æ¥åç»“å±€
            } else {
                // æ²¡åˆ°æ­»æœŸï¼Œæ— äº‹å‘ç”Ÿ
                prompt = `ç©å®¶æ¨ç†é”™è¯¯ã€‚
                æè¿°ç©å®¶è§‰å¾—è¿™ä¸ªæ¨è®ºæœ‰äº›ç‰µå¼ºï¼Œæ‘‡äº†æ‘‡å¤´ï¼Œå†³å®šå…ˆç¡è§‰ï¼Œæ˜å¤©å†ç»§ç»­è°ƒæŸ¥ã€‚
                (æ­£å¸¸ç¡è§‰ï¼Œæ‰£é™¤å°‘é‡SANå€¼)`;
                gameState.stats.san -= 5;
            }
        }
        
        // ä¿®æ”¹ï¼šä¸å†ç«‹å³è¿‡å¤œï¼Œè€Œæ˜¯æ ‡è®°â€œå¾…è¿‡å¤œâ€ï¼Œç­‰ç©å®¶ç‚¹â€œç»§ç»­â€æ—¶å†è·³æ—¶é—´
        gameState.pendingSleep = true; 
    }

    // === ä¿®æ”¹ï¼šæ—©æ™¨å”¤é†’é€»è¾‘ (Wake Up) ===
    else if (action === "wake_up") {
        // æ£€æŸ¥æ˜¨æ™šæ˜¯å¦è§£å†³äº†è°œå›¢ï¼ˆæˆ–å½»åº•å¤±è´¥äº†ï¼‰
        if (gameState.mystery.readyToResolve) {
            isSystemEvent = true;
            const isSuccess = gameState.mystery.status === "solved";
            
            prompt = `å·²ç»æ˜¯ç¬¬äºŒå¤©æ—©ä¸Š (Day ${gameState.day})ã€‚
            å…³äºè°œå›¢ã€${gameState.mystery.title}ã€ï¼Œç©å®¶çš„ç»“æœæ˜¯ï¼š${isSuccess ? "ã€æˆåŠŸç ´è§£ã€‘" : "ã€å½»åº•å¤±è´¥ã€‘"}ã€‚
            çœŸç›¸æ˜¯ï¼š${gameState.mystery.truth}ã€‚
            
            è¯·æ ¹æ®è¿™ä¸ªç»“æœï¼Œç”Ÿæˆä¸€æ®µç²¾å½©çš„ã€ç»“æ¡ˆå‰§æƒ…ã€‘ã€‚
            - å¦‚æœæˆåŠŸï¼šæè¿°è°œå›¢å¦‚ä½•æ¶ˆæ•£ï¼Œæˆ–è€…å§”æ‰˜äººå‘æ¥æ„Ÿè°¢ä¿¡ï¼Œæˆ–è€…å‘ç°æ€ªç‰©æ¶ˆå¤±äº†ã€‚
            - å¦‚æœå¤±è´¥ï¼šæè¿°ä¸å¯æŒ½å›çš„åæœï¼Œæˆ–è€…ç©å®¶å—åˆ°äº†æ°¸ä¹…çš„è¯…å’’ã€‚
            
            æœ€åæ¸…ç†æ‰å½“å‰çš„ mystery_setup (é€šè¿‡ mystery_result å­—æ®µé€šçŸ¥å‰ç«¯å…³é—­è°œå›¢)ã€‚`;
            
            // æ¸…ç†æ ‡è®°
            gameState.mystery.readyToResolve = false;
        } else {
            // æ™®é€šæ—©æ™¨
            prompt = `ç©å®¶ç¡äº†ä¸€è§‰é†’æ¥ã€‚ç°åœ¨æ˜¯ç¬¬${gameState.day}å¤©ä¸Šåˆã€‚
            æè¿°é˜³å…‰æ´’è¿›äº‹åŠ¡æ‰€ï¼Œæˆ–è€…çª—å¤–é˜´é›¨ç»µç»µã€‚è¯¢é—®ç©å®¶ä»Šå¤©çš„è®¡åˆ’ã€‚`;
        }
    }

    // === è‡ªç”±è¡ŒåŠ¨åˆ¤å®šé€»è¾‘ ===
    else if (action === "judge_action") {
        isSystemEvent = true;
        prompt = `ç©å®¶æƒ³è¦æ‰§è¡Œè‡ªç”±è¡ŒåŠ¨ï¼šã€${extraInfo}ã€‘ã€‚
        è¯·åˆ¤æ–­è¯¥è¡ŒåŠ¨æ˜¯å¦éœ€è¦è¿›è¡Œå±æ€§æ£€å®šã€‚
        è¯·ä¸¥æ ¼è¿”å›JSONæ ¼å¼ï¼š{"check_needed": "PHY"|"DEX"|"INT"|"CHA"|"MYS"|"NONE", "reason": "..."}`;
    }
    else if (action === "resolve_action") {
        prompt = `ç©å®¶æ‰§è¡Œäº†è¡ŒåŠ¨ã€‚${extraInfo}ã€‚è¯·æè¿°ç»“æœã€‚`;
    }
    else if (action === "free_action") {
        prompt = `ç©å®¶æ‰§è¡Œäº†è‡ªç”±è¡ŒåŠ¨ï¼šã€${extraInfo}ã€‘ã€‚è¯·æè¿°è¡Œä¸ºå’Œç»“æœã€‚`;
    }
    else {
        prompt = `ç©å®¶é€‰æ‹©äº†ï¼š${extraInfo}ã€‚ç»§ç»­å‰§æƒ…ã€‚`;
    }

    // æ¶ˆè€—æ—¶é—´é€»è¾‘
    if (action === "work" || action === "explore") {
        advanceTime();
    }

    // UI çŠ¶æ€åˆ‡æ¢
    avgState.isWaitingForAI = true;
    avgState.pendingChoices = [];
    updateLockVisuals(); // <--- å…³é”®ï¼šå‘èµ·è¯·æ±‚æ—¶ï¼Œç«‹å³ä¸Šé”ï¼
    
    document.getElementById('main-text').innerHTML = `<span style="animation: blink 1s infinite;">æ­£åœ¨è¿æ¥çµç•Œä¿¡å·...</span>`;
    
    // æ¸…ç©ºæ—§æŒ‰é’®
    const choicesLayer = document.getElementById('choices-layer');
    choicesLayer.classList.remove('active');
    choicesLayer.innerHTML = ''; 

    document.getElementById('click-arrow').classList.remove('show');

    // === è°ƒç”¨ AI ===
    const result = await callAI(prompt, isSystemEvent);
    
    // === åˆ¤å®šé€»è¾‘åˆ†æ”¯å¤„ç† ===
    if (action === "judge_action") {
        avgState.isWaitingForAI = false; 
        if (result && result.check_needed && result.check_needed !== "NONE") {
            const checkObj = { text: extraInfo, action: 'resolve_action', check: result.check_needed };
            document.getElementById('main-text').innerText = `[ ç³»ç»Ÿåˆ¤å®š: éœ€è¦ ${result.check_needed} æ£€å®š ]`;
            setTimeout(() => performDiceRoll(checkObj), 500);
        } else {
            handleScene('free_action', extraInfo);
        }
        return; 
    }

    // === å¸¸è§„å‰§æƒ…å¤„ç† ===
    if (result) processSceneData(result);
    else {
        avgState.isWaitingForAI = false;
        document.getElementById('main-text').innerText = "è¿æ¥æ–­å¼€ã€‚";
        showChoices([{text: "é‡è¯•", action: action}]);
        
        // å…³é”®ä¿®å¤ï¼šå¿…é¡»è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥ç§»é™¤ .game-locked æ ·å¼ï¼Œå¦åˆ™æŒ‰é’®æ— æ³•ç‚¹å‡»
        updateLockVisuals(); 
    }
}

// è¾…åŠ©ï¼šæ‰§è¡Œæ•°å€¼å±‚é¢çš„ç¡è§‰æ›´æ–°
function performSleepStatsUpdate() {
    gameState.stats.hp = Math.min(gameState.stats.maxHp, gameState.stats.hp + 30);
    gameState.day++;
    gameState.timePhase = 0;
    updateStatsUI();
}

function advanceTime() {
    if (gameState.timePhase < 3) {
        gameState.timePhase++;
        updateStatsUI();
    }
}

async function handleChoice(choice) {
    // === æ–°å¢ï¼šQuiz ç­”æ¡ˆæ‹¦æˆªå¤„ç† ===
    if (choice.action === "quiz_answer") {
        const quizData = gameState.mystery.tempQuizData;
        const correctIdx = quizData.correct_index;
        const userIdx = choice.rawIndex;
        const isCorrect = (userIdx === correctIdx);
        
        let feedback = "";
        if (isCorrect) {
            feedback = "ä½ æ„Ÿè§‰åˆ°ä¸€é˜µé€šé€ï¼Œä»¿ä½›æŠ“ä½äº†å‘½è¿çš„çº¢çº¿â€¦â€¦ [ æ¨ç†æ­£ç¡® ]";
            alert("âœ… æ¨ç†æ­£ç¡®ï¼\nè·å¾—äº†å…³é”®çº¿ç´¢ï¼Œä»Šæ™šå¯ä»¥ç¡ä¸ªå®‰ç¨³è§‰äº†ã€‚");
        } else {
            feedback = "ä½ è¶Šæƒ³è¶Šä¹±ï¼Œä¼¼ä¹èµ°è¿›äº†ä¸€æ¡æ­»èƒ¡åŒâ€¦â€¦ [ æ¨ç†é”™è¯¯ ]";
            alert("âŒ æ¨ç†é”™è¯¯ï¼\næ€ç»ªæ··ä¹±ï¼ŒSANå€¼ç•¥å¾®ä¸‹é™ã€‚");
        }

        // æŠŠç»“æœä¼ å› handleScene è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†
        handleScene('process_quiz_answer', { choiceIndex: userIdx, isCorrect: isCorrect });
        return;
    }

    // ä¸‹é¢æ˜¯åŸæœ‰çš„é€»è¾‘
    if (choice.action === "continue") {
        // === ä¿®å¤ï¼šå¦‚æœæ˜¯æ¨ç†ç»“æŸåçš„â€œç»§ç»­â€ï¼Œæ­¤æ—¶æ‰çœŸæ­£æ‰§è¡Œè¿‡å¤œ ===
        if (gameState.pendingSleep) {
            gameState.pendingSleep = false; // æ¶ˆè€—æ‰è¿™ä¸ªæ ‡è®°
            performSleepStatsUpdate(); // æ—¶é—´å˜æˆç¬¬äºŒå¤©æ—©ä¸Š
            handleScene('wake_up'); // è§¦å‘èµ·åºŠå‰§æƒ…
            return;
        }

        // å¦‚æœæ˜¯ç¡è§‰åçš„â€œç»§ç»­â€ï¼Œæ„å‘³ç€è¦å”¤é†’
        // æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ä¸Šä¸€æ¡æŒ‡ä»¤æ˜¯ä¸æ˜¯ process_quiz_answer æˆ–è€… sleep
        // ç®€å•ç‚¹ï¼šæ¯æ¬¡ç‚¹å‡»â€œç»§ç»­â€ï¼Œå¦‚æœ timePhase æ˜¯ 0 (æ—©æ™¨)ï¼Œå°±è§¦å‘ wake_up æè¿°
        if (gameState.timePhase === 0 && !avgState.tempData?.move_to) {
             handleScene('wake_up');
             return;
        }
    }

    // 1. æ£€æŸ¥é‡‘é’±
    if (choice.costMoney && gameState.money < choice.costMoney) {
        alert("èµ„é‡‘ä¸è¶³ï¼");
        return;
    }
    
    // 2. æ£€æŸ¥æ—¶é—´
    if (choice.costTime && gameState.timePhase >= 3) {
        alert("å¤ªæ™šäº†ï¼Œå¿…é¡»å…ˆä¼‘æ¯ã€‚");
        return;
    }

    // 3. æ‰£é™¤é‡‘é’±
    if (choice.costMoney) {
        gameState.money -= choice.costMoney;
        updateStatsUI();
    }

    // 4. å±æ€§æ£€å®šé€»è¾‘
    if (choice.check) {
        performDiceRoll(choice); 
        return; 
    } 
    
    // 5. æ™®é€šå‰§æƒ…
    handleScene(choice.action, choice.text);
}

// --- æ–°å¢ï¼šéª°å­åŠ¨ç”»é€»è¾‘ (D100 ç‰ˆ) ---
function performDiceRoll(choice) {
    const layer = document.getElementById('dice-layer');
    const valEl = document.getElementById('dice-val');
    const resEl = document.getElementById('dice-result');
    const targetEl = document.getElementById('target-val');
    const attrEl = document.getElementById('check-attr');
    const box = document.getElementById('dice-box');

    const attr = choice.check.toLowerCase();
    const statVal = gameState.stats[attr] || 50; // é»˜è®¤å€¼æ”¹ä¸º50

    // åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
    layer.style.display = 'flex';
    resEl.innerText = '';
    box.style.borderColor = 'var(--fg)';
    box.style.transform = 'scale(1)';
    valEl.style.color = 'var(--fg)';
    targetEl.innerText = statVal;
    attrEl.innerText = choice.check;

    // åŠ¨ç”»é˜¶æ®µï¼šæ•°å­—ç‹‚è·³ (0-99)
    let count = 0;
    const maxCount = 15; // è·³åŠ¨æ¬¡æ•°
    const interval = setInterval(() => {
        // === ä¿®æ”¹ï¼šåŠ¨ç”»æ˜¾ç¤º 1-100 ===
        valEl.innerText = Math.floor(Math.random() * 100) + 1;
        count++;
        // å¢åŠ ä¸€ç‚¹éšæœºéœ‡åŠ¨æ„Ÿ
        box.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        if(count >= maxCount) {
            clearInterval(interval);
            finalizeRoll(choice, statVal);
        }
    }, 60); // 60msè·³ä¸€æ¬¡
}

function finalizeRoll(choice, statVal) {
    // === ä¿®æ”¹ï¼šç”Ÿæˆ 1-100 çš„éšæœºæ•° (D100) ===
    const roll = Math.floor(Math.random() * 100) + 1; 
    
    // D100è§„åˆ™ï¼šéª°å­ç‚¹æ•° <= å±æ€§å€¼ ç®—æˆåŠŸ
    // ç‰¹æ®Šè§„åˆ™ï¼š1-5 å¤§æˆåŠŸï¼Œ96-100 å¤§å¤±è´¥ (CoC 7ç‰ˆè§„åˆ™å˜ä½“)
    let isCritSuccess = (roll <= 5);
    let isCritFail = (roll >= 96);
    // æ™®é€šåˆ¤å®š
    let success = (roll <= statVal); 

    // å¼ºåˆ¶è¦†ç›–ç»“æœ
    if (isCritFail) success = false;
    if (isCritSuccess) success = true;
    
    const valEl = document.getElementById('dice-val');
    const resEl = document.getElementById('dice-result');
    const box = document.getElementById('dice-box');
    const layer = document.getElementById('dice-layer'); // è·å–èƒŒæ™¯å±‚

    valEl.innerText = roll;
    
    // é‡ç½®æ‰€æœ‰ç‰¹æ•ˆç±»
    box.className = ''; 
    layer.className = 'overlay-layer'; // é‡ç½®èƒŒæ™¯å±‚åŠ¨ç”»
    // é‡æ–°åŠ ä¸ŠåŸºç¡€æ ·å¼
    box.style.cssText = `
        font-size: 6rem; font-weight: bold; color: var(--fg); 
        border: 6px solid var(--fg); width: 140px; height: 140px; 
        line-height: 120px; margin: 0 auto; position: relative;
        background: #000; transition: all 0.2s;
    `;

    // æ„é€ ä¼ ç»™AIçš„ç»“æœæ–‡æœ¬
    let resultText = "";
    let promptSuffix = ""; 

    // åˆ†æ”¯åˆ¤å®š
    if (isCritSuccess) {
        // === å¤§æˆåŠŸ (é‡‘è‰²ä¼ è¯´) ===
        resEl.innerText = "CRITICAL SUCCESS!";
        resEl.style.color = "#ffd700";
        box.classList.add('dice-crit-success'); 
        
        resultText = `è¡ŒåŠ¨: ${choice.text} (æ£€å®š${choice.check}: æ·å‡º${roll} -> â˜…å¤§æˆåŠŸâ˜…ï¼å¥‡è¿¹å‘ç”Ÿäº†ï¼)`;
        promptSuffix = "ã€ç³»ç»Ÿæç¤ºã€‘ï¼šç©å®¶æ·å‡ºäº†å¤§æˆåŠŸ(1-5)ï¼è¯·æè¿°ä¸€ä¸ªæå…¶å®Œç¾ã€æ„æƒ³ä¸åˆ°çš„å¥½ç»“æœï¼ç»™äºˆé¢å¤–çš„å¥–åŠ±æˆ–çº¿ç´¢ã€‚";
        
    } else if (isCritFail) {
        // === å¤§å¤±è´¥ (æ•…éšœçº¢ + å±å¹•çº¢å…‰) ===
        resEl.innerText = "CRITICAL FAILURE!";
        resEl.style.color = "#ff0000"; 
        
        // éª°å­æ·»åŠ æ•…éšœç‰¹æ•ˆ
        box.classList.add('dice-crit-fail'); 
        
        // èƒŒæ™¯å±‚æ·»åŠ çº¢è‰²é—ªçƒ
        layer.classList.add('screen-flash-red');
        
        resultText = `è¡ŒåŠ¨: ${choice.text} (æ£€å®š${choice.check}: æ·å‡º${roll} -> â˜ ï¸å¤§å¤±è´¥â˜ ï¸ï¼æç ¸äº†ï¼)`;
        promptSuffix = "ã€ç³»ç»Ÿæç¤ºã€‘ï¼šç©å®¶æ·å‡ºäº†å¤§å¤±è´¥(96-100)ï¼è¯·æè¿°ä¸€ä¸ªç³Ÿç³•é€é¡¶çš„ç»“æœï¼ç©å®¶å¯èƒ½å—äº†ä¼¤ã€ä¸¢å¤±äº†ç‰©å“æˆ–è€…è¢«æ€ªç‰©å‘ç°äº†ã€‚SANå€¼å—åˆ°é‡åˆ›ã€‚";

    } else if (success) {
        // === æ™®é€šæˆåŠŸ (ç»¿è‰²) ===
        resEl.innerText = "SUCCESS";
        resEl.style.color = "#0f0";
        
        // æ‰‹åŠ¨åº”ç”¨ç»¿è‰²æ ·å¼ï¼Œä¿æŒç®€æ´
        box.style.borderColor = "#0f0";
        valEl.style.color = "#0f0";
        box.style.boxShadow = "0 0 30px rgba(0, 255, 0, 0.3)";
        
        resultText = `è¡ŒåŠ¨: ${choice.text} (æ£€å®š${choice.check}: æ·å‡º${roll} / ç›®æ ‡${statVal} -> æˆåŠŸ)`;
    
    } else {
        // === æ™®é€šå¤±è´¥ (æ™®é€šçº¢è‰²) ===
        resEl.innerText = "FAILURE";
        resEl.style.color = "#ff4444"; // æ›´åŠ æ˜¾çœ¼çš„äº®çº¢
        
        // åº”ç”¨æ–°å¢çš„æ™®é€šå¤±è´¥ç±»
        box.classList.add('dice-fail');
        
        resultText = `è¡ŒåŠ¨: ${choice.text} (æ£€å®š${choice.check}: æ·å‡º${roll} / ç›®æ ‡${statVal} -> å¤±è´¥)`;
    }

    // åœé¡¿ 2ç§’ è®©ç©å®¶æ¬£èµç‰¹æ•ˆï¼Œç„¶åç»§ç»­å‰§æƒ…
    setTimeout(() => {
        document.getElementById('dice-layer').style.display = 'none';
        layer.className = 'overlay-layer'; // å†æ¬¡é‡ç½®èƒŒæ™¯
        handleScene(choice.action, resultText + "\n" + promptSuffix);
    }, 2000);
}

// --- 4. äº‹åŠ¡æ‰€äº¤äº’é€»è¾‘ (ä¼˜åŒ–ç‰ˆ) ---
function handleOfficeAction(type) {
    if (gameState.currentLocation !== "404å·äº‹åŠ¡æ‰€") {
        addToLog("ç¦»å¾—å¤ªè¿œäº†ï¼Œæ— æ³•æ“ä½œã€‚");
        showPixelMsg("ä½ ç°åœ¨ä¸åœ¨äº‹åŠ¡æ‰€ï¼Œæ— æ³•è¿›è¡Œæ­¤æ“ä½œï¼");
        updateStatsUI();
        return;
    }

    if (type === 'sleep') {
        if (confirm("å‡†å¤‡ä¼‘æ¯äº†å—ï¼Ÿ")) {
            if (gameState.mystery.active) {
                // æœ‰è°œå›¢ï¼Œè¿›å…¥ç¡å‰æ¨ç†ç¯èŠ‚
                handleScene('generate_night_quiz');
            } else {
                performSleepStatsUpdate();
                handleScene('wake_up'); 
            }
        }
    }
    else if (type === 'computer') {
        // === æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ï¼šçœ‹ç”µè„‘ ===
        if (!gameState.mystery.active) {
            // æ²¡æœ‰è°œå›¢ -> æ¥ä»»åŠ¡ -> å¼€å¯æ–°çš„è°œå›¢ -> å¯èƒ½ä¼šè¿›å…¥è‡ªç”±æ¨¡å¼
            handleScene('check_email', 'æŸ¥çœ‹ç”µè„‘ä¸Šçš„å§”æ‰˜é‚®ä»¶ã€‚å¦‚æœæœ‰æ–°å§”æ‰˜ï¼Œè¯·æè¿°è¯¦æƒ…ï¼Œå¹¶è®©ç©å®¶å¤„äºã€è‡ªç”±æ¢ç´¢æ¨¡å¼ã€‘(choicesä¸ºç©º)ï¼Œç›´åˆ°ç©å®¶å‰å¾€ç›¸å…³åœ°ç‚¹ã€‚');
        } else {
            // æœ‰è°œå›¢ -> æŸ¥èµ„æ–™ -> å¯èƒ½ä¼šç»™çº¿ç´¢ -> ä¿æŒè‡ªç”±æ¨¡å¼
            handleScene('check_email', 'æŸ¥è¯¢å…³äºå½“å‰è°œå›¢çš„èµ„æ–™ã€‚å¦‚æœæŸ¥åˆ°äº†çº¿ç´¢ï¼Œè¯·å‘Šè¯‰ç©å®¶ï¼Œå¹¶ä¿æŒã€è‡ªç”±æ¢ç´¢æ¨¡å¼ã€‘è®©ç©å®¶ç»§ç»­å»å®åœ°è°ƒæŸ¥ã€‚');
        }
    }
}

// --- 4.5 å•†åº—ç³»ç»Ÿé€»è¾‘ (æ–°å¢) ---

// ä¸´æ—¶å­˜å‚¨å½“å‰å•†åº—çš„å•†å“ï¼Œç¦»å¼€åœ°ç‚¹åæ¸…ç©º
let currentShopItems = [];

async function openShop() {
    document.getElementById('shop-layer').style.display = 'flex';
    document.getElementById('shop-player-money').innerText = gameState.money;
    
    const shopTitle = gameState.currentLocation + " / äº¤æ˜“";
    document.getElementById('shop-title').innerText = `/// ${shopTitle} ///`;

    // å¦‚æœå½“å‰åœ°ç‚¹å·²ç»æœ‰ç¼“å­˜çš„å•†å“ï¼Œç›´æ¥æ˜¾ç¤ºï¼Œä¸å†è¯·æ±‚AIï¼ˆçœæµé‡ä¸”é˜²æ­¢åˆ·å•†å“ï¼‰
    if (currentShopItems.length > 0) {
        renderShopItems();
        return;
    }

    // å¦åˆ™ï¼Œè¯·æ±‚AIè¿›è´§
    document.getElementById('shop-list').innerHTML = '';
    document.getElementById('shop-loading').style.display = 'block';

    const prompt = `
    ç©å®¶è¿›å…¥äº†ã€${gameState.currentLocation}ã€‘çš„å•†åº—ã€‚
    è¯·ç”Ÿæˆ 4-6 ä¸ªç¬¦åˆè¯¥åœ°ç‚¹æ°›å›´çš„å¾…å”®å•†å“ã€‚
    
    åœ°ç‚¹æ°›å›´å‚è€ƒï¼š
    - ä¾¿åˆ©åº—/è¶…å¸‚ï¼šæ­£å¸¸é£Ÿç‰©ã€æ°´ã€ç”Ÿæ´»ç”¨å“ï¼Œå¶å°”æœ‰æ‰“æŠ˜çš„å¿«è¿‡æœŸé£Ÿå“ã€‚
    - é»‘å¸‚/æš—å··ï¼šè¿ç¦å“ã€æƒ…æŠ¥ã€å¥‡æ€ªçš„æŠ¤èº«ç¬¦ã€æ­¦å™¨ã€‚
    - è¯åº—/è¯Šæ‰€ï¼šè¯å“ã€ç»·å¸¦ã€é•‡é™å‰‚ã€‚
    
    è¯·è¿”å›JSONæ ¼å¼ï¼ŒåŒ…å« items æ•°ç»„ã€‚æ¯ä¸ª item åŒ…å«ï¼š
    - name: å•†å“å
    - cost: ä»·æ ¼ (æ•°å­—ï¼Œæ™®é€šç‰©å“10-100ï¼Œè´µé‡ç‰©å“100-1000)
    - desc: å•†å“æè¿° (æœ‰è¶£ä¸€ç‚¹)
    - type: "consumable" (æ¶ˆè€—å“) æˆ– "misc" (æ‚ç‰©) æˆ– "key" (å…³é”®é“å…·)
    - effect: (é€‰å¡«) ç±»ä¼¼ "hp+10", "san+5", "san-5" ç­‰
    
    ç¤ºä¾‹ï¼š
    {
        "items": [
            {"name": "ä¸´æœŸé¥­å›¢", "cost": 15, "desc": "è™½ç„¶ç±³é¥­æœ‰ç‚¹å‘ç¡¬ï¼Œä½†èƒ½å¡«é¥±è‚šå­ã€‚", "type": "consumable", "effect": "hp+5"},
            {"name": "å¼ºåŠ›æ‰‹ç”µ", "cost": 150, "desc": "å…‰æŸå¾ˆå¼ºï¼Œèƒ½ç…§äº®é»‘æš—è§’è½ã€‚", "type": "key"}
        ]
    }
    `;

    const result = await callAI(prompt, true);

    document.getElementById('shop-loading').style.display = 'none';

    if (result && result.items) {
        currentShopItems = result.items;
        renderShopItems();
    } else {
        document.getElementById('shop-list').innerHTML = '<div style="text-align:center; color:var(--dim)">[ è¿™é‡Œçš„è´§æ¶æ˜¯ç©ºçš„... ]</div>';
    }
}

function renderShopItems() {
    const list = document.getElementById('shop-list');
    list.innerHTML = '';

    currentShopItems.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'shop-card';
        
        // æ£€æŸ¥é’±å¤Ÿä¸å¤Ÿ
        const canAfford = gameState.money >= item.cost;
        
        card.innerHTML = `
            <div class="shop-item-header">
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-price">Â¥${item.cost}</div>
            </div>
            <div class="shop-item-desc">${item.desc}</div>
            <button class="shop-buy-btn" ${canAfford ? '' : 'disabled'} onclick="buyItem(${index})">
                ${canAfford ? 'è´­ ä¹°' : 'ä½™é¢ä¸è¶³'}
            </button>
        `;
        list.appendChild(card);
    });
}

function buyItem(index) {
    const item = currentShopItems[index];
    if (gameState.money < item.cost) {
        showPixelMsg("âŒ ä½ çš„é’±ä¸å¤Ÿï¼<br><span style='font-size:0.9rem; color:#aaa'>è€æ¿ç”¨çœ‹ç©·é¬¼çš„çœ¼ç¥çœ‹ç€ä½ ã€‚</span>");
        return;
    }

    // æ‰£é’±
    gameState.money -= item.cost;
    document.getElementById('shop-player-money').innerText = gameState.money; // æ›´æ–°å•†åº—é¡µé¢çš„é’±
    updateStatsUI(); // æ›´æ–°ä¸»ç•Œé¢çš„é’±

    // è¿›è´§åˆ°èƒŒåŒ…
    // æ·±æ‹·è´ä¸€ä»½ç‰©å“ï¼Œé˜²æ­¢ä¿®æ”¹åŸæ•°æ®
    const boughtItem = JSON.parse(JSON.stringify(item));
    
    // è‡ªåŠ¨è¡¥å…¨å¿…è¦å­—æ®µï¼Œé˜²æ­¢æŠ¥é”™
    if (!boughtItem.id) boughtItem.id = 'bought_' + Date.now();
    if (!boughtItem.count) boughtItem.count = 1;

    // æ£€æŸ¥èƒŒåŒ…å †å 
    const existing = gameState.inventory.find(i => i.name === boughtItem.name && i.type === boughtItem.type);
    if (existing && existing.type === 'consumable') {
        existing.count++;
    } else {
        gameState.inventory.push(boughtItem);
    }

    showPixelMsg(`âœ… è´­ä¹°æˆåŠŸï¼<br><span style="color:var(--accent-glitch)">${item.name}</span> å·²æ”¾å…¥èƒŒåŒ…ã€‚`);
    
    // åˆ·æ–°å•†åº—æŒ‰é’®çŠ¶æ€ï¼ˆå¯èƒ½ä¹°å®Œè¿™ä¸ªå°±ä¹°ä¸èµ·ä¸‹ä¸€ä¸ªäº†ï¼‰
    renderShopItems();
}



// --- 5. ç‰©å“æ é€»è¾‘ ---

function showInventory() {
    const list = document.getElementById('inventory-list');
    const msg = document.getElementById('empty-bag-msg');
    list.innerHTML = '';
    
    if (gameState.inventory.length === 0) {
        msg.style.display = 'block';
    } else {
        msg.style.display = 'none';
        const isInsane = gameState.stats.san < 30;

        gameState.inventory.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = `item-card ${isInsane ? 'insane-item' : ''} ${item.type === 'key' ? 'key-item' : ''}`;
            
            const displayName = isInsane && item.desc_insane ? "???" : item.name;
            const displayDesc = isInsane && item.desc_insane ? item.desc_insane : item.desc;

            let actionHtml = '';
            if (item.type === 'consumable') {
                actionHtml = `<button class="pixel-btn" style="font-size:0.8rem; padding:5px;" onclick="useItem(${index})">ä½¿ç”¨</button>`;
            } else {
                actionHtml = `<span style="font-size:0.8rem; color:var(--dim)">[å…³é”®]</span>`;
            }

            card.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${displayName} <span class="item-count">x${item.count}</span></div>
                    <div class="item-desc">${displayDesc}</div>
                </div>
                <div class="item-actions">${actionHtml}</div>
            `;
            list.appendChild(card);
        });
    }
    document.getElementById('inventory-layer').style.display = 'flex';
}

function useItem(index) {
    const item = gameState.inventory[index];
    if (!item) return;

    let msg = "";

    if (item.effect) {
        if (item.effect.includes("hp+")) {
            const val = parseInt(item.effect.split('+')[1]);
            gameState.stats.hp = Math.min(gameState.stats.maxHp, gameState.stats.hp + val);
            msg = `ä½¿ç”¨äº† <span style="color:var(--accent-glitch)">${item.name}</span><br>ç”Ÿå‘½å€¼æ¢å¤äº† <span style="color:#0f0; font-size:1.4rem;">+${val}</span>`;
        }
        else if (item.effect.includes("san+")) {
            const val = parseInt(item.effect.split('+')[1]);
            gameState.stats.san = Math.min(gameState.stats.maxSan, gameState.stats.san + val);
            msg = `ä½¿ç”¨äº† <span style="color:var(--accent-glitch)">${item.name}</span><br>ç†æ™ºå€¼æ¢å¤äº† <span style="color:var(--accent-glitch); font-size:1.4rem;">+${val}</span>`;
        } else {
             msg = `ä½¿ç”¨äº† ${item.name}ã€‚<br><span style="color:#aaa; font-size:0.9rem">(ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆæ˜æ˜¾æ•ˆæœ)</span>`;
        }
    } else {
        msg = `ä½¿ç”¨äº† ${item.name}ã€‚<br><span style="color:#aaa; font-size:0.9rem">(å®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ç‰©å“)</span>`;
    }

    // çœŸæ­£çš„é€»è¾‘ä¿®æ”¹ï¼šä¸å†å¼¹ alertï¼Œè€Œæ˜¯å¼¹æˆ‘ä»¬çš„ç¾åŒ–çª—
    showPixelMsg(msg);

    item.count--;
    if (item.count <= 0) {
        gameState.inventory.splice(index, 1);
    }
    updateStatsUI();
    showInventory();
}

// --- 5.5 æ‰‹æœºé€»è¾‘ (ç¾åŒ–å¢å¼ºç‰ˆ) ---

function showPhone() {
    document.getElementById('phone-layer').style.display = 'flex';
    closePhoneApp(); // é»˜è®¤æ˜¾ç¤ºä¸»å±å¹•
    
    // æ›´æ–°çŠ¶æ€æ 
    document.getElementById('phone-time').innerText = `${TIME_PHASES[gameState.timePhase]}`;
    document.getElementById('phone-carrier').innerText = gameState.currentLocation === "404å·äº‹åŠ¡æ‰€" ? "WIFI: 404_GUEST" : "5G";
}

function closePhoneApp() {
    const homeGrid = document.getElementById('phone-home');
    
    // === ä¿®å¤ç‚¹ï¼šæ˜¾å¼åœ°æŠŠ display æ”¹å› gridï¼Œå¦åˆ™å®ƒä¼šä¸€ç›´ä¿æŒ none (ä¸æ˜¾ç¤º) ===
    homeGrid.style.display = 'grid'; 
    
    // ç¨å¾®å»¶è¿Ÿ 10ms å†ç§»é™¤é€æ˜åº¦éšè—ç±»ï¼Œè¿™æ ·èƒ½è®©æ·¡å…¥åŠ¨ç”»ç”Ÿæ•ˆï¼Œçœ‹èµ·æ¥æ›´ä¸æ»‘
    setTimeout(() => {
        homeGrid.classList.remove('hidden');
    }, 10);

    document.getElementById('phone-display-area').style.display = 'none';
}

async function handlePhoneAction(app) {
    const homeGrid = document.getElementById('phone-home');
    const displayArea = document.getElementById('phone-display-area');
    const contentDiv = document.getElementById('phone-content');
    const titleEl = document.getElementById('current-app-title');

    // åˆ‡æ¢è§†å›¾åŠ¨ç”»
    homeGrid.classList.add('hidden');
    setTimeout(() => {
        homeGrid.style.display = 'none';
        displayArea.style.display = 'flex';
    }, 300);

    contentDiv.innerHTML = `<div class="loading-text" style="margin-top:50px;">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>`;
    
    let prompt = "";
    let appName = "";

    // å®šä¹‰ Prompt å’Œ æ ‡é¢˜
    if (app === 'takeout') {
        appName = "é¥±äº†ä¹ˆå¤–å–";
        if (gameState.money < 50) {
            contentDiv.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--accent-red);">âš ï¸ ä½™é¢ä¸è¶³ (éœ€è¦ Â¥50)</div>`;
            return;
        }
        gameState.money -= 50;
        gameState.stats.hp = Math.min(gameState.stats.maxHp, gameState.stats.hp + 10);
        updateStatsUI();
        
        // === ä¼˜åŒ–ç‚¹ï¼šä¸¥å‰ç¦æ­¢æ—ç™½ï¼Œç¡®ä¿å°ç¥¨æ ¼å¼æ•´æ´ ===
        prompt = `ç©å®¶ç‚¹äº†ä¸€ä»½å¤–å–ï¼ˆèŠ±è´¹50å…ƒï¼‰ã€‚è¯·ç”Ÿæˆä¸€ä»½ã€å¤–å–å°ç¥¨å†…å®¹ã€‘ã€‚
        ä¸¥ç¦è¾“å‡ºä»»ä½•ç¯å¢ƒæå†™ã€å‰§æƒ…æ—ç™½ï¼æˆ‘åªè¦å°ç¥¨ä¸Šçš„æ–‡å­—ï¼
        æ ¼å¼è¦æ±‚ï¼š
        ç¬¬ä¸€è¡Œï¼šèœå
        ç¬¬äºŒè¡Œï¼šç®€çŸ­çš„å£æ„Ÿæè¿°ï¼ˆå¥½åƒæˆ–éš¾åƒï¼‰
        ç¬¬ä¸‰è¡Œï¼šåº—é“ºå`;
    } 
    else if (app === 'news') {
        appName = "é›¾å·æ—©æŠ¥";
        prompt = `ç”Ÿæˆä¸€æ¡å…³äºé›¾å·å¸‚çš„ã€æ–°é—»æŠ¥é“ã€‘ã€‚
        æ ¼å¼è¦æ±‚ï¼šç¬¬ä¸€è¡Œæ˜¯æ–°é—»æ ‡é¢˜ï¼ˆéœ‡æƒŠä½“æˆ–ä¸¥è‚ƒä½“ï¼‰ï¼Œå‰©ä½™éƒ¨åˆ†æ˜¯æ­£æ–‡ã€‚å†…å®¹è¦åŒ…å«ä¸€äº›éƒ½å¸‚æ€ªè°ˆæˆ–æ”¿åºœæ©ç›–çœŸç›¸çš„æš—ç¤ºã€‚`;
    }
    else if (app === 'sns') {
        appName = "æ ‘æ´ç¤¾åŒº";
        prompt = `ç”Ÿæˆ3æ¡åŒ¿åçš„ç¤¾äº¤ç½‘ç»œåŠ¨æ€ã€‚
        æ ¼å¼è¦æ±‚ï¼šæ¯æ¡åŠ¨æ€ä¹‹é—´ç”¨ "|||" åˆ†éš”ã€‚å†…å®¹åæ˜ å¸‚æ°‘çš„ç„¦è™‘ã€ç›®å‡»æ€ªç‰©çš„ä¼ é—»æˆ–æ— æ„ä¹‰çš„ç–¯ç‹‚å‘“è¯­ã€‚`;
    }
    else if (app === 'msg') {
        appName = "æœªè¯»çŸ­ä¿¡";
        // === ä¿®æ”¹ç‚¹1ï¼šåŠ å¼º Promptï¼Œç¦æ­¢æ—ç™½ ===
        prompt = `ç”Ÿæˆ2-3æ¡çŸ­ä¿¡ã€‚
        ä¸¥ç¦è¾“å‡ºä»»ä½•ç¯å¢ƒæå†™æˆ–æ—ç™½ï¼ç›´æ¥è¾“å‡ºæ•°æ®ï¼
        æ ¼å¼è¦æ±‚ï¼šæ¯æ¡çŸ­ä¿¡ä¹‹é—´ç”¨ "|||" åˆ†éš”ã€‚
        æ¯æ¡çŸ­ä¿¡ä¸¥æ ¼æ ¼å¼ï¼š[å‘é€è€…åå­—]ï¼š[çŸ­ä¿¡å†…å®¹]ã€‚
        å†…å®¹å¯ä»¥æ˜¯åƒåœ¾å¹¿å‘Šã€ç¥ç§˜äººçš„è­¦å‘Šã€æˆ–è€…å‚¬å€ºä¿¡æ¯ã€‚å…¶ä¸­ä¸€æ¡å¿…é¡»çœ‹èµ·æ¥å¾ˆå±é™©æˆ–ä¹±ç ã€‚`;
    }

    titleEl.innerText = appName;

    // è°ƒç”¨ AI
    const result = await callAI(prompt, true); 
    
    if (result) {
        const text = result.description;
        let html = "";

        // === æ ¹æ®ä¸åŒAPPæ¸²æŸ“ä¸åŒæ¨¡æ¿ ===
        
        // 1. å¤–å–æ¸²æŸ“ (å°ç¥¨é£æ ¼)
        if (app === 'takeout') {
            const lines = text.split('\n').filter(l => l.trim());
            const dish = lines[0] || "æœªçŸ¥è‚‰";
            const desc = lines[1] || "å‘³é“åƒåš¼è¿‡çš„æ§Ÿæ¦”ã€‚";
            const shop = lines[2] || "é»‘å··å­ç¬¬4å·æ‘Šä½";
            
            html = `
                <div class="receipt-card">
                    <div class="receipt-header">=== è®¢å• #89757 ===</div>
                    <div class="receipt-item"><span>${dish}</span><span>x1</span></div>
                    <div class="receipt-item" style="color:#555; font-size:0.8rem;">${desc}</div>
                    <div style="border-bottom:1px dashed #000; margin:10px 0;"></div>
                    <div class="receipt-item"><span>é…é€è´¹</span><span>Â¥5.00</span></div>
                    <div class="receipt-item"><span>æ‰“åŒ…è´¹</span><span>Â¥2.00</span></div>
                    <div class="receipt-total">å®ä»˜: Â¥50.00</div>
                    <div class="receipt-footer">
                        åº—é“º: ${shop}<br>
                        æ„Ÿè°¢æ‚¨çš„æƒ é¡¾<br>
                        <span style="font-size:0.6rem">é£Ÿç‰©ä¸­æ¯’æ¦‚ä¸è´Ÿè´£</span>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px; color:var(--accent-glitch);">
                    [ HP +10 ] [ é¥±è…¹æ„Ÿå·²æ¢å¤ ]
                </div>
            `;
        }
        
        // 2. æ–°é—»æ¸²æŸ“ (æŠ¥çº¸é£æ ¼)
        else if (app === 'news') {
            const lines = text.split('\n');
            const headline = lines[0];
            const body = lines.slice(1).join('<br>');
            
            html = `
                <div class="news-card">
                    <div class="news-headline">${headline}</div>
                    <div class="news-body">${body}</div>
                    <div style="text-align:right; margin-top:10px; font-size:0.8rem; color:var(--dim);">
                        â€”â€” é›¾å·æ—¥æŠ¥ç¤¾ ç¼–è¾‘éƒ¨
                    </div>
                </div>
            `;
        }

        // 3. æ ‘æ´æ¸²æŸ“ (å¸–å­é£æ ¼)
        else if (app === 'sns') {
            // === æ–°å¢ï¼šæ—ç™½æ°›å›´å±‚ (è¿˜åŸä½ çš„è®¾å®š) ===
            // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€æ®µæ–œä½“å­—ä½œä¸ºå¼€åœºï¼Œæ¨¡æ‹Ÿç©å®¶ç›¯ç€å±å¹•çš„å¿ƒç†æ´»åŠ¨
            html += `
                <div style="
                    padding: 5px 5px 20px 5px; 
                    border-bottom: 1px dashed var(--dim); 
                    margin-bottom: 20px; 
                    color: #ccc; 
                    font-family: var(--font-read); 
                    font-size: 1.15rem; 
                    line-height: 1.8; 
                    text-shadow: 0 0 5px rgba(0,0,0,0.8);
                ">
                    ä½ ç†Ÿç»ƒåœ°æ‰“å¼€äº†ç”µè„‘ï¼Œåœ¨å¤„ç†é‚£å°ç¥ç§˜é‚®ä»¶ä¹‹å‰ï¼Œä½ ä¸è‡ªè§‰åœ°ç‚¹å¼€äº†æœ¬åœ°ç¤¾äº¤è®ºå›<span style="color:var(--accent-glitch)">ã€é›¾è¯­ã€</span>çš„åŒ¿åæ¿å—ã€‚å±å¹•çš„å…‰æ˜ åœ¨ä½ ç–²æƒ«çš„è„¸ä¸Šï¼Œå‡ æ¡åˆšåˆ·å‡ºçš„åŠ¨æ€å¼•èµ·äº†ä½ çš„æ³¨æ„ï¼š
                </div>
            `;

            const posts = text.split('|||');
            posts.forEach(post => {
                if(!post.trim()) return;
                const userNames = ["åŒ¿åç”¨æˆ·893", "ç»æœ›çš„æ‰“å·¥äºº", "çœ‹è§äº†çœ¼ç›", "å¸‚æ°‘K", "çŒ«å¥´", "404_GUEST"];
                const randomUser = userNames[Math.floor(Math.random() * userNames.length)];
                const likes = Math.floor(Math.random() * 100);
                
                html += `
                    <div class="sns-post">
                        <div class="sns-user">@${randomUser}</div>
                        <div class="sns-content">${post.trim()}</div>
                        <div class="sns-actions">
                            <span>â¤ï¸ ${likes}</span>
                            <span>ğŸ’¬ ${Math.floor(likes/3)}</span>
                            <span>ğŸ”— åˆ†äº«</span>
                        </div>
                    </div>
                `;
            });
        }

        // 4. çŸ­ä¿¡æ¸²æŸ“ (æ°”æ³¡é£æ ¼ - ä¿®å¤ç‰ˆ)
        else if (app === 'msg') {
            // å…¼å®¹å¤„ç†ï¼šå¦‚æœAIæ²¡ç”¨|||åˆ†å‰²ï¼Œè€Œæ˜¯ç”¨äº†æ¢è¡Œ
            let rawMsgs = text.split('|||');
            if (rawMsgs.length === 1 && text.includes('\n')) {
                rawMsgs = text.split('\n');
            }

            html = `<div class="sms-container">`;
            
            rawMsgs.forEach(msg => {
                msg = msg.trim();
                if(!msg) return;

                // === ä¿®æ”¹ç‚¹2ï¼šæ­£åˆ™è¿‡æ»¤ ===
                // åªæœ‰ç¬¦åˆ [åå­—]:å†…å®¹ æ ¼å¼çš„è¡Œæ‰ä¼šè¢«æ¸²æŸ“
                // è¿™æ ·å°±èƒ½æŠŠ "ä½ çš„æ‰‹æœºå“äº†..." è¿™ç§æ—ç™½è¿‡æ»¤æ‰
                const match = msg.match(/^\[(.*?)\]\s*[:ï¼š]\s*(.*)$/);

                if (match) {
                    const sender = match[1].trim();
                    const body = match[2].trim();
                    
                    // åˆ¤æ–­æ˜¯å¦æ˜¯å±é™©ä¿¡æ¯
                    const isUrgent = sender.includes("è­¦å‘Š") || sender.includes("æœªçŸ¥") || body.includes("æ­»") || body.includes("è·‘") || body.includes("ğŸ‘ï¸");
                    
                    html += `
                        <div class="sms-card ${isUrgent ? 'urgent' : ''}">
                            <div class="sms-sender">
                                <span>${sender}</span>
                                <span class="sms-time">åˆšåˆš</span>
                            </div>
                            <div class="sms-body">${body}</div>
                        </div>
                    `;
                }
                // å¦‚æœä¸åŒ¹é…æ­£åˆ™ï¼ˆæ¯”å¦‚æ˜¯æ—ç™½ï¼‰ï¼Œç›´æ¥ä¸¢å¼ƒï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            });
            html += `</div>`;
        }

        contentDiv.innerHTML = html;
    } else {
        contentDiv.innerHTML = `<div style="text-align:center; color:var(--dim);">[ è¿æ¥è¶…æ—¶ ]</div>`;
    }
}


// --- 6. åœ°å›¾é€»è¾‘ (æ ‘çŠ¶å›¾å‡çº§ç‰ˆ) ---	

function showMap() {
    // 1. æ£€æŸ¥é”å®šçŠ¶æ€
    if (checkInputLock()) return;

    // 2. === æ ¸å¿ƒä¿®æ”¹ï¼šå±é™©åœ°åŒºç¦æ­¢æ‰“å¼€åœ°å›¾ ===
    // æ‰¾åˆ°å½“å‰åœ°ç‚¹çš„é…ç½®
    const currentLocData = gameState.unlockedLocations.find(l => l.name === gameState.currentLocation);
    
    // å¦‚æœæ˜¯å±é™©åŒºåŸŸ (type === 'danger') æˆ–è€…æ˜¯æ·±å¤œ (timePhase === 3) ä¸”ä¸åœ¨å®¶
    const isNight = gameState.timePhase === 3;
    const isDanger = currentLocData && currentLocData.type === 'danger';
    const isAtHome = gameState.currentLocation === '404å·äº‹åŠ¡æ‰€';

    if ((isDanger || (isNight && !isAtHome)) && !isAtHome) {
        showPixelMsg(`
            âš ï¸ <span style="color:var(--accent-red)">å±é™©é”å®š</span><br>
            <div style="font-size:0.9rem; margin-top:10px; color:#ccc; text-align:left;">
            ä½ æ„Ÿè§‰å‘¨å›´æœ‰è§†çº¿åœ¨æ³¨è§†ç€ä½ ï¼Œæ— æ³•å†·é™åœ°æŸ¥çœ‹åœ°å›¾ã€‚<br>
            <br>
            å¿…é¡»å…ˆé€šè¿‡<span style="color:var(--accent-gold)">[è‡ªç”±è¡ŒåŠ¨]</span>è¾“å…¥â€œé€ƒè·‘â€ã€â€œæ’¤é€€â€æˆ–å‡»è´¥å¨èƒï¼Œç¡®è®¤ç¯å¢ƒå®‰å…¨åæ‰èƒ½ç§»åŠ¨ã€‚
            </div>
        `);
        return;
    }

    // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„åœ°å›¾æ˜¾ç¤ºé€»è¾‘ ---
    const container = document.getElementById('map-grid');
    container.className = 'map-container'; 
    container.innerHTML = '';
    
    const allLocs = gameState.unlockedLocations;
    
    function renderNode(loc, containerEl) {
        const nodeEl = document.createElement('div');
        const isCurrent = loc.name === gameState.currentLocation;
        nodeEl.className = `map-node ${isCurrent ? 'current' : ''} ${loc.locked ? 'locked' : ''}`;
        
        let tagHtml = '';
        if (loc.type === 'shop') tagHtml = `<span class="map-tag tag-shop">å•†åº—</span>`;
        if (loc.type === 'heal') tagHtml = `<span class="map-tag tag-safe">æ²»ç–—</span>`;
        if (loc.type === 'danger') tagHtml = `<span class="map-tag tag-danger">å±é™©</span>`;

        nodeEl.innerHTML = `<span>${loc.name}</span> ${tagHtml}`;
        
        if (!isCurrent && !loc.locked) {
            nodeEl.onclick = (e) => {
                e.stopPropagation(); 
                hideOverlay('map-layer');
                handleScene('move', loc.name);
            };
        }
        
        containerEl.appendChild(nodeEl);
        const children = allLocs.filter(l => l.parent === loc.name);
        if (children.length > 0) {
            const branchEl = document.createElement('div');
            branchEl.className = 'map-branch';
            children.forEach(child => renderNode(child, branchEl));
            containerEl.appendChild(branchEl);
        }
    }

    const rootLocs = allLocs.filter(l => !l.parent || !allLocs.find(p => p.name === l.parent));
    
    if (rootLocs.length === 0 && allLocs.length > 0) {
        allLocs.forEach(l => renderNode(l, container));
    } else {
        rootLocs.forEach(root => {
            const rootWrapper = document.createElement('div');
            rootWrapper.className = 'map-root';
            renderNode(root, rootWrapper);
            container.appendChild(rootWrapper);
        });
    }

    document.getElementById('current-location-name').innerText = gameState.currentLocation;
    document.getElementById('map-layer').style.display = 'flex';
}

// --- 7. AI æ¥å£ ---

async function callAI(userPrompt, isSystem = false) {
    // 1. æ„å»ºè®°å¿†æ–‡æœ¬
    const activeQuests = gameState.quests.filter(q => q.active).map(q => q.text).join("; ");
    const knownClues = gameState.clues.join("; ");
    
    const inventoryItems = gameState.inventory.length > 0 
        ? gameState.inventory.map(i => i.name).join("ã€") 
        : "ç©ºæ— ä¸€ç‰©";

    // æ„å»ºè°œå›¢ä¿¡æ¯
    let mysteryContext = "";
    if (gameState.mystery.active) {
        mysteryContext = `
        [â˜… å½“å‰æ ¸å¿ƒè°œå›¢ (æ­£åœ¨è¿›è¡Œä¸­)]
        è°œé¢: ${gameState.mystery.title}
        çœŸç›¸(ç©å®¶æœªçŸ¥): ${gameState.mystery.truth}
        æˆªæ­¢: Day ${gameState.mystery.deadlineDay} (ä»Š: Day ${gameState.day})
        *æŒ‡ä»¤*: æ‰€æœ‰å‰§æƒ…å¿…é¡»æš—ç¤ºæ­¤çœŸç›¸ã€‚ä¸è¦ç›´æ¥æ­éœ²ï¼Œè¦é€šè¿‡çº¿ç´¢å¼•å¯¼ã€‚
        `;
    } else {
        mysteryContext = `
        [â˜… å½“å‰æ— æ ¸å¿ƒè°œå›¢]
        *æŒ‡ä»¤*: ç©å®¶ç›®å‰å¤„äºç©ºçª—æœŸã€‚å¦‚æœç©å®¶æ­£åœ¨ã€æŸ¥çœ‹ç”µè„‘/æ‰‹æœºã€‘ã€ã€é˜…è¯»æŠ¥çº¸ã€‘ã€ã€æ¢ç´¢æ–°åœ°ç‚¹ã€‘æˆ–ã€ä¸å…³é”®NPCå¯¹è¯ã€‘ï¼Œä½ å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ mystery_setup æ¥å¼€å¯æ–°æ¡ˆä»¶ã€‚
        `;
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå»æ‰äº†å®¹æ˜“å¯¼è‡´ä»£ç æŠ¥é”™çš„ç‰¹æ®Šç¬¦å· â˜…â˜…â˜…
    const systemPrompt = `
    ä½ æ˜¯ä¸€ä¸ªåä¸ºâ€œé›¾å·å¼‚é—»å½•â€çš„æ–‡å­—å†’é™©æ¸¸æˆKPï¼ˆå®ˆå¯†äººï¼‰ã€‚
    
    ã€â˜… é‡è¦æŒ‡ä»¤ï¼šæ€ç»´é“¾è‡ªæ£€ / COT Protocol â˜…ã€‘
    åœ¨è¾“å‡º JSON ä¹‹å‰ï¼Œå¿…é¡»å…ˆåœ¨æœ€å‰é¢è¾“å‡ºä¸€æ®µæ€è€ƒè¿‡ç¨‹ï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    [â˜…â˜…â˜… æ€ç»´é“¾è‡ªæ£€ / COT Protocol â˜…â˜…â˜…] 
    1ã€å½“å‰æ˜¯ä»€ä¹ˆåœºæ™¯ï¼Ÿç©å®¶æ‰§è¡Œäº†ä»€ä¹ˆè¡ŒåŠ¨ï¼Ÿ
    2ã€ç©å®¶çš„è¡Œä¸ºæ˜¯å¦åº”è¯¥è§¦å‘ç‰©å“æ‰è½ï¼Ÿè§£é”æ–°åœ°ç‚¹ï¼Ÿ
    3ã€æ˜¯å¦ç¼“æ…¢æ¨è¿›å‰§æƒ…ï¼ˆæ ¹æ®è°œå›¢å’Œçº¿ç´¢ï¼‰ï¼Œå…·æœ‰ç”Ÿæ´»æ„Ÿï¼Œè€Œä¸æ˜¯å¿«èŠ‚å¥ææ€–ï¼Ÿ
    4ã€é€»è¾‘æ£€æŸ¥ï¼šç©å®¶æ˜¯å¦åœ¨åšä¸å¯èƒ½çš„äº‹ï¼ˆå¦‚æ²¡é’±ä¹°ä¸œè¥¿ã€åœ¨äº‹åŠ¡æ‰€å¤–ç”¨ç”µè„‘ï¼‰ï¼Ÿ
    --------------------------------------------------
    (æ€è€ƒç»“æŸåï¼Œå†è¾“å‡ºæ ‡å‡†çš„ JSON æ•°æ®)

    **æ ¸å¿ƒé£æ ¼ï¼šéƒ½å¸‚æ€ªè°ˆ (Urban Legend) + é»‘è‰²å¹½é»˜ + ç”Ÿæ´»æµ (Slice of Life) + è½»çµå¼‚**

    [å½“å‰çŠ¶æ€]
    ç©å®¶ï¼š${gameState.player.name} (${gameState.player.job})
    å±æ€§ï¼šPHY ${gameState.stats.phy}, DEX ${gameState.stats.dex}, INT ${gameState.stats.int}, CHA ${gameState.stats.cha}, MYS ${gameState.stats.mys}
    çŠ¶æ€ï¼šHP:${gameState.stats.hp}, SAN:${gameState.stats.san}, é‡‘é’±:${gameState.money}, å£°æœ›:${gameState.reputation}
    æ—¶é—´ï¼šDay ${gameState.day} - ${TIME_PHASES[gameState.timePhase]}
    åœ°ç‚¹ï¼š${gameState.currentLocation}
    
    [é‡è¦è®°å¿†ä¸ç‰©å“]
    ä»»åŠ¡ï¼š${activeQuests}
    çº¿ç´¢ï¼š${knownClues}
    ã€â˜… ç©å®¶èƒŒåŒ…ç‰©å“ã€‘ï¼š${inventoryItems}
    ${mysteryContext}
    
    [æ ¸å¿ƒè§„åˆ™]
    0. **â˜… æ•°å€¼æ“ä½œå¼ºåˆ¶åè®® (Stat Tag Protocol) â˜…**ï¼š
       - åªè¦å‰§æƒ…ä¸­ç©å®¶**èº«ä½“å—ä¼¤**ï¼ˆæ‘”å€’ã€è¢«æ‰“ã€ä¸­æ¯’ï¼‰ï¼Œ**å¿…é¡»**åœ¨æ–‡æœ¬ä¸­é™„å¸¦æ‰£è¡€æ ‡ç­¾ï¼Œä¾‹å¦‚ [HP-10] æˆ– (HP-5)ã€‚
       - åªè¦ç©å®¶**ç²¾ç¥å—åˆ›**ï¼ˆçœ‹åˆ°æ€ªç‰©ã€ææƒ§ï¼‰ï¼Œ**å¿…é¡»**é™„å¸¦ [SAN-5]ã€‚
       - å¦‚æœç©å®¶é€šè¿‡é”»ç‚¼ã€è¯»ä¹¦æˆ–ç‰¹æ®Šäº‹ä»¶è·å¾—äº†**èƒ½åŠ›æå‡**ï¼Œè¯·å¥–åŠ±å±æ€§ç‚¹ï¼ä¾‹å¦‚ [PHY+1] (ä½“é­„å¢å¼º)ã€[INT+1] (å­¦è¯†å¢åŠ )ã€‚
       - **ä¸¥ç¦**åªå†™å‰§æƒ…ä¸å†™æ ‡ç­¾ï¼æ²¡æœ‰æ ‡ç­¾ç³»ç»Ÿæ— æ³•æ‰£è¡€ï¼
    1. **ã€ä¸¥å‰çš„ç»æµæ§åˆ¶ã€‘(Economy Control)**ï¼š
       - æœ¬æ¸¸æˆæ˜¯**è´«ç©·æ¨¡æ‹Ÿå™¨**ï¼ç©å®¶éå¸¸ç©·ï¼
       - **ä¸¥ç¦éšæ„æ‰è½é‡‘é’±**ï¼é™¤éç©å®¶å®Œæˆäº†æ­£å¼å§”æ‰˜ã€åœ¨å•†åº—å–äº†ä¸œè¥¿ã€æˆ–è€…æœåˆ®äº†æ”¶é“¶æœºï¼Œå¦åˆ™ä¸è¦ç»™é’±ã€‚
       - å¦‚æœéè¦ç»™é’±ï¼Œå¿…é¡»é€šè¿‡ 'loot' æ•°ç»„è¿”å›ã€‚
    2. **ã€æ—¶é—´åŒæ­¥åè®®ã€‘(Time Sync)**ï¼š
       - å¦‚æœå‰§æƒ…ä¸­æ—¶é—´å‘ç”Ÿäº†æ˜¾è‘—å˜åŒ–ï¼ˆä¾‹å¦‚ï¼šç­‰åˆ°äº†æ™šä¸Šã€ç¡äº†ä¸€è§‰ã€æ˜è¿·é†’æ¥ï¼‰ï¼Œ**å¿…é¡»**è¿”å› "change_time" å­—æ®µï¼
       - æ•°å€¼å¯¹ç…§ï¼š0=ä¸Šåˆ, 1=ä¸‹åˆ, 2=é»„æ˜, 3=æ·±å¤œã€‚
       - ä¾‹å¦‚ï¼šå‰§æƒ…å†™â€œå¤©é»‘äº†â€ï¼ŒJSONé‡Œå¿…é¡»å¸¦ "change_time": 3ã€‚
    3. **è‡ªç”±æ¢ç´¢æ¨¡å¼**ï¼š
       - å¦‚æœéœ€è¦ç©å®¶å¯»æ‰¾çº¿ç´¢æˆ–ç§»åŠ¨ï¼Œè¿”å›ç©ºæ•°ç»„ choices: []ï¼Œè¿›å…¥è‡ªç”±æ¨¡å¼ã€‚
    4. **é€‰é¡¹ç”Ÿæˆè§„åˆ™**ï¼š
       - **æ•°é‡å›ºå®š**ï¼šéè‡ªç”±æ¨¡å¼ä¸‹å¿…é¡»ä¸¥æ ¼ç”Ÿæˆ 4 ä¸ªé€‰é¡¹ã€‚
       - **å¼ºåˆ¶æ£€å®š**ï¼šä»»ä½•å…·æœ‰ä¸ç¡®å®šæ€§ã€å±é™©æ€§ã€æˆ–éœ€è¦ä¸“ä¸šæŠ€èƒ½çš„è¡Œä¸ºï¼ˆå¦‚æ’¬é”ã€è¯´æœã€æ”»å‡»ã€å·çªƒï¼‰ï¼Œ**å¿…é¡»**è¿”å› "check" å­—æ®µè§¦å‘æ·éª°å­ï¼ä¸è¦ç›´æ¥ç»™å‡ºæˆåŠŸç»“æœï¼Œè®©è¿æ°”å†³å®šå‘½è¿ã€‚
    
    JSON ç»“æ„ç¤ºä¾‹ï¼ˆç›´æ¥ JSONï¼Œä¸è¦ä»£ç å—ï¼‰ï¼š
    {
        "description": "å‰§æƒ…æ–‡æœ¬... [HP-5]",
        "choices": [
            {"text": "é€‰é¡¹1", "action": "..."}, 
            {"text": "é€‰é¡¹2", "action": "...", "check": "PHY"}
        ],
        "event": "none" | "san_check",
        "loot": [ {"name": "é‡‘é’±(200)", "type": "misc", "desc": "é’±"} ], 
        "unlock_location": "åœ°ç‚¹å",
        "new_clue": "çº¿ç´¢å†…å®¹", 
        "update_quest": "ä»»åŠ¡å†…å®¹",
        "move_to": "æ–°åœ°ç‚¹",
        "mystery_setup": { "title": "è°œé¢˜å", "truth": "çœŸç›¸è®¾å®š", "days_limit": 3 },
        "mystery_result": { "success": true, "reason": "..." }
    }
    `;

    const messages = [
        { role: "system", content: systemPrompt },
        ...(isSystem ? [] : gameState.history.slice(-4)),
        { role: "user", content: userPrompt }
    ];

    try {
        const res = await fetch(`${config.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${config.apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: config.model,
                messages: messages
            })
        });
        
        const data = await res.json();
        const rawContent = data.choices[0].message.content;

        // åˆ†ç¦» æ€ç»´é“¾(CoT) å’Œ JSON
        const firstBrace = rawContent.indexOf('{');
        const lastBrace = rawContent.lastIndexOf('}');
        
        if (firstBrace === -1 || lastBrace === -1) {
            throw new Error("AI æœªè¿”å›æœ‰æ•ˆçš„ JSON æ•°æ®");
        }

        const jsonStr = rawContent.substring(firstBrace, lastBrace + 1);
        const cotText = rawContent.substring(0, firstBrace).trim();

        if (cotText) console.log("%c[AI æ€ç»´é“¾ CoT]", "color: cyan; font-weight: bold;", cotText);

        if (!isSystem) {
            gameState.history.push({ role: "assistant", content: jsonStr });
        }
        
        return JSON.parse(jsonStr);

    } catch (e) { 
        console.error("AI è§£æé”™è¯¯:", e);
        return null; 
    }
}


// --- è¾…åŠ©å‡½æ•° ---
function addToLog(text) {
    gameState.log.push(text);
    const logContent = document.getElementById('log-content');
    const entry = document.createElement('div');
    entry.style.marginBottom = "10px";
    entry.style.borderBottom = "1px dashed #333";
    entry.innerText = text;
    logContent.appendChild(entry);
}
function showLog() { document.getElementById('log-layer').style.display = 'flex'; }
function showStatus() { document.getElementById('status-layer').style.display = 'flex'; updateStatsUI(); }
function hideOverlay(id) { document.getElementById(id).style.display = 'none'; }

// æ–°å¢ï¼šæ˜¾ç¤ºæ•™ç¨‹
function showTutorial() { document.getElementById('tutorial-layer').style.display = 'flex'; }

// æ–°å¢ï¼šç¾åŒ–ç‰ˆå¼¹çª—æ§åˆ¶
function showPixelMsg(text) {
    document.getElementById('modal-text').innerHTML = text; // æ”¯æŒHTMLé¢œè‰²
    document.getElementById('pixel-modal').style.display = 'flex';
}
function closePixelMsg() {
    document.getElementById('pixel-modal').style.display = 'none';
}

// --- æ–°å¢ï¼šæ‰‹è®°é€»è¾‘ ---
function showNote() {
    const qList = document.getElementById('quest-list');
    const cList = document.getElementById('clue-list');
    
    // æ¸²æŸ“ä»»åŠ¡
    qList.innerHTML = '';
    
    // === æ–°å¢ï¼šæ ¸å¿ƒè°œå›¢ç½®é¡¶æ˜¾ç¤º ===
    if (gameState.mystery.active) {
        const daysLeft = gameState.mystery.deadlineDay - gameState.day;
        const mysteryDiv = document.createElement('div');
        mysteryDiv.style.cssText = "background: rgba(255,0,0,0.1); border: 1px solid var(--accent-red); padding: 10px; margin-bottom: 15px; color: var(--accent-red);";
        mysteryDiv.innerHTML = `
            <div style="font-weight:bold; margin-bottom:5px;">âš ï¸ æ ¸å¿ƒè°œå›¢: ${gameState.mystery.title}</div>
            <div style="font-size:0.9rem;">è·ç¦»å®¡åˆ¤æ—¥è¿˜å‰©: <span style="font-size:1.2rem; font-weight:bold;">${daysLeft}</span> å¤©</div>
            <div style="font-size:0.8rem; opacity:0.8;">(è¯·åœ¨ Day ${gameState.mystery.deadlineDay} ç¡å‰è§£å†³)</div>
        `;
        qList.appendChild(mysteryDiv);
    }

    const activeQuests = gameState.quests.filter(q => q.active && !q.id.startsWith('mystery_')); // è¿‡æ»¤æ‰è‡ªåŠ¨ç”Ÿæˆçš„mysteryä»»åŠ¡ï¼Œé¿å…é‡å¤
    if (activeQuests.length === 0 && !gameState.mystery.active) {
        qList.innerHTML = '<div style="color:var(--dim)">æš‚æ— æ˜ç¡®ç›®æ ‡ï¼Œè¯·è‡ªç”±æ¢ç´¢ã€‚</div>';
    } else {
        activeQuests.forEach(q => {
            const div = document.createElement('div');
            div.innerHTML = `â¤ ${q.text}`;
            div.style.marginBottom = "8px";
            qList.appendChild(div);
        });
    }

    // æ¸²æŸ“çº¿ç´¢
    if (gameState.clues.length > 0) {
        cList.innerHTML = '';
        gameState.clues.forEach(c => {
            const div = document.createElement('div');
            div.innerHTML = `â€¢ <span style="color:var(--fg)">${c}</span>`;
            div.style.marginBottom = "5px";
            div.style.borderBottom = "1px solid #222";
            cList.appendChild(div);
        });
    }
    
    document.getElementById('note-layer').style.display = 'flex';
}


</script>
</body>
</html>

